<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ë‚˜ê³ ì•¼ ì—¬í–‰ (2026.3.2 - 3.7)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Noto Sans KR', 'sans-serif'] },
                    colors: {
                        primary: '#0f172a',
                        secondary: '#334155',
                        accent: '#6366f1',
                    },
                    screens: { 'xs': '480px' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; height: 100vh; height: 100dvh; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .sidebar { z-index: 50; box-shadow: 4px 0 24px rgba(0,0,0,0.08); }
        .category-radio:checked + label { background-color: #f1f5f9; border-color: #6366f1; color: #4338ca; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1); font-weight: 700; }
        .transport-radio:checked + label { background-color: #e0e7ff; color: #4338ca; border-color: #6366f1; font-weight: bold; }
        .timeline-item::before { content: ''; position: absolute; top: 2rem; bottom: -1rem; left: 1.5rem; width: 2px; background: #e2e8f0; z-index: 0; }
        .group-last .timeline-item::before { display: none; }
        .toggle-checkbox:checked { right: 0; border-color: #6366f1; }
        .toggle-checkbox:checked + .toggle-label { background-color: #6366f1; }
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .weather-widget { transition: all 0.3s ease; }
        .weather-widget:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .tab-active { border-bottom: 2px solid #6366f1; color: #4338ca; font-weight: bold; }
        .tab-inactive { color: #94a3b8; }
        .fab-btn { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .fab-btn:hover { transform: scale(1.1); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .fab-btn:active { transform: scale(0.95); }
        /* Leaflet Popup Style Override */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        .leaflet-popup-content { margin: 0; width: 280px !important; }
        .leaflet-popup-tip { background: white; }
        /* Rating Slider Customization */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #fbbf24; cursor: pointer; margin-top: -8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px; }
        .carousel-btn { background: rgba(0,0,0,0.5); color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; transition: background 0.2s; }
        .carousel-btn:hover { background: rgba(0,0,0,0.8); }
    </style>
</head>
<body class="w-screen flex overflow-hidden text-slate-800 relative">

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar w-full md:w-[450px] h-full bg-white flex flex-col border-r border-slate-200 shrink-0 absolute md:relative transition-transform duration-300 transform -translate-x-full md:translate-x-0" id="sidebar">
        <!-- í—¤ë” -->
        <div class="px-6 py-4 bg-primary text-white flex justify-between items-center shadow-sm shrink-0">
            <div>
                <h1 class="text-xl font-bold tracking-tight"><i class="fa-solid fa-plane-departure mr-2 text-indigo-400"></i>Nagoya 2026</h1>
                <p class="text-[10px] text-slate-400 mt-1 font-light" id="exchangeRateDisplay">í™˜ìœ¨ ì •ë³´ ë¡œë”© ì¤‘...</p>
            </div>
            <button id="closeSidebarMobile" class="md:hidden text-slate-400 hover:text-white p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <!-- ë©”ì¸ íƒ­ -->
        <div class="flex border-b border-slate-200 shrink-0">
            <button onclick="switchMainTab('itinerary')" id="tab-itinerary" class="flex-1 py-3 text-sm text-center transition tab-active">
                <i class="fa-solid fa-calendar-check mr-1"></i>ìƒì„¸ ì¼ì •
            </button>
            <button onclick="switchMainTab('candidates')" id="tab-candidates" class="flex-1 py-3 text-sm text-center transition tab-inactive">
                <i class="fa-solid fa-map-location-dot mr-1"></i>ê°€ë³¼ë§Œí•œ ê³³
            </button>
        </div>

        <!-- Day íƒ­ -->
        <div class="flex overflow-x-auto px-4 py-3 bg-white border-b border-slate-100 space-x-2 scrollbar-hide shrink-0" id="dayTabs"></div>

        <!-- 1. ì¼ì • ë·° -->
        <div id="view-itinerary" class="flex flex-col flex-1 overflow-hidden">
            <!-- ë¹ ë¥¸ ì¶”ê°€ ë²„íŠ¼ (ê´€ë¦¬ììš©) -->
            <div id="quickControls" class="px-4 py-3 grid grid-cols-2 gap-3 bg-slate-50 border-b border-slate-100 hidden shrink-0">
                <button onclick="openAddScheduleModal(0,0, 'flight')" class="py-2.5 px-4 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-600 hover:border-indigo-300 hover:text-indigo-600 hover:shadow-sm transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-ticket text-indigo-500"></i> í•­ê³µê¶Œ ë“±ë¡
                </button>
                <button onclick="openAddScheduleModal(0,0, 'hotel')" class="py-2.5 px-4 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-600 hover:border-blue-300 hover:text-blue-600 hover:shadow-sm transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-bed text-blue-500"></i> ìˆ™ì†Œ ë“±ë¡
                </button>
            </div>

            <!-- ì¼ì • ë¦¬ìŠ¤íŠ¸ -->
            <div class="flex-1 overflow-y-auto p-5 space-y-4 bg-slate-50/50" id="itineraryList">
                <div class="flex flex-col items-center justify-center h-full text-slate-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mb-3"></div>
                    <p class="text-sm">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            </div>

            <!-- ì¼ë³„ ì´ ë¹„ìš© ìš”ì•½ -->
            <div id="dailySummary" class="px-5 py-4 bg-white border-t border-slate-200 shrink-0 shadow-[0_-4px_10px_rgba(0,0,0,0.02)] hidden">
                <div class="flex justify-between items-end">
                    <div>
                        <span class="text-sm font-bold text-slate-500">Day Total</span>
                        <p class="text-[10px] text-slate-400">* í•­ê³µ/ìˆ™ì†Œ ë¹„ìš© ì œì™¸ (ì´ë™ë¹„ í¬í•¨)</p>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold text-slate-800" id="dailyTotalJPY">Â¥0</div>
                        <div class="text-xs font-medium text-slate-400" id="dailyTotalKRW">â‰ˆ 0ì›</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. ê°€ë³¼ë§Œí•œ ê³³ ë·° -->
        <div id="view-candidates" class="flex flex-col flex-1 overflow-hidden hidden">
            <div class="p-4 bg-amber-50 border-b border-amber-100 shrink-0">
                <p class="text-xs text-amber-800 font-bold"><i class="fa-solid fa-lightbulb mr-1"></i>Day <span id="candidateDayDisplay">1</span>ì— ê°ˆê¹Œ ë§ê¹Œ ê³ ë¯¼ ì¤‘ì¸ ì¥ì†Œë“¤ì…ë‹ˆë‹¤.</p>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-white" id="candidateList"></div>
        </div>
    </div>

    <!-- ë©”ì¸ ì§€ë„ ì˜ì—­ -->
    <div class="flex-1 relative h-full w-full">
        <!-- ëª¨ë°”ì¼ í–„ë²„ê±° -->
        <button id="openSidebar" class="absolute top-4 left-4 z-[999] md:hidden bg-white p-3 rounded-full shadow-xl text-primary border border-slate-100 w-12 h-12 flex items-center justify-center">
            <i class="fa-solid fa-bars text-lg"></i>
        </button>

        <!-- ìš°ì¸¡ ìƒë‹¨ ì»¨íŠ¸ë¡¤ -->
        <div class="absolute top-4 right-4 z-[999] flex flex-col space-y-3 items-end">
            <div id="authStatus" class="hidden bg-emerald-500/90 backdrop-blur text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-lg mb-1 animate-pulse border border-emerald-400">
                <i class="fa-solid fa-user-shield mr-1"></i>Admin Mode
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="openWeatherForecastModal()" class="bg-white/90 backdrop-blur hover:bg-white text-slate-700 px-3 py-2.5 rounded-xl shadow-lg border border-slate-200 font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-calendar-days text-sky-500"></i><span class="hidden sm:inline">ì—¬í–‰ ë‚ ì”¨</span>
                </button>
                <button onclick="openSuggestionModal()" class="bg-white/90 backdrop-blur hover:bg-white text-slate-700 px-3 py-2.5 rounded-xl shadow-lg border border-slate-200 font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-regular fa-lightbulb text-amber-500"></i><span class="hidden sm:inline">ì¶”ì²œ</span>
                </button>
                <button id="adminSuggestionBtn" onclick="openAdminSuggestionBox()" class="hidden bg-amber-400 hover:bg-amber-500 text-white px-3 py-2.5 rounded-xl shadow-lg font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-inbox"></i>
                </button>
                <button onclick="toggleLoginModal()" id="loginBtn" class="bg-primary hover:bg-slate-800 text-white px-3 py-2.5 rounded-xl shadow-lg font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-lock"></i>
                </button>
                <button onclick="logout()" id="logoutBtn" class="hidden bg-slate-600 hover:bg-slate-700 text-white px-3 py-2.5 rounded-xl shadow-lg font-bold text-sm transition">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>

        <!-- í€µ ì¶”ê°€ FAB ë²„íŠ¼ -->
        <button onclick="openQuickAddModal()" class="absolute bottom-28 right-4 z-[900] fab-btn w-12 h-12 bg-indigo-600 text-white rounded-full shadow-xl flex items-center justify-center border-2 border-white hover:bg-indigo-700" title="ì¥ì†Œ ì¶”ê°€">
            <i class="fa-solid fa-plus text-xl"></i>
        </button>

        <!-- ì‹¤ì‹œê°„ ë‚ ì”¨ ìœ„ì ¯ -->
        <div id="liveWeatherWidget" class="absolute bottom-6 right-4 z-[900] weather-widget bg-white/90 backdrop-blur-md p-3 rounded-2xl shadow-xl border border-white/50 min-w-[140px] flex flex-col items-center cursor-pointer" onclick="openCurrentWeatherModal()">
            <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1"><i class="fa-solid fa-location-crosshairs mr-1"></i>ì§€ë„ ìœ„ì¹˜ ë‚ ì”¨</div>
            <div class="flex items-center gap-2">
                <div id="weatherIcon" class="text-2xl text-slate-600"><i class="fa-solid fa-spinner fa-spin text-lg"></i></div>
                <div class="text-right">
                    <div id="weatherTemp" class="text-xl font-bold text-slate-800">--Â°</div>
                    <div id="weatherDesc" class="text-[10px] text-slate-500 font-medium">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>

        <div id="map" class="w-full h-full z-0 bg-slate-100"></div>
    </div>

    <!-- í˜„ì¬ ìœ„ì¹˜ ìƒì„¸ ë‚ ì”¨ ëª¨ë‹¬ -->
    <div id="currentWeatherModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-[350px] max-w-[90%] fade-in border border-slate-100 m-4 text-center">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wide">Location Weather</h3>
                <button onclick="document.getElementById('currentWeatherModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="mb-4">
                <div id="curWeatherIconBig" class="text-5xl text-slate-600 mb-2 h-16 flex items-center justify-center"><i class="fa-solid fa-cloud"></i></div>
                <h2 id="curWeatherTempBig" class="text-4xl font-bold text-slate-800">--Â°</h2>
                <p id="curWeatherDescBig" class="text-slate-500 font-medium">ì •ë³´ ë¡œë”© ì¤‘...</p>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 mb-2">
                <p class="text-xs text-slate-400 mb-1"><i class="fa-solid fa-map-pin mr-1"></i>í˜„ì¬ ì§€ë„ ì¤‘ì‹¬</p>
                <p id="curWeatherAddress" class="text-sm text-slate-700 font-bold break-keep">ì£¼ì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs text-slate-500">
                <div class="bg-slate-50 p-2 rounded-lg"><span class="block text-[10px] text-slate-400">í’ì†</span><span id="curWind" class="font-bold">-- km/h</span></div>
                <div class="bg-slate-50 p-2 rounded-lg"><span class="block text-[10px] text-slate-400">ìŠµë„(ì˜ˆìƒ)</span><span class="font-bold">-- %</span></div>
            </div>
        </div>
    </div>

    <!-- ë‚ ì”¨ ì˜ˆë³´ ëª¨ë‹¬ -->
    <div id="weatherForecastModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-[600px] max-w-[90%] fade-in border border-slate-100 m-4">
            <div class="flex justify-between items-center mb-5 border-b border-slate-100 pb-3">
                <div>
                    <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-cloud-sun mr-2 text-sky-500"></i>ì—¬í–‰ ê¸°ê°„ ë‚ ì”¨ ì˜ˆë³´</h2>
                    <p class="text-xs text-slate-500 mt-1">2026.03.02 - 03.07 (ìˆ™ì†Œ ìœ„ì¹˜ ê¸°ì¤€)</p>
                </div>
                <button onclick="closeWeatherForecastModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="weatherInfoBox" class="bg-sky-50 p-3 rounded-xl mb-4 text-xs text-sky-700 font-medium flex items-center gap-2">
                <i class="fa-solid fa-circle-info"></i>
                <span id="weatherInfoText">ë¡œë”© ì¤‘...</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="weatherCardsContainer">
                <div class="col-span-3 text-center py-10 text-slate-400">
                    <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            </div>
            <button onclick="closeWeatherForecastModal()" class="w-full mt-5 bg-slate-800 text-white py-3 rounded-xl font-bold text-sm hover:bg-slate-700 transition">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="loginModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-80 fade-in border border-slate-100">
            <h2 class="text-xl font-bold mb-6 text-center text-primary">Admin Access</h2>
            <input type="password" id="passwordInput" placeholder="Password" class="w-full p-3.5 border border-slate-200 rounded-xl mb-4 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none transition" onkeyup="if(window.event.keyCode==13){checkPassword()}">
            <div class="flex gap-3">
                <button onclick="toggleLoginModal()" class="flex-1 py-3 bg-slate-100 rounded-xl text-slate-600 font-bold hover:bg-slate-200 transition">Cancel</button>
                <button onclick="checkPassword()" class="flex-1 py-3 bg-primary rounded-xl text-white font-bold hover:bg-slate-800 transition shadow-lg shadow-indigo-500/20">Login</button>
            </div>
        </div>
    </div>

    <!-- ì¶”ì²œ ëª¨ë‹¬ -->
    <div id="suggestionModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-96 max-w-[90%] fade-in border border-slate-100 m-4">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-lg font-bold text-slate-800"><i class="fa-regular fa-paper-plane mr-2 text-indigo-500"></i>Place Suggestion</h2>
                <button onclick="closeSuggestionModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="sugPlace" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ì¥ì†Œëª… (ì˜ˆ: ì˜¤ìŠ¤ ìƒì ê°€)">
                <textarea id="sugReason" rows="3" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ì¶”ì²œ ì´ìœ ë¥¼ ì ì–´ì£¼ì„¸ìš”."></textarea>
                <button onclick="submitSuggestion()" class="w-full bg-amber-400 hover:bg-amber-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-amber-500/20 transition text-sm">ë³´ë‚´ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê±´ì˜í•¨ (ê´€ë¦¬ì) -->
    <div id="adminSuggestionBox" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-[400px] max-w-[90%] h-[500px] flex flex-col fade-in m-4">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-inbox mr-2 text-amber-500"></i>Inbox</h2>
                <button onclick="closeAdminSuggestionBox()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="suggestionList" class="flex-1 overflow-y-auto space-y-2 pr-1">
                <!-- Content -->
            </div>
        </div>
    </div>

    <!-- ì¼ì • ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="addScheduleModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-[440px] max-w-[95%] max-h-[90dvh] overflow-y-auto fade-in m-4 border border-slate-100 relative">
            <div class="flex justify-between items-center mb-5 border-b border-slate-100 pb-3 sticky top-0 bg-white z-10">
                <h2 class="text-lg font-bold text-slate-800" id="modalTitle"><i class="fa-solid fa-pen-to-square mr-2 text-indigo-500"></i>ìƒˆ ì¼ì • ì¶”ê°€</h2>
                <button onclick="closeAddScheduleModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="space-y-5">
                <!-- ì¥ì†Œ ê²€ìƒ‰ ë° ì£¼ì†Œ -->
                <div class="space-y-3">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide">ì¥ì†Œ ê²€ìƒ‰</label>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <input type="text" id="searchAddressInput" class="w-full p-3 pl-9 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ì¥ì†Œëª… ë˜ëŠ” ì£¼ì†Œ (ì˜ì–´/í•œêµ­ì–´)" onkeyup="if(window.event.keyCode==13){searchAddress()}">
                            <i class="fa-solid fa-magnifying-glass absolute left-3.5 top-3.5 text-slate-400"></i>
                        </div>
                        <button onclick="searchAddress()" class="px-4 py-2 bg-slate-800 text-white rounded-xl text-sm font-bold hover:bg-slate-700 transition">ê²€ìƒ‰</button>
                    </div>
                    
                    <div>
                        <input type="text" id="addPlace" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 focus:border-indigo-500 outline-none transition bg-white" placeholder="ì¥ì†Œëª… (í‘œì‹œìš©)">
                    </div>
                    
                    <div class="relative">
                        <input type="text" id="addAddress" class="w-full p-3 pl-9 border border-slate-200 rounded-xl text-xs bg-slate-50 text-slate-500 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ìƒì„¸ ì£¼ì†Œ (ìë™ ì…ë ¥)">
                        <i class="fa-solid fa-map-pin absolute left-3.5 top-3.5 text-slate-400"></i>
                    </div>
                </div>

                <!-- í‰ì  (ìŠ¬ë¼ì´ë”) -->
                <div>
                     <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">í‰ì  (0.0 ~ 5.0)</label>
                     <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-200">
                         <input type="range" id="ratingSlider" min="0" max="5" step="0.1" value="0" class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-amber-400">
                         <div class="w-12 text-right font-bold text-amber-500 text-lg" id="ratingValueDisplay">0.0</div>
                     </div>
                </div>

                <!-- ëˆ„êµ¬ì˜ Pick? -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">ëˆ„êµ¬ì˜ í”½?</label>
                    <div class="flex gap-2">
                        <div class="flex-1 relative">
                            <input type="radio" name="picker" id="picker_common" value="common" class="peer hidden pick-radio" checked>
                            <label for="picker_common" class="block w-full py-2 text-center border border-slate-200 rounded-lg text-xs font-bold text-slate-500 cursor-pointer hover:bg-slate-50 transition peer-checked:bg-slate-600 peer-checked:text-white peer-checked:border-slate-600">ê³µí†µ</label>
                        </div>
                        <div class="flex-1 relative">
                            <input type="radio" name="picker" id="picker_juice" value="juice" class="peer hidden pick-radio">
                            <label for="picker_juice" class="block w-full py-2 text-center border border-orange-200 rounded-lg text-xs font-bold text-orange-500 cursor-pointer hover:bg-orange-50 transition peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">Juice's Pick</label>
                        </div>
                        <div class="flex-1 relative">
                            <input type="radio" name="picker" id="picker_yumin" value="yumin" class="peer hidden pick-radio">
                            <label for="picker_yumin" class="block w-full py-2 text-center border border-indigo-200 rounded-lg text-xs font-bold text-indigo-500 cursor-pointer hover:bg-indigo-50 transition peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600">Yumin's Pick</label>
                        </div>
                    </div>
                </div>

                <!-- ì‹œê°„ (ë™ì ) -->
                <div id="timeSection">
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì‹œê°„</label>
                    <input type="time" id="addTime" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white">
                </div>

                <!-- ì¹´í…Œê³ ë¦¬ -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">ì¹´í…Œê³ ë¦¬</label>
                    <div class="grid grid-cols-5 gap-2" id="categoryGrid"></div>
                </div>

                <!-- ì´ë™ ìˆ˜ë‹¨ -->
                <div id="transportSection" class="hidden">
                      <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">ì´ê³³ê¹Œì§€ ì´ë™ ìˆ˜ë‹¨</label>
                      <div class="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100">
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div>
                                <input type="radio" name="moveType" id="move_walk" value="walk" class="hidden transport-radio" checked onchange="toggleTransportCost(false)">
                                <label for="move_walk" class="flex items-center justify-center py-2 rounded-lg border border-slate-200 bg-white text-xs text-slate-600 cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-person-walking mr-1"></i>ë„ë³´</label>
                            </div>
                            <div>
                                <input type="radio" name="moveType" id="move_bus" value="bus" class="hidden transport-radio" onchange="toggleTransportCost(true)">
                                <label for="move_bus" class="flex items-center justify-center py-2 rounded-lg border border-slate-200 bg-white text-xs text-slate-600 cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-bus mr-1"></i>ë²„ìŠ¤</label>
                            </div>
                            <div>
                                <input type="radio" name="moveType" id="move_subway" value="subway" class="hidden transport-radio" onchange="toggleTransportCost(true)">
                                <label for="move_subway" class="flex items-center justify-center py-2 rounded-lg border border-slate-200 bg-white text-xs text-slate-600 cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-train-subway mr-1"></i>ì§€í•˜ì² </label>
                            </div>
                        </div>
                        <div id="moveCostField" class="hidden">
                            <label class="text-[10px] font-bold text-slate-500 mb-1 block">ì´ë™ êµí†µë¹„ (JPY)</label>
                            <input type="number" id="addMoveCost" class="w-full p-2 border border-slate-200 rounded-lg text-sm text-right bg-white" placeholder="0">
                        </div>
                      </div>
                </div>

                <!-- ë™ì  í•„ë“œ (ë¹„ìš© ë“±) -->
                <div id="dynamicFields" class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100 hidden"></div>

                <!-- ì´ë¯¸ì§€ ì¶”ê°€ (ìµœëŒ€ 3ê°œ) -->
                <div>
                     <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">ì´ë¯¸ì§€ (URL)</label>
                     <div class="space-y-2">
                         <input type="text" id="imgUrl1" class="w-full p-3 border border-slate-200 rounded-xl text-xs bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ì´ë¯¸ì§€ URL 1">
                         <input type="text" id="imgUrl2" class="w-full p-3 border border-slate-200 rounded-xl text-xs bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ì´ë¯¸ì§€ URL 2">
                         <input type="text" id="imgUrl3" class="w-full p-3 border border-slate-200 rounded-xl text-xs bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ì´ë¯¸ì§€ URL 3">
                     </div>
                </div>

                <!-- ë©”ëª¨ -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ë©”ëª¨</label>
                    <textarea id="addMemo" rows="2" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition resize-none" placeholder="ê¸°ì–µí•  ë‚´ìš©..."></textarea>
                </div>

                <button onclick="submitNewSchedule()" id="submitBtn" class="w-full bg-primary hover:bg-slate-800 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-slate-900/10 transition text-sm flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check"></i> ì¼ì • ì €ì¥í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import * as L from 'https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAhC1MM1KI759uNFhqyu1RNjmw0Xqez5E0",
            authDomain: "mytravelmap-4f52a.firebaseapp.com",
            projectId: "mytravelmap-4f52a",
            storageBucket: "mytravelmap-4f52a.firebasestorage.app",
            messagingSenderId: "1064774813139",
            appId: "1:1064774813139:web:29b2b9e3150fbbb2ad5b26"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        let map, markersLayer, pathLayer;
        let currentDay = 1;
        let isAdmin = false;
        const totalDays = 6;
        let isFirstLoad = true;
        let tempLatLng = null;
        let EXCHANGE_RATE = 9.1; // 1 JPY = 9.1 KRW (Default)
        let EXCHANGE_RATE_USD = 0.0067; // 1 JPY = 0.0067 USD (Default)
        
        window.tripItems = [];
        window.candidateItems = [];
        window.popupImageStates = {}; // íŒì—… ì´ë¯¸ì§€ ìƒíƒœ ê´€ë¦¬ { itemId: 0 }
        
        let editingId = null; 
        let isCandidateMode = false; 

        const categories = [
            { id: 'flight', label: 'í•­ê³µ', icon: 'âœˆï¸', color: 'text-indigo-600' },
            { id: 'hotel', label: 'ìˆ™ì†Œ', icon: 'ğŸ¨', color: 'text-blue-600' },
            { id: 'food', label: 'ë§›ì§‘', icon: 'ğŸ´', color: 'text-orange-500' },
            { id: 'cafe', label: 'ì¹´í˜', icon: 'â˜•', color: 'text-amber-700' },
            { id: 'attraction', label: 'ëª…ì†Œ', icon: 'ğŸ¡', color: 'text-purple-600' },
            { id: 'mart', label: 'ì‡¼í•‘', icon: 'ğŸ›ï¸', color: 'text-pink-600' },
            { id: 'convenience', label: 'í¸ì˜ì ', icon: 'ğŸª', color: 'text-cyan-500' },
            { id: 'bank', label: 'ì€í–‰', icon: 'ğŸ¦', color: 'text-gray-600' },
            { id: 'etc', label: 'ê¸°íƒ€', icon: 'ğŸ“', color: 'text-gray-400' },
        ];

        window.onload = async () => {
            initMap();
            renderDayTabs();
            renderCategoryGrid();
            setupRatingUI();
            fetchExchangeRate();
            updateMapWeather(35.1709, 136.8815); 
            
            try {
                await signInAnonymously(auth);
                subscribeToItinerary();
                subscribeToCandidates(); 
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }

            if(localStorage.getItem('travel_admin') === 'true') {
                grantAdminAccess();
            }
            updateAdminUI();
            setupEventListeners();
        };

        window.switchMainTab = (tabName) => {
            const itineraryView = document.getElementById('view-itinerary');
            const candidateView = document.getElementById('view-candidates');
            const tabItinerary = document.getElementById('tab-itinerary');
            const tabCandidates = document.getElementById('tab-candidates');

            if (tabName === 'itinerary') {
                itineraryView.classList.remove('hidden');
                candidateView.classList.add('hidden');
                tabItinerary.className = 'flex-1 py-3 text-sm text-center transition tab-active';
                tabCandidates.className = 'flex-1 py-3 text-sm text-center transition tab-inactive';
                markersLayer.clearLayers();
                pathLayer.clearLayers();
                subscribeToItinerary(); 
            } else {
                itineraryView.classList.add('hidden');
                candidateView.classList.remove('hidden');
                tabItinerary.className = 'flex-1 py-3 text-sm text-center transition tab-inactive';
                tabCandidates.className = 'flex-1 py-3 text-sm text-center transition tab-active';
                markersLayer.clearLayers();
                pathLayer.clearLayers();
                renderCandidatesOnMap(); 
            }
        };

        window.openQuickAddModal = () => {
            if(!isAdmin) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
            const isCandidateTab = !document.getElementById('view-candidates').classList.contains('hidden');
            openAddScheduleModal(null, null, 'etc', isCandidateTab);
        };

        // --- ì—¬í–‰ ë‚ ì”¨ ëª¨ë‹¬ ---
        window.openWeatherForecastModal = async () => {
            const modal = document.getElementById('weatherForecastModal');
            modal.classList.remove('hidden');
            const container = document.getElementById('weatherCardsContainer');
            container.innerHTML = '<div class="col-span-3 text-center py-10 text-slate-400"><i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i><p>ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p></div>';
            document.getElementById('weatherInfoText').innerText = "2026ë…„ 3ì›” ì˜ˆì • (ê¸°ì˜¨/ë‚ ì”¨ëŠ” í‰ë…„ ì˜ˆë³´ ì°¸ê³ )";

            try {
                if(!window.tripItems) { throw new Error("ë°ì´í„° ì—†ìŒ"); }

                let cardsHtml = '';
                const baseDate = new Date('2026-03-02'); 

                for (let i = 1; i <= totalDays; i++) {
                    const dayItems = window.tripItems.filter(item => item.day === i);
                    let targetItem = dayItems.find(item => item.category === 'hotel') || dayItems[dayItems.length - 1];
                    
                    let lat = 35.1709; 
                    let lng = 136.8815;
                    let locationName = "ë‚˜ê³ ì•¼";

                    if (targetItem) {
                        const tLat = parseFloat(targetItem.lat);
                        const tLng = parseFloat(targetItem.lng);
                        if (Number.isFinite(tLat) && Number.isFinite(tLng)) {
                            lat = tLat;
                            lng = tLng;
                            locationName = targetItem.place;
                        }
                    }

                    const currentDate = new Date(baseDate);
                    currentDate.setDate(baseDate.getDate() + (i - 1));
                    const month = currentDate.getMonth() + 1;
                    const date = currentDate.getDate();
                    const dayName = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][currentDate.getDay()];
                    
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`);
                    const data = await res.json();
                    
                    let wCode = 0, maxT = 0, minT = 0;
                    if(data.daily && data.daily.time) {
                        const idx = Math.min(i-1, data.daily.time.length - 1);
                        wCode = data.daily.weathercode[idx];
                        maxT = data.daily.temperature_2m_max[idx];
                        minT = data.daily.temperature_2m_min[idx];
                    }

                    const { icon, desc } = getWeatherIcon(wCode);

                    cardsHtml += `
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 flex flex-col items-center justify-center text-center">
                            <div class="text-xs font-bold text-slate-400 mb-1">Day ${i} <span class="text-slate-300">|</span> ${month}.${date} (${dayName})</div>
                            <div class="text-[10px] text-slate-400 mb-2 truncate w-full px-1">${locationName}</div>
                            <div class="text-3xl mb-2">${icon}</div>
                            <div class="text-sm font-bold text-slate-700">${minT}Â° / ${maxT}Â°</div>
                            <div class="text-xs text-slate-500">${desc}</div>
                        </div>
                    `;
                }
                container.innerHTML = cardsHtml;

            } catch (e) {
                console.error(e);
                container.innerHTML = '<div class="col-span-3 text-center py-5 text-rose-500"><i class="fa-solid fa-triangle-exclamation mb-2"></i><p>ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>';
            }
        };
        
        window.closeWeatherForecastModal = () => document.getElementById('weatherForecastModal').classList.add('hidden');

        // --- í˜„ì¬ ìœ„ì¹˜ ìƒì„¸ ëª¨ë‹¬ ---
        window.openCurrentWeatherModal = async () => {
            const center = map.getCenter();
            document.getElementById('currentWeatherModal').classList.remove('hidden');
            document.getElementById('curWeatherDescBig').innerText = "ë°ì´í„° ì¡°íšŒ ì¤‘...";
            document.getElementById('curWeatherAddress').innerText = "ì£¼ì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

            try {
                const addrRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}&zoom=18&addressdetails=1`);
                const addrData = await addrRes.json();
                if(addrData && addrData.display_name) {
                    const parts = addrData.display_name.split(',');
                    document.getElementById('curWeatherAddress').innerText = parts.slice(0, 4).join(', ');
                } else {
                    document.getElementById('curWeatherAddress').innerText = "ì£¼ì†Œ ì •ë³´ ì—†ìŒ";
                }
            } catch(e) { document.getElementById('curWeatherAddress').innerText = "ì£¼ì†Œ í™•ì¸ ë¶ˆê°€"; }

            try {
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${center.lat}&longitude=${center.lng}&current_weather=true&hourly=relativehumidity_2m&timezone=Asia%2FTokyo`);
                const wData = await weatherRes.json();
                
                if(wData && wData.current_weather) {
                    const temp = wData.current_weather.temperature;
                    const code = wData.current_weather.weathercode;
                    const wind = wData.current_weather.windspeed;
                    const { icon, desc } = getWeatherIcon(code);
                    
                    document.getElementById('curWeatherTempBig').innerText = `${temp}Â°C`;
                    document.getElementById('curWeatherIconBig').innerHTML = icon;
                    document.getElementById('curWeatherDescBig').innerText = desc;
                    document.getElementById('curWind').innerText = `${wind} km/h`;
                }
            } catch(e) {
                document.getElementById('curWeatherDescBig').innerText = "ë‚ ì”¨ ì •ë³´ ì˜¤ë¥˜";
            }
        };

        // Edit Function
        window.editItem = async (id, isCandidate = false) => {
            let item;
            if (isCandidate) {
                 item = window.candidateItems.find(i => i.id === id);
            } else {
                 item = window.tripItems.find(i => i.id === id);
            }
            
            if(!item) return alert("í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            await openAddScheduleModal(item.lat, item.lng, item.category, isCandidate);

            editingId = id;

            document.getElementById('modalTitle').innerText = isCandidate ? 'í›„ë³´ ì¥ì†Œ ìˆ˜ì •' : 'ì¼ì • ìˆ˜ì •';
            document.getElementById('submitBtn').innerHTML = '<i class="fa-solid fa-pen mr-1"></i> ìˆ˜ì • ì™„ë£Œ';

            document.getElementById('addPlace').value = item.place;
            document.getElementById('addAddress').value = item.address || '';
            document.getElementById('addMemo').value = item.memo || '';
            
            // ì´ë¯¸ì§€ ê°’ ì±„ìš°ê¸°
            if(item.images && Array.isArray(item.images)) {
                document.getElementById('imgUrl1').value = item.images[0] || '';
                document.getElementById('imgUrl2').value = item.images[1] || '';
                document.getElementById('imgUrl3').value = item.images[2] || '';
            }

            // í‰ì  ê°’ ì±„ìš°ê¸°
            if(item.rating) {
                setRatingValue(item.rating);
            }

            const pickerRadios = document.querySelectorAll('input[name="picker"]');
            pickerRadios.forEach(r => r.checked = false);
            if(item.picker) {
                const radio = document.querySelector(`input[name="picker"][value="${item.picker}"]`);
                if(radio) radio.checked = true;
            } else {
                document.getElementById('picker_common').checked = true;
            }

            const timeEl = document.getElementById('addTime');
            if(timeEl && item.time) timeEl.value = item.time;

            const depEl = document.getElementById('addDepTime');
            if(depEl && item.depTime) depEl.value = item.depTime;

            const arrEl = document.getElementById('addArrTime');
            if(arrEl && item.arrTime) arrEl.value = item.arrTime;

            const checkInEl = document.getElementById('addCheckIn');
            if(checkInEl && item.checkIn) checkInEl.value = item.checkIn;

            const checkOutEl = document.getElementById('addCheckOut');
            if(checkOutEl && item.checkOut) checkOutEl.value = item.checkOut;

            window.currentCurrency = 'JPY';
            document.getElementById('addCost').value = item.cost || 0;
            window.calcConversion(item.cost || 0);

            const menuEl = document.getElementById('addMenu');
            if(menuEl) menuEl.value = item.menu || '';

            const reservedEl = document.getElementById('addReserved');
            if(reservedEl) reservedEl.checked = item.isReserved || false;

            const flightNumEl = document.getElementById('addFlightNum');
            if(flightNumEl) flightNumEl.value = item.flightNum || '';
            
            if (item.moveType) {
                const moveRadio = document.querySelector(`input[name="moveType"][value="${item.moveType}"]`);
                if(moveRadio) {
                    moveRadio.checked = true;
                    window.toggleTransportCost(item.moveType !== 'walk');
                    if(item.moveCost) document.getElementById('addMoveCost').value = item.moveCost;
                }
            }

            const eLat = parseFloat(item.lat);
            const eLng = parseFloat(item.lng);
            if(Number.isFinite(eLat) && Number.isFinite(eLng)) {
                tempLatLng = { lat: eLat, lng: eLng };
            } else {
                tempLatLng = null;
            }
        };

        function subscribeToCandidates() {
            const colRef = collection(db, 'trips', appId, 'candidates');
            onSnapshot(colRef, (snapshot) => {
                const list = document.getElementById('candidateList');
                list.innerHTML = '';
                window.candidateItems = [];
                snapshot.forEach(doc => window.candidateItems.push({ id: doc.id, ...doc.data() }));

                const dayCandidates = window.candidateItems.filter(item => item.day === currentDay);

                if(dayCandidates.length === 0) {
                    list.innerHTML = '<div class="text-center text-slate-400 mt-10">Day ' + currentDay + 'ì— ë“±ë¡ëœ í›„ë³´ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }

                dayCandidates.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition cursor-pointer relative';
                    
                    const itemLat = parseFloat(item.lat);
                    const itemLng = parseFloat(item.lng);
                    const hasLocation = Number.isFinite(itemLat) && Number.isFinite(itemLng);

                    el.onclick = () => { if(hasLocation) map.flyTo([itemLat, itemLng], 16); };
                    
                    const catObj = categories.find(c => c.id === item.category) || categories.find(c => c.id === 'etc');

                    // ë³„ì  í‘œì‹œ
                    let starDisplay = '';
                    if (item.rating > 0) {
                        starDisplay = `<div class="text-amber-400 text-xs mt-1"><i class="fa-solid fa-star mr-1"></i>${item.rating.toFixed(1)}</div>`;
                    }

                    el.innerHTML = `
                        <div class="flex items-start gap-3">
                            <div class="text-xl w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-500">
                                ${catObj.icon}
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-slate-800">${item.place}</h4>
                                ${starDisplay}
                                <p class="text-xs text-slate-400 mt-1 truncate"><i class="fa-solid fa-map-pin mr-1"></i>${item.address || '-'}</p>
                                <p class="text-sm text-slate-600 mt-1">${item.memo || ''}</p>
                            </div>
                        </div>
                        ${isAdmin ? `
                        <div class="absolute top-2 right-2 flex gap-1">
                            <button onclick="event.stopPropagation(); window.editItem('${item.id}', true)" class="text-slate-300 hover:text-indigo-500 p-2"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="event.stopPropagation(); window.deleteCandidate('${item.id}')" class="text-slate-300 hover:text-rose-500 p-2"><i class="fa-solid fa-trash-can"></i></button>
                        </div>` : ''}
                    `;
                    list.appendChild(el);
                });

                if(!document.getElementById('view-candidates').classList.contains('hidden')) {
                    renderCandidatesOnMap();
                }
            });
        }

        function renderCandidatesOnMap() {
            markersLayer.clearLayers();
            const dayCandidates = window.candidateItems.filter(item => item.day === currentDay);
            dayCandidates.forEach(item => {
                const itemLat = parseFloat(item.lat);
                const itemLng = parseFloat(item.lng);
                
                if(Number.isFinite(itemLat) && Number.isFinite(itemLng)) {
                    const markerIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #64748b; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 16px; color: white;">?</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });
                    const marker = L.marker([itemLat, itemLng], {icon: markerIcon}).addTo(markersLayer);
                    marker.bindPopup(generatePopupContent(item));
                }
            });
        }

        window.deleteCandidate = async (id) => {
            if(confirm("ì´ í›„ë³´ ì¥ì†Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await deleteDoc(doc(db, 'trips', appId, 'candidates', id));
        }

        window.deleteItem = async (id) => {
            if(confirm("ì´ ì¼ì •ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await deleteDoc(doc(db, 'trips', appId, 'itineraries', id));
        }

        async function fetchExchangeRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await res.json();
                if (data && data.rates && data.rates.KRW) {
                    EXCHANGE_RATE = data.rates.KRW;
                    EXCHANGE_RATE_USD = data.rates.USD || 0.0067;
                    document.getElementById('exchangeRateDisplay').innerText = `í˜„ì¬ í™˜ìœ¨: Â¥100 = â‚©${(EXCHANGE_RATE * 100).toFixed(0)} | $${(EXCHANGE_RATE_USD * 100).toFixed(2)}`;
                }
            } catch (e) {
                document.getElementById('exchangeRateDisplay').innerText = `ì˜ˆìƒ í™˜ìœ¨: Â¥100 = â‚©910 (ê¸°ë³¸ê°’)`;
            }
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([35.1709, 136.8815], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            pathLayer = L.layerGroup().addTo(map);
            
            map.on('moveend', function() {
                const center = map.getCenter();
                updateMapWeather(center.lat, center.lng);
            });
        }

        function renderDayTabs() {
            const container = document.getElementById('dayTabs');
            container.innerHTML = '';
            
            // ì „ì²´ ì¼ì • ë²„íŠ¼ ì¶”ê°€
            const allBtn = document.createElement('button');
            const isAllActive = currentDay === 'all';
            allBtn.className = `px-5 py-2 text-sm font-bold rounded-full whitespace-nowrap transition-all duration-200 border ${isAllActive ? 'bg-primary text-white border-primary shadow-md transform scale-105' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50 hover:border-slate-300'}`;
            allBtn.innerText = `ì „ì²´ ì¼ì •`;
            allBtn.onclick = () => { 
                currentDay = 'all'; 
                isFirstLoad = false;
                document.getElementById('candidateDayDisplay').innerText = 'All';
                renderDayTabs(); 
                subscribeToItinerary(); 
                // í›„ë³´ ì¥ì†ŒëŠ” Dayë³„ë¡œ ë³´ëŠ”ê²Œ ì¼ë°˜ì ì´ë¯€ë¡œ ë¦¬ì…‹í•˜ê±°ë‚˜ ì „ì²´ í‘œì‹œ (ì—¬ê¸°ì„  ì „ì²´ë¡œ ì²˜ë¦¬)
                subscribeToCandidates(); 
            };
            container.appendChild(allBtn);

            for(let i=1; i<=totalDays; i++) {
                const btn = document.createElement('button');
                const isActive = currentDay === i;
                btn.className = `px-5 py-2 text-sm font-bold rounded-full whitespace-nowrap transition-all duration-200 border ${isActive ? 'bg-primary text-white border-primary shadow-md transform scale-105' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50 hover:border-slate-300'}`;
                btn.innerText = `Day ${i}`;
                btn.onclick = () => { 
                    currentDay = i; 
                    isFirstLoad = true;
                    document.getElementById('candidateDayDisplay').innerText = i;
                    renderDayTabs(); 
                    subscribeToItinerary(); 
                    subscribeToCandidates();
                };
                container.appendChild(btn);
            }
        }

        function renderCategoryGrid() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = categories.map(cat => `
                <div class="relative group">
                    <input type="radio" name="category" id="cat_${cat.id}" value="${cat.id}" class="peer hidden category-radio" ${cat.id === 'etc' ? 'checked' : ''} onchange="updateDynamicFields(this.value)">
                    <label for="cat_${cat.id}" class="flex flex-col items-center justify-center p-2.5 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition h-full text-center">
                        <span class="text-xl mb-1 filter drop-shadow-sm group-hover:scale-110 transition">${cat.icon}</span>
                        <span class="text-[10px] text-slate-500 whitespace-nowrap font-medium">${cat.label}</span>
                    </label>
                </div>
            `).join('');
        }

        // --- í‰ì (Slider) UI ---
        function setupRatingUI() {
            const slider = document.getElementById('ratingSlider');
            const display = document.getElementById('ratingValueDisplay');

            slider.addEventListener('input', (e) => {
                display.innerText = parseFloat(e.target.value).toFixed(1);
            });
        }

        function setRatingValue(val) {
             const slider = document.getElementById('ratingSlider');
             const display = document.getElementById('ratingValueDisplay');
             slider.value = val;
             display.innerText = parseFloat(val).toFixed(1);
        }

        window.fetchAddress = async (lat, lng) => {
            document.getElementById('addAddress').value = "ì£¼ì†Œ ê²€ìƒ‰ ì¤‘...";
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=ko,en`);
                const data = await res.json();
                if(data && data.display_name) {
                    document.getElementById('addAddress').value = data.display_name;
                    if (!document.getElementById('addPlace').value) {
                         const placeName = data.address.amenity || data.address.shop || data.address.tourism || data.address.historic || data.address.building || "ìƒˆë¡œìš´ ì¥ì†Œ";
                         document.getElementById('addPlace').value = placeName;
                    }
                } else {
                    document.getElementById('addAddress').value = "ì£¼ì†Œ ì •ë³´ ì—†ìŒ";
                }
            } catch(e) {
                console.error(e);
                document.getElementById('addAddress').value = "ì£¼ì†Œ í™•ì¸ ë¶ˆê°€";
            }
        };

        window.openAddScheduleModal = async (lat, lng, preSelectCat = null, forCandidate = false) => {
            const modal = document.getElementById('addScheduleModal');
            editingId = null;
            isCandidateMode = forCandidate;
            document.getElementById('modalTitle').innerText = forCandidate ? 'ìƒˆ í›„ë³´ ì¥ì†Œ ì¶”ê°€' : 'ìƒˆ ì¼ì • ì¶”ê°€';
            document.getElementById('submitBtn').innerHTML = '<i class="fa-solid fa-check mr-1"></i> ì €ì¥í•˜ê¸°';
            document.getElementById('searchAddressInput').value = '';
            document.getElementById('addPlace').value = preSelectCat === 'flight' ? 'ë‚˜ê³ ì•¼ ì¤‘ë¶€êµ­ì œê³µí•­' : '';
            document.getElementById('addMemo').value = '';
            document.getElementById('addAddress').value = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';
            document.getElementById('move_walk').checked = true; 
            
            // ì´ë¯¸ì§€/í‰ì  ì´ˆê¸°í™”
            document.getElementById('imgUrl1').value = '';
            document.getElementById('imgUrl2').value = '';
            document.getElementById('imgUrl3').value = '';
            setRatingValue(0);

            const pickerRadios = document.querySelectorAll('input[name="picker"]');
            pickerRadios.forEach(r => r.checked = false);
            document.getElementById('picker_common').checked = true; 
            
            window.toggleTransportCost(false);
            
            let targetCat = preSelectCat || 'etc';
            document.getElementById(`cat_${targetCat}`).checked = true;
            
            window.currentCurrency = 'JPY'; 
            window.updateDynamicFields(targetCat);
            
            if (lat === null || lat === undefined || lng === null || lng === undefined) {
                tempLatLng = null; 
                document.getElementById('addAddress').value = 'ì§ì ‘ ì…ë ¥';
            } else {
                tempLatLng = { lat, lng };
                await fetchAddress(lat, lng);
            }

            modal.classList.remove('hidden');
            setTimeout(() => document.getElementById('searchAddressInput').focus(), 100);
        };

        window.closeAddScheduleModal = () => document.getElementById('addScheduleModal').classList.add('hidden');

        window.submitNewSchedule = async () => {
            if(!isAdmin) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
            
            const place = document.getElementById('addPlace').value;
            const memo = document.getElementById('addMemo').value;
            const address = document.getElementById('addAddress').value;
            const selectedCatId = document.querySelector('input[name="category"]:checked').value;
            const categoryObj = categories.find(c => c.id === selectedCatId);
            const rating = parseFloat(document.getElementById('ratingSlider').value) || 0;
            
            // ì´ë¯¸ì§€ URL ìˆ˜ì§‘
            const images = [];
            const img1 = document.getElementById('imgUrl1').value.trim();
            const img2 = document.getElementById('imgUrl2').value.trim();
            const img3 = document.getElementById('imgUrl3').value.trim();
            if(img1) images.push(img1);
            if(img2) images.push(img2);
            if(img3) images.push(img3);

            let picker = 'common';
            const checkedPicker = document.querySelector('input[name="picker"]:checked');
            if (checkedPicker) picker = checkedPicker.value;

            let time = '', depTime = '', arrTime = '', checkIn = '', checkOut = '';
            if(selectedCatId === 'flight') {
                depTime = document.getElementById('addDepTime')?.value || '';
                arrTime = document.getElementById('addArrTime')?.value || '';
                time = depTime; 
            } else if(selectedCatId === 'hotel') {
                checkIn = document.getElementById('addCheckIn')?.value || '';
                checkOut = document.getElementById('addCheckOut')?.value || '';
                time = checkIn; 
            } else {
                time = document.getElementById('addTime')?.value || '';
            }

            let moveType = 'walk';
            let moveCost = 0;
            if(selectedCatId !== 'flight') {
                const moveTypeInput = document.querySelector('input[name="moveType"]:checked');
                if(moveTypeInput) {
                    moveType = moveTypeInput.value;
                    if(moveType !== 'walk') {
                        moveCost = parseInt(document.getElementById('addMoveCost').value) || 0;
                    }
                }
            }

            const costInput = document.getElementById('addCost');
            let costJPY = 0;
            if (costInput && costInput.value) {
                const val = parseInt(costInput.value) || 0;
                if (window.currentCurrency === 'JPY') costJPY = val;
                else if (window.currentCurrency === 'KRW') costJPY = Math.round(val / EXCHANGE_RATE);
                else if (window.currentCurrency === 'USD') costJPY = Math.round(val / EXCHANGE_RATE_USD);
            }

            const menu = document.getElementById('addMenu')?.value || '';
            const isReserved = document.getElementById('addReserved')?.checked || false;
            const flightNum = document.getElementById('addFlightNum')?.value || '';

            if(!place) return alert("ì¥ì†Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");

            const docData = {
                place, time, memo, address,
                category: selectedCatId,
                categoryIcon: categoryObj.icon,
                picker, 
                cost: costJPY, 
                moveType, moveCost, 
                depTime, arrTime, 
                checkIn, checkOut, 
                menu, isReserved, flightNum,
                rating, images, 
                updatedAt: new Date().toISOString()
            };

            if(!editingId) {
                // ì „ì²´ ì¼ì • ëª¨ë“œì—ì„œ ì¶”ê°€í•  ê²½ìš° ê¸°ë³¸ê°’ì€ 1ì¼ì°¨ë¡œ ì„¤ì • (ì‚¬ìš©ìê°€ ì‹ ê²½ì¨ì•¼ í•¨)
                // í•˜ì§€ë§Œ currentDayê°€ 'all'ì¼ ë•ŒëŠ” 1ë¡œ ê°•ì œí•˜ê±°ë‚˜, Day ì„ íƒ ê¸°ëŠ¥ì„ ì¶”ê°€í•´ì•¼ í•¨. 
                // í˜„ì¬ UIìƒ íƒ­ì„ 'all'ë¡œ ë‘” ìƒíƒœì—ì„œ ì¶”ê°€í•˜ë©´ currentDay='all'ì´ ë“¤ì–´ê°ˆ ìˆ˜ ìˆìŒ -> ì˜¤ë¥˜ ê°€ëŠ¥ì„±
                // ì•ˆì „ì¥ì¹˜: currentDayê°€ 'all'ì´ë©´ 1ë¡œ ì„¤ì •
                docData.day = (currentDay === 'all') ? 1 : currentDay;
                docData.createdAt = new Date().toISOString();
            }

            if(tempLatLng && selectedCatId !== 'flight') {
                docData.lat = tempLatLng.lat;
                docData.lng = tempLatLng.lng;
            }

            try {
                const collectionName = isCandidateMode ? 'candidates' : 'itineraries';
                const colRef = collection(db, 'trips', appId, collectionName);

                if (editingId) {
                    await updateDoc(doc(colRef, editingId), docData);
                } else {
                    await addDoc(colRef, docData);
                }
                
                window.closeAddScheduleModal();
            } catch (e) { 
                console.error(e); 
                alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); 
            }
        };

        window.searchAddress = async () => {
            const query = document.getElementById('searchAddressInput').value;
            if(!query) return alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1`);
                const data = await res.json();
                
                if(data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    
                    if (Number.isFinite(lat) && Number.isFinite(lon)) {
                        map.setView([lat, lon], 16);
                        tempLatLng = { lat, lng: lon };
                        
                        document.getElementById('addPlace').value = query; 
                        document.getElementById('addAddress').value = result.display_name;
                        updateMapWeather(lat, lon);
                    }
                } else { 
                    alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì£¼ì†Œê°€ ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”."); 
                }
            } catch(e) { console.error(e); alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }
        };

        window.updateDynamicFields = (catId) => {
             const container = document.getElementById('dynamicFields');
             const timeSection = document.getElementById('timeSection');
             const transportSection = document.getElementById('transportSection');
             container.innerHTML = ''; container.classList.remove('hidden'); transportSection.classList.remove('hidden');
             
             timeSection.innerHTML = `<label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì‹œê°„</label><input type="time" id="addTime" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white">`;

             const getCostInput = (label = 'ì˜ˆìƒ ë¹„ìš©') => `
                <div class="bg-white p-3 rounded-lg border border-indigo-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-slate-600">${label}</label>
                        <div class="flex bg-slate-100 rounded-md p-0.5">
                            <button type="button" onclick="setCurrency('JPY')" id="btn-JPY" class="px-2 py-0.5 text-[10px] font-bold rounded ${window.currentCurrency==='JPY'?'bg-white shadow text-indigo-600':'text-slate-400'}">JPY</button>
                            <button type="button" onclick="setCurrency('KRW')" id="btn-KRW" class="px-2 py-0.5 text-[10px] font-bold rounded ${window.currentCurrency==='KRW'?'bg-white shadow text-indigo-600':'text-slate-400'}">KRW</button>
                            <button type="button" onclick="setCurrency('USD')" id="btn-USD" class="px-2 py-0.5 text-[10px] font-bold rounded ${window.currentCurrency==='USD'?'bg-white shadow text-indigo-600':'text-slate-400'}">USD</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-bold text-slate-400 w-4 text-center" id="currencySymbol">Â¥</span>
                        <input type="number" id="addCost" oninput="calcConversion(this.value)" class="flex-1 p-1 bg-transparent border-b border-slate-200 text-sm font-bold text-right focus:outline-none focus:border-indigo-500" placeholder="0">
                    </div>
                    <div class="text-right text-xs text-indigo-500 font-bold mt-1" id="convertedPreview">â‰ˆ 0ì›</div>
                </div>`;

             if(catId === 'flight') {
                 transportSection.classList.add('hidden');
                 timeSection.innerHTML = `<div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì¶œë°œ</label><input type="time" id="addDepTime" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white"></div><div><label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ë„ì°©</label><input type="time" id="addArrTime" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white"></div></div>`;
                 container.innerHTML = `<div class="mb-3"><label class="block text-[10px] font-bold text-slate-500 mb-1">í¸ëª…</label><input type="text" id="addFlightNum" class="w-full p-2 border border-slate-200 rounded-lg text-sm bg-white" placeholder="KE123"></div>${getCostInput('í•­ê³µê¶Œ ë¹„ìš©')}`;
             } else if(catId === 'hotel') {
                 timeSection.innerHTML = `<div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì²´í¬ì¸</label><input type="time" id="addCheckIn" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white"></div><div><label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì²´í¬ì•„ì›ƒ</label><input type="time" id="addCheckOut" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white"></div></div>`;
                 container.innerHTML = `<div class="flex items-center justify-between mb-3 bg-white p-3 rounded-lg border border-indigo-100 shadow-sm"><span class="text-xs font-bold text-slate-600">ì˜ˆì•½</span><div class="relative inline-block w-10 h-5 align-middle select-none"><input type="checkbox" name="toggle" id="addReserved" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300"/><label for="addReserved" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer transition-all duration-300"></label></div></div>${getCostInput('ìˆ™ë°•ë¹„')}`;
             } else if(catId === 'food' || catId === 'cafe') {
                 container.innerHTML = `<div class="mb-2"><label class="block text-xs font-bold text-slate-600 mb-1">ì¶”ì²œ ë©”ë‰´</label><input type="text" id="addMenu" class="w-full p-2 border border-slate-200 rounded text-sm bg-white" placeholder="ì˜ˆ: íˆì¸ ë§ˆë¶€ì‹œ"></div>${getCostInput('ì˜ˆìƒ ì‹ë¹„')}`;
             } else if(catId === 'attraction') {
                 container.innerHTML = getCostInput('ì…ì¥ë£Œ');
             } else if(['mart', 'convenience', 'etc', 'bank'].includes(catId)) {
                 container.innerHTML = getCostInput('ì˜ˆìƒ ë¹„ìš©');
             } else {
                 container.classList.add('hidden');
             }
        };

        window.toggleTransportCost = (show) => { const f=document.getElementById('moveCostField'); if(show){f.classList.remove('hidden');}else{f.classList.add('hidden');} };
        
        window.setCurrency = (curr) => { 
            window.currentCurrency = curr; 
            document.getElementById('btn-JPY').className = `px-2 py-0.5 text-[10px] font-bold rounded ${curr==='JPY'?'bg-white shadow text-indigo-600':'text-slate-400'}`; 
            document.getElementById('btn-KRW').className = `px-2 py-0.5 text-[10px] font-bold rounded ${curr==='KRW'?'bg-white shadow text-indigo-600':'text-slate-400'}`; 
            document.getElementById('btn-USD').className = `px-2 py-0.5 text-[10px] font-bold rounded ${curr==='USD'?'bg-white shadow text-indigo-600':'text-slate-400'}`; 
            
            let symbol = 'Â¥';
            if(curr === 'KRW') symbol = 'â‚©';
            if(curr === 'USD') symbol = '$';
            document.getElementById('currencySymbol').innerText = symbol; 
            
            const val = document.getElementById('addCost').value; 
            if(val) window.calcConversion(val); 
        };
        
        window.calcConversion = (val) => { 
            if(!val){ document.getElementById('convertedPreview').innerText=''; return; } 
            
            let jpy = 0;
            if(window.currentCurrency === 'JPY') jpy = val;
            else if(window.currentCurrency === 'KRW') jpy = val / EXCHANGE_RATE;
            else if(window.currentCurrency === 'USD') jpy = val / EXCHANGE_RATE_USD;

            let krw = Math.round(jpy * EXCHANGE_RATE);
            let usd = (jpy * EXCHANGE_RATE_USD).toFixed(2);
            let jpyDisp = Math.round(jpy);

            if(window.currentCurrency === 'JPY') {
                document.getElementById('convertedPreview').innerText = `â‰ˆ ${krw.toLocaleString()}ì› / $${usd}`;
            } else if(window.currentCurrency === 'KRW') {
                document.getElementById('convertedPreview').innerText = `â‰ˆ ${jpyDisp.toLocaleString()}ì—” / $${usd}`;
            } else {
                document.getElementById('convertedPreview').innerText = `â‰ˆ ${jpyDisp.toLocaleString()}ì—” / ${krw.toLocaleString()}ì›`;
            }
        };

        async function updateMapWeather(lat, lng) { try{const res=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);const data=await res.json();if(data&&data.current_weather){document.getElementById('weatherTemp').innerText=`${data.current_weather.temperature}Â°C`;document.getElementById('weatherDesc').innerText=getWeatherIcon(data.current_weather.weathercode).desc;document.getElementById('weatherIcon').innerHTML=getWeatherIcon(data.current_weather.weathercode).icon;}}catch(e){} }
        function getWeatherIcon(code) { if(code===0)return{icon:'<i class="fa-solid fa-sun text-orange-400"></i>',desc:'ë§‘ìŒ'}; return{icon:'<i class="fa-solid fa-cloud text-slate-400"></i>',desc:'íë¦¼'}; }

        function updateAdminUI() {
            const isHidden = !isAdmin;
            document.getElementById('authStatus').classList.toggle('hidden', isHidden);
            document.getElementById('loginBtn').classList.toggle('hidden', !isHidden);
            document.getElementById('logoutBtn').classList.toggle('hidden', isHidden);
            document.getElementById('quickControls').classList.toggle('hidden', isHidden); 
            document.getElementById('adminSuggestionBtn').classList.toggle('hidden', isHidden);
        }

        window.toggleLoginModal = () => document.getElementById('loginModal').classList.toggle('hidden');
        window.checkPassword = () => {
            if(document.getElementById('passwordInput').value === 'rlarlqja01!') {
                grantAdminAccess();
                localStorage.setItem('travel_admin', 'true');
                window.toggleLoginModal();
            } else { alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜"); }
        };
        
        window.logout = () => {
            if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('travel_admin');
                location.reload();
            }
        };
        
        function grantAdminAccess() { isAdmin = true; updateAdminUI(); subscribeToItinerary(); subscribeToCandidates(); }

        // --- íŒì—… ì´ë¯¸ì§€ ì œì–´ í•¨ìˆ˜ ---
        window.changePopupImage = (itemId, direction) => {
            const item = window.tripItems.find(i => i.id === itemId) || window.candidateItems.find(i => i.id === itemId);
            if (!item || !item.images || item.images.length === 0) return;

            if (!window.popupImageStates[itemId]) window.popupImageStates[itemId] = 0;
            
            let newIndex = window.popupImageStates[itemId] + direction;
            if (newIndex < 0) newIndex = item.images.length - 1;
            if (newIndex >= item.images.length) newIndex = 0;
            
            window.popupImageStates[itemId] = newIndex;
            
            const imgEl = document.getElementById(`popup-img-${itemId}`);
            if (imgEl) imgEl.src = item.images[newIndex];
        };

        function generatePopupContent(item) {
             const catObj = categories.find(c => c.id === item.category) || categories.find(c => c.id === 'etc');
             let starHtml = '';
             if (item.rating > 0) {
                 starHtml = `<div class="text-amber-400 text-sm mb-1"><i class="fa-solid fa-star mr-1"></i>${item.rating.toFixed(1)}</div>`;
             }

             // ì´ë¯¸ì§€ ìºëŸ¬ì…€ HTML ìƒì„±
             let imageHtml = '';
             if (item.images && item.images.length > 0) {
                 const currentIdx = window.popupImageStates[item.id] || 0;
                 imageHtml = `
                    <div class="relative w-full h-32 mb-2 bg-slate-100 rounded-lg overflow-hidden group">
                        <img src="${item.images[currentIdx]}" id="popup-img-${item.id}" class="w-full h-full object-cover">
                        ${item.images.length > 1 ? `
                        <button onclick="window.changePopupImage('${item.id}', -1)" class="absolute left-1 top-1/2 transform -translate-y-1/2 carousel-btn"><i class="fa-solid fa-chevron-left"></i></button>
                        <button onclick="window.changePopupImage('${item.id}', 1)" class="absolute right-1 top-1/2 transform -translate-y-1/2 carousel-btn"><i class="fa-solid fa-chevron-right"></i></button>
                        ` : ''}
                    </div>
                 `;
             }

             return `
                <div class="text-center p-3 font-sans w-[250px]">
                    ${imageHtml}
                    <div class="text-2xl mb-1">${item.categoryIcon || catObj.icon}</div>
                    <h3 class="font-bold mb-1 text-slate-800 text-base leading-tight">${item.place}</h3>
                    ${starHtml}
                    ${item.memo ? `<p class="text-xs text-slate-500 mt-1 line-clamp-2">${item.memo}</p>` : ''}
                </div>`;
        }

        function subscribeToItinerary() {
            if (window.unsub) window.unsub();
            const colRef = collection(db, 'trips', appId, 'itineraries');
            
            window.unsub = onSnapshot(colRef, (snapshot) => {
                try {
                    const listContainer = document.getElementById('itineraryList');
                    listContainer.innerHTML = '';
                    markersLayer.clearLayers();
                    pathLayer.clearLayers(); 
                    
                    const items = [];
                    snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                    window.tripItems = items; 

                    // ì „ì²´ ì¼ì • ëª¨ë“œ vs ë‹¨ì¼ ì¼ì • ëª¨ë“œ ë¶„ê¸°
                    if (currentDay === 'all') {
                        let totalCostAllDays = 0;
                        let allPathPoints = [];

                        // 1ì¼ì°¨ë¶€í„° ë§ˆì§€ë§‰ ë‚ ê¹Œì§€ ìˆœíšŒ
                        for (let d = 1; d <= totalDays; d++) {
                            const dayItems = items.filter(item => item.day === d);
                            // ì‹œê°„ìˆœ ì •ë ¬ (Flight/Hotel ìš°ì„  ë“± ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                            const sortedItems = dayItems.sort((a, b) => {
                                // Flight/Hotel ë¨¼ì €, ê·¸ ë‹¤ìŒ ì‹œê°„ìˆœ
                                const isFixedA = a.category === 'flight' || a.category === 'hotel';
                                const isFixedB = b.category === 'flight' || b.category === 'hotel';
                                if(isFixedA && !isFixedB) return -1;
                                if(!isFixedA && isFixedB) return 1;
                                return (a.time || '23:59').localeCompare(b.time || '23:59');
                            });

                            if (sortedItems.length > 0) {
                                // Day Header ì¶”ê°€
                                const dayHeader = document.createElement('div');
                                dayHeader.className = 'sticky top-0 bg-slate-100/90 backdrop-blur z-10 py-2 px-3 text-xs font-bold text-slate-500 uppercase tracking-wide border-y border-slate-200 mb-3';
                                dayHeader.innerText = `Day ${d}`;
                                listContainer.appendChild(dayHeader);

                                sortedItems.forEach(item => {
                                    // ë¹„ìš© í•©ì‚°
                                    totalCostAllDays += (item.cost || 0) + (item.moveCost || 0);

                                    // ë§ˆì»¤ ë° ê²½ë¡œ ë°ì´í„° ìˆ˜ì§‘
                                    const lat = parseFloat(item.lat);
                                    const lng = parseFloat(item.lng);
                                    if(Number.isFinite(lat) && Number.isFinite(lng)) {
                                        allPathPoints.push({lat, lng});
                                        // ë§ˆì»¤ ë Œë”ë§ (ê¸°ì¡´ ë¡œì§ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ë‚˜ ê°„ë‹¨í•˜ê²Œ êµ¬í˜„)
                                        renderMarkerOnMap(item);
                                    }
                                    // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ë Œë”ë§
                                    renderListItem(item, listContainer);
                                });
                            }
                        }

                        // ì „ì²´ ê²½ë¡œ ê·¸ë¦¬ê¸° (ì„ ëª…í•œ ì„ )
                        if (allPathPoints.length > 1) {
                            L.polyline(allPathPoints, {
                                color: '#6366f1', // Indigo-500
                                weight: 4,        // êµµê²Œ
                                opacity: 0.8,     // ì„ ëª…í•˜ê²Œ
                                lineCap: 'round',
                                lineJoin: 'round'
                            }).addTo(pathLayer);
                            
                            // ì „ì²´ ê²½ë¡œê°€ ë³´ì´ë„ë¡ ì¤Œ ì¡°ì •
                            const bounds = L.latLngBounds(allPathPoints);
                            map.fitBounds(bounds, { padding: [50, 50] });
                        }

                        // ë¹„ìš© ìš”ì•½ ì—…ë°ì´íŠ¸
                        document.getElementById('dailySummary').classList.remove('hidden');
                        document.getElementById('dailyTotalJPY').innerText = `Â¥${totalCostAllDays.toLocaleString()}`;
                        const totalKRW = Math.round(totalCostAllDays * EXCHANGE_RATE).toLocaleString();
                        document.getElementById('dailyTotalKRW').innerText = `â‰ˆ ${totalKRW}ì› (ì „ì²´ ì¼ì •)`;

                    } else {
                        // ê¸°ì¡´ ë‹¨ì¼ Day ë¡œì§
                        const dayItems = items.filter(item => item.day === currentDay);
                        const fixedItems = dayItems.filter(item => item.category === 'flight' || item.category === 'hotel')
                                                   .sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
                        const timelineItems = dayItems.filter(item => item.category !== 'flight' && item.category !== 'hotel')
                                                      .sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));

                        let totalDailyCost = 0;
                        let pathPoints = []; 

                        if (dayItems.length === 0) {
                            listContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-64 text-slate-300"><i class="fa-regular fa-map text-4xl mb-3"></i><p class="text-sm">ì¼ì •ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p></div>';
                            document.getElementById('dailySummary').classList.add('hidden');
                        } else {
                            document.getElementById('dailySummary').classList.remove('hidden');
                            if (isFirstLoad) {
                                const firstTarget = timelineItems[0] || fixedItems[0];
                                if (firstTarget) {
                                    const tLat = parseFloat(firstTarget.lat);
                                    const tLng = parseFloat(firstTarget.lng);
                                    if (Number.isFinite(tLat) && Number.isFinite(tLng)) {
                                        try {
                                            map.flyTo([tLat, tLng], 14, { duration: 1.5 });
                                            isFirstLoad = false;
                                        } catch (e) {
                                            isFirstLoad = false;
                                        }
                                    }
                                }
                            }
                        }

                        // í†µí•© ë Œë”ë§ í•¨ìˆ˜ ì‚¬ìš©
                        fixedItems.forEach(item => {
                            totalDailyCost += (item.cost || 0) + (item.moveCost || 0);
                            renderMarkerOnMap(item);
                            renderListItem(item, listContainer);
                            
                            const lat = parseFloat(item.lat);
                            const lng = parseFloat(item.lng);
                            if(Number.isFinite(lat) && Number.isFinite(lng)) pathPoints.push({lat, lng, moveType: 'walk'}); // Fixed items default walk for path logic
                        });

                        timelineItems.forEach(item => {
                            totalDailyCost += (item.cost || 0) + (item.moveCost || 0);
                            renderMarkerOnMap(item);
                            renderListItem(item, listContainer);

                            const lat = parseFloat(item.lat);
                            const lng = parseFloat(item.lng);
                            if(Number.isFinite(lat) && Number.isFinite(lng)) pathPoints.push({lat, lng, moveType: item.moveType || 'walk'});
                        });

                        document.getElementById('dailyTotalJPY').innerText = `Â¥${totalDailyCost.toLocaleString()}`;
                        const totalKRW = Math.round(totalDailyCost * EXCHANGE_RATE).toLocaleString();
                        document.getElementById('dailyTotalKRW').innerText = `â‰ˆ ${totalKRW}ì›`;

                        if (pathPoints.length > 1) {
                            for (let i = 0; i < pathPoints.length - 1; i++) {
                                const start = pathPoints[i];
                                const end = pathPoints[i+1];
                                const color = end.moveType === 'bus' ? '#6366f1' : (end.moveType === 'subway' ? '#10b981' : '#94a3b8');
                                L.polyline([[start.lat, start.lng], [end.lat, end.lng]], {
                                    color: color, weight: 4, opacity: 0.8, dashArray: end.moveType === 'walk' ? '5, 10' : null, lineCap: 'round'
                                }).addTo(pathLayer);
                            }
                        }
                    }

                } catch(err) {
                    console.error("Snapshot Error:", err);
                }
            });
        }

        // Helper: ì§€ë„ì— ë§ˆì»¤ ì°ê¸°
        function renderMarkerOnMap(item) {
            const catObj = categories.find(c => c.id === item.category) || categories.find(c => c.id === 'etc');
            const isFlight = item.category === 'flight';
            const isHotel = item.category === 'hotel';
            const itemLat = parseFloat(item.lat);
            const itemLng = parseFloat(item.lng);

            if (Number.isFinite(itemLat) && Number.isFinite(itemLng)) {
                const markerColor = isFlight ? '#6366f1' : (isHotel ? '#2563eb' : '#ffffff');
                const markerIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: ${markerColor}; border: 2px solid white; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.2); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 20px;">${item.categoryIcon || catObj.icon}</div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20],
                    popupAnchor: [0, -20]
                });
                const marker = L.marker([itemLat, itemLng], {icon: markerIcon}).addTo(markersLayer);
                marker.bindPopup(generatePopupContent(item), { className: 'rounded-xl shadow-xl border-0' });
            }
        }

        // Helper: ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ë Œë”ë§
        function renderListItem(item, container) {
            const catObj = categories.find(c => c.id === item.category) || categories.find(c => c.id === 'etc');
            const isFixed = item.category === 'flight' || item.category === 'hotel';
            const isFlight = item.category === 'flight';
            const isHotel = item.category === 'hotel';

            let cardClasses = 'p-4 rounded-xl border shadow-sm transition group relative mb-3';
            let bgClass = 'bg-white';
            let borderClass = 'border-slate-200';
            let pickBadge = '';

            if (item.picker === 'juice') {
                bgClass = 'bg-orange-50';
                borderClass = 'border-orange-200';
                pickBadge = `<span class="text-[8px] font-bold text-orange-600 bg-white/80 px-1.5 py-0.5 rounded border border-orange-100 shadow-sm mr-1">Juice's Pick</span>`;
            } else if (item.picker === 'yumin') {
                bgClass = 'bg-indigo-50';
                borderClass = 'border-indigo-200';
                pickBadge = `<span class="text-[8px] font-bold text-indigo-600 bg-white/80 px-1.5 py-0.5 rounded border border-indigo-100 shadow-sm mr-1">Yumin's Pick</span>`;
            }

            if (isFixed) {
                 if (isFlight) {
                     bgClass = 'bg-indigo-50/60'; borderClass = 'border-indigo-200';
                 } else if (isHotel) {
                     bgClass = 'bg-blue-50/60'; borderClass = 'border-blue-200';
                 }
                 cardClasses += ` ${bgClass} ${borderClass}`;
            } else {
                cardClasses += ` timeline-item pl-16 hover:shadow-md ${bgClass} ${borderClass}`;
            }
            
            const el = document.createElement('div');
            el.className = cardClasses;
            const itemLat = parseFloat(item.lat);
            const itemLng = parseFloat(item.lng);
            const hasLocation = Number.isFinite(itemLat) && Number.isFinite(itemLng);
            el.onclick = () => { if(hasLocation) map.flyTo([itemLat, itemLng], 16); };
            
            let editBtn = '';
            if (isAdmin) {
                editBtn = `
                <div class="absolute top-6 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition z-20">
                    <button onclick="event.stopPropagation(); window.editItem('${item.id}')" class="text-slate-400 hover:text-indigo-500 p-1"><i class="fa-solid fa-pen"></i></button>
                    <button onclick="event.stopPropagation(); window.deleteItem('${item.id}')" class="text-slate-400 hover:text-rose-500 p-1"><i class="fa-solid fa-trash-can"></i></button>
                </div>`;
            }

            let pinBadge = '';
            if (isFixed) {
                pinBadge = `<div class="absolute -top-2 -right-2 bg-white text-indigo-500 w-7 h-7 flex items-center justify-center rounded-full border border-indigo-100 shadow-sm z-20" title="Fixed Schedule"><i class="fa-solid fa-thumbtack transform rotate-45 text-xs"></i></div>`;
            }

            let timeDisplay = item.time || '';
            if (isFlight) timeDisplay = `${item.depTime || '?'} <i class="fa-solid fa-arrow-right text-[10px] mx-1"></i> ${item.arrTime || '?'}`;
            else if (isHotel) timeDisplay = `In ${item.checkIn || '-'} / Out ${item.checkOut || '-'}`;

            let costDisplay = '';
            const totalItemCost = (item.cost || 0);
            if (totalItemCost > 0) {
                const krw = Math.round(totalItemCost * EXCHANGE_RATE).toLocaleString();
                costDisplay = `<span class="text-indigo-600 font-bold text-sm bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100">Â¥${totalItemCost.toLocaleString()} <span class="text-[10px] text-slate-400 font-normal">(ì•½ ${krw}ì›)</span></span>`;
            }
            if(item.moveCost > 0) {
                const mKrw = Math.round(item.moveCost * EXCHANGE_RATE).toLocaleString();
                costDisplay += `<div class="text-[10px] text-slate-400 mt-0.5 ml-1"><i class="fa-solid fa-ticket mr-1"></i>ì´ë™: Â¥${item.moveCost} (${mKrw}ì›)</div>`;
            }

            let tags = '';
            if (item.menu) tags += `<span class="bg-orange-50 text-orange-600 px-1.5 py-0.5 rounded text-[10px] border border-orange-100 font-medium">ğŸ½ï¸ ${item.menu}</span> `;
            if (isHotel) {
                tags += item.isReserved 
                    ? `<span class="bg-emerald-50 text-emerald-600 px-1.5 py-0.5 rounded text-[10px] border border-emerald-100 font-bold">âœ… ì˜ˆì•½í™•ì •</span> ` 
                    : `<span class="bg-rose-50 text-rose-600 px-1.5 py-0.5 rounded text-[10px] border border-rose-100 font-bold">â³ ë¯¸ì˜ˆì•½</span> `;
            }
            if (item.flightNum) tags += `<span class="bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded text-[10px] border border-indigo-100 font-bold">âœˆï¸ ${item.flightNum}</span> `;
            if (item.rating > 0) tags += `<span class="text-amber-400 text-[10px] font-bold"><i class="fa-solid fa-star"></i> ${item.rating.toFixed(1)}</span>`;

            let moveIcon = '';
            if(!isFixed && !isFlight) { 
                if(item.moveType === 'bus') moveIcon = '<i class="fa-solid fa-bus text-indigo-500 mr-1"></i>';
                else if(item.moveType === 'subway') moveIcon = '<i class="fa-solid fa-train-subway text-emerald-500 mr-1"></i>';
                else moveIcon = '<i class="fa-solid fa-person-walking text-slate-400 mr-1"></i>';
            }

            el.innerHTML = `
                ${pinBadge}
                <div class="${isFixed ? 'text-xl z-10 w-10 h-10 flex items-center justify-center bg-white rounded-full border border-white shadow-md mb-2' : 'text-xl z-10 w-9 h-9 flex items-center justify-center bg-white rounded-full border border-slate-100 shadow-sm absolute left-3 top-4'}">${item.categoryIcon || catObj.icon}</div>
                <div class="${isFixed ? 'flex flex-col' : ''}">
                    <div class="flex justify-between items-start mb-1 w-full gap-2">
                        <h4 class="font-bold text-slate-800 text-base flex-1 leading-tight ${isFlight ? 'text-indigo-800' : ''} ${isHotel ? 'text-blue-800' : ''}">${item.place}</h4>
                        <span class="text-xs font-bold bg-white/80 border border-slate-100 text-slate-600 px-2 py-1 rounded-lg shadow-sm whitespace-nowrap shrink-0 ml-auto">${timeDisplay || '-'}</span>
                    </div>
                    <p class="text-xs text-slate-400 truncate">${item.address || ''}</p>
                    ${moveIcon ? `<div class="text-[10px] text-slate-500 mb-1 flex items-center bg-slate-50 inline-block px-1.5 rounded border border-slate-100 w-fit mt-1">${moveIcon} ì´ë™</div>` : ''}
                    <div class="flex flex-wrap gap-1 mb-1 items-center">
                        ${pickBadge}
                        ${tags}
                    </div>
                    ${costDisplay ? `<div class="flex flex-col mt-1">${costDisplay}</div>` : ''}
                    ${item.memo ? `<p class="text-sm text-slate-600 mt-2 bg-slate-50/50 p-2 rounded-lg border border-slate-100/50">${item.memo}</p>` : ''}
                </div>
                ${editBtn}
            `;
            container.appendChild(el);
        }

        document.getElementById('openSidebar').onclick = () => document.getElementById('sidebar').classList.remove('-translate-x-full');
        document.getElementById('closeSidebarMobile').onclick = () => document.getElementById('sidebar').classList.add('-translate-x-full');
        
        function setupEventListeners() {
            document.addEventListener('keydown', (e) => { 
                if(e.key === "Escape") { 
                    document.getElementById('loginModal').classList.add('hidden');
                    window.closeSuggestionModal();
                    window.closeAddScheduleModal();
                    window.closeAdminSuggestionBox();
                    window.closeWeatherForecastModal();
                    document.getElementById('currentWeatherModal').classList.add('hidden');
                }
            });
        }
    </script>
</body>
</html>
