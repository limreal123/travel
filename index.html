<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ê³ ì•¼ ì—¬í–‰ ì¼ì •</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .map-container { z-index: 1; }
        .sidebar { z-index: 20; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Category Radio Styling */
        .category-radio:checked + label {
            background-color: #EEF2FF;
            border-color: #6366f1;
            color: #4f46e5;
            font-weight: bold;
        }

        /* Custom Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }
    </style>
</head>
<body class="h-screen w-screen flex overflow-hidden bg-gray-50">

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar w-full md:w-[400px] h-full bg-white flex flex-col border-r border-gray-200 shrink-0 absolute md:relative transition-all duration-300 transform -translate-x-full md:translate-x-0" id="sidebar">
        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-indigo-600 text-white">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-map-location-dot mr-2"></i>ë‚˜ê³ ì•¼ ì—¬í–‰ ì¼ì •</h1>
            <button id="closeSidebarMobile" class="md:hidden"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <!-- Day íƒ­ -->
        <div class="flex overflow-x-auto p-2 bg-indigo-50 space-x-2 scrollbar-hide shrink-0" id="dayTabs"></div>

        <!-- í•­ê³µí¸ ë¹ ë¥¸ ì¶”ê°€ ë²„íŠ¼ -->
        <div id="flightControls" class="px-4 pt-2 hidden">
            <button onclick="openFlightModal()" class="w-full py-2 bg-sky-50 text-sky-600 border border-sky-200 rounded-lg text-sm font-bold hover:bg-sky-100 transition flex items-center justify-center">
                <i class="fa-solid fa-plane-up mr-2"></i>í•­ê³µí¸ ë“±ë¡í•˜ê¸°
            </button>
        </div>

        <!-- ì¼ì • ë¦¬ìŠ¤íŠ¸ -->
        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="itineraryList">
            <div class="text-center text-gray-400 mt-10"><p>ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
        </div>

        <!-- ë³´ê¸° ì „ìš© ë©”ì‹œì§€ / ê´€ë¦¬ì ì•ˆë‚´ -->
        <div id="statusMessage" class="p-4 border-t border-gray-200 bg-gray-50 text-center shrink-0">
            <p class="text-xs text-gray-500"><i class="fa-solid fa-circle-info mr-1"></i>ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì¥ì†Œë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>
        </div>
    </div>

    <!-- ë©”ì¸ ì§€ë„ ì˜ì—­ -->
    <div class="flex-1 relative h-full w-full">
        <!-- ëª¨ë°”ì¼ ë©”ë‰´ ë²„íŠ¼ -->
        <button id="openSidebar" class="absolute top-4 left-4 z-[999] md:hidden bg-white p-3 rounded-full shadow-lg text-indigo-600">
            <i class="fa-solid fa-bars"></i>
        </button>

        <!-- ìš°ì¸¡ ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
        <div class="absolute top-4 right-4 z-[999] flex flex-col space-y-2 items-end">
            <div id="authStatus" class="hidden bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold shadow-md mb-2 animate-pulse">
                <i class="fa-solid fa-user-shield mr-1"></i>ê´€ë¦¬ì ëª¨ë“œ ON
            </div>
            <div class="flex space-x-2">
                <button onclick="openSuggestionModal()" class="bg-white hover:bg-gray-50 text-gray-800 px-4 py-2 rounded-lg shadow-lg font-bold text-sm transition flex items-center">
                    <i class="fa-regular fa-lightbulb mr-2 text-yellow-500"></i>ì¥ì†Œ ì¶”ì²œ
                </button>
                <button id="adminSuggestionBtn" onclick="openAdminSuggestionBox()" class="hidden bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-lg font-bold text-sm transition flex items-center">
                    <i class="fa-solid fa-envelope mr-2"></i>ê±´ì˜í•¨
                </button>
                <button onclick="toggleLoginModal()" id="loginBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow-lg font-bold text-sm transition flex items-center">
                    <i class="fa-solid fa-key mr-2"></i>ê´€ë¦¬ì
                </button>
                <button onclick="logout()" id="logoutBtn" class="hidden bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg shadow-lg font-bold text-sm transition">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
            <!-- ê´€ë¦¬ììš© íŒíŠ¸ -->
            <div id="adminHint" class="hidden bg-white/90 backdrop-blur px-3 py-2 rounded-lg shadow text-xs text-gray-600 mt-2">
                <i class="fa-solid fa-mouse-pointer mr-1"></i>ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ìƒì„¸ ë“±ë¡
            </div>
        </div>
        <div id="map" class="w-full h-full z-0"></div>
    </div>

    <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-80 fade-in">
            <h2 class="text-lg font-bold mb-4 text-center">ğŸ” ê´€ë¦¬ì ì ‘ì†</h2>
            <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" class="w-full p-3 border rounded-lg mb-4" onkeyup="if(window.event.keyCode==13){checkPassword()}">
            <div class="flex space-x-2">
                <button onclick="toggleLoginModal()" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-700 font-bold hover:bg-gray-300">ì·¨ì†Œ</button>
                <button onclick="checkPassword()" class="flex-1 py-2 bg-indigo-600 rounded-lg text-white font-bold hover:bg-indigo-700">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- ì¶”ì²œ ëª¨ë‹¬ (ì‚¬ìš©ììš©) -->
    <div id="suggestionModal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-96 fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold"><i class="fa-regular fa-paper-plane mr-2 text-indigo-500"></i>ì—¬í–‰ì§€ ì¶”ì²œ</h2>
                <button onclick="closeSuggestionModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="space-y-3">
                <input type="text" id="sugPlace" class="w-full p-2 border rounded text-sm" placeholder="ì¶”ì²œ ì¥ì†Œ (ì˜ˆ: ë‚˜ê³ ì•¼ TV íƒ€ì›Œ)">
                <textarea id="sugReason" rows="3" class="w-full p-2 border rounded text-sm" placeholder="ì¶”ì²œ ì´ìœ "></textarea>
                <button onclick="submitSuggestion()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 rounded-lg shadow-md transition text-sm">ë³´ë‚´ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê±´ì˜í•¨ ëª¨ë‹¬ (ê´€ë¦¬ììš©) -->
    <div id="adminSuggestionBox" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-[400px] h-[500px] flex flex-col fade-in">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-inbox mr-2 text-yellow-500"></i>ë°›ì€ ê±´ì˜í•¨</h2>
                <button onclick="closeAdminSuggestionBox()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="suggestionList" class="flex-1 overflow-y-auto space-y-2 p-1">
                <div class="text-center text-gray-400 mt-10">ê±´ì˜ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- ì¼ì • ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addScheduleModal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-[400px] max-h-[90vh] overflow-y-auto fade-in m-4">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-location-dot mr-2 text-indigo-500"></i>ìƒˆ ì¼ì • ì¶”ê°€</h2>
                <button onclick="closeAddScheduleModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="space-y-4">
                <!-- ì¥ì†Œ ë° ì‹œê°„ -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì¥ì†Œëª…</label>
                    <input type="text" id="addPlace" class="w-full p-2 border border-gray-300 rounded text-sm focus:border-indigo-500 focus:outline-none" placeholder="ì˜ˆ: ë‚˜ê³ ì•¼ ì„±">
                </div>
                
                <div class="flex space-x-2">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1">ì‹œê°„</label>
                        <input type="time" id="addTime" class="w-full p-2 border border-gray-300 rounded text-sm">
                    </div>
                </div>

                <!-- ì£¼ì†Œ (ìˆ˜ì • ê°€ëŠ¥) -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì£¼ì†Œ (ìˆ˜ì • ê°€ëŠ¥)</label>
                    <div class="flex space-x-1">
                        <input type="text" id="addAddress" class="flex-1 p-2 border border-gray-300 rounded text-sm bg-white text-gray-800" placeholder="ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì§€ë„ í´ë¦­ ì‹œ ìë™ ì…ë ¥">
                        <span class="text-xs text-gray-400 flex items-center"><i class="fa-solid fa-map-pin"></i></span>
                    </div>
                </div>

                <!-- ì¹´í…Œê³ ë¦¬ ê·¸ë¦¬ë“œ -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
                    <div class="grid grid-cols-4 gap-2" id="categoryGrid">
                        <!-- JSë¡œ ìƒì„±ë¨ -->
                    </div>
                </div>

                <!-- ë™ì  í•„ë“œ (ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë‹¬ë¼ì§) -->
                <div id="dynamicFields" class="bg-gray-50 p-3 rounded-lg border border-gray-200 hidden">
                    <!-- JSë¡œ ì£¼ì…ë¨ -->
                </div>

                <!-- ë©”ëª¨ -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ë©”ëª¨</label>
                    <textarea id="addMemo" rows="2" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="ê°„ë‹¨í•œ ë©”ëª¨..."></textarea>
                </div>

                <button onclick="submitNewSchedule()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow transition">
                    ì¼ì • ì €ì¥í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import * as L from 'https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAhC1MM1KI759uNFhqyu1RNjmw0Xqez5E0",
            authDomain: "mytravelmap-4f52a.firebaseapp.com",
            projectId: "mytravelmap-4f52a",
            storageBucket: "mytravelmap-4f52a.firebasestorage.app",
            messagingSenderId: "1064774813139",
            appId: "1:1064774813139:web:29b2b9e3150fbbb2ad5b26"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        let map, markersLayer;
        let currentDay = 1;
        let isAdmin = false;
        const totalDays = 6;
        let isFirstLoad = true;
        let tempLatLng = null;

        // í™˜ìœ¨ ì„¤ì • (100ì—” = ì•½ 910ì› -> 1ì—” = 9.1ì›)
        const EXCHANGE_RATE = 9.1;

        // ì¹´í…Œê³ ë¦¬ ì •ì˜
        const categories = [
            { id: 'food', label: 'ìŒì‹ì ', icon: 'ğŸ´', color: 'text-orange-500' },
            { id: 'cafe', label: 'ì¹´í˜', icon: 'â˜•', color: 'text-amber-700' },
            { id: 'attraction', label: 'ëª…ì†Œ', icon: 'ğŸ¡', color: 'text-purple-600' },
            { id: 'hotel', label: 'ìˆ™ì†Œ', icon: 'ğŸ¨', color: 'text-blue-600' },
            { id: 'mart', label: 'ë§ˆíŠ¸', icon: 'ğŸ›’', color: 'text-green-600' },
            { id: 'convenience', label: 'í¸ì˜ì ', icon: 'ğŸª', color: 'text-blue-400' },
            { id: 'bank', label: 'ì€í–‰', icon: 'ğŸ¦', color: 'text-gray-600' },
            { id: 'flight', label: 'í•­ê³µí¸', icon: 'âœˆï¸', color: 'text-sky-500' },
            { id: 'etc', label: 'ê¸°íƒ€', icon: 'ğŸ“', color: 'text-gray-400' },
        ];

        window.onload = async () => {
            initMap();
            renderDayTabs();
            renderCategoryGrid();
            
            try {
                await signInAnonymously(auth);
                subscribeToItinerary();
            } catch (error) {
                console.error("Firebase ì¸ì¦ ì˜¤ë¥˜:", error);
                alert("ì„œë¹„ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }

            if(localStorage.getItem('travel_admin') === 'true') {
                grantAdminAccess();
            }
            updateAdminUI();
            setupEventListeners();
        };

        function initMap() {
            map = L.map('map').setView([35.1709, 136.8815], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);

            map.on('click', function(e) {
                if(!isAdmin) return;
                openAddScheduleModal(e.latlng.lat, e.latlng.lng);
            });
        }

        function renderDayTabs() {
            const container = document.getElementById('dayTabs');
            container.innerHTML = '';
            for(let i=1; i<=totalDays; i++) {
                const btn = document.createElement('button');
                btn.className = `px-4 py-2 text-sm font-bold rounded-full whitespace-nowrap transition-colors border border-transparent ${currentDay === i ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-600 hover:bg-gray-100 border-gray-200'}`;
                btn.innerText = `Day ${i}`;
                btn.onclick = () => { 
                    currentDay = i; 
                    isFirstLoad = true;
                    renderDayTabs(); 
                    subscribeToItinerary(); 
                };
                container.appendChild(btn);
            }
        }

        function renderCategoryGrid() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = categories.map(cat => `
                <div class="relative">
                    <input type="radio" name="category" id="cat_${cat.id}" value="${cat.id}" class="peer hidden category-radio" ${cat.id === 'etc' ? 'checked' : ''} onchange="updateDynamicFields(this.value)">
                    <label for="cat_${cat.id}" class="flex flex-col items-center justify-center p-2 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition h-full text-center">
                        <span class="text-xl mb-1">${cat.icon}</span>
                        <span class="text-[10px] text-gray-500 whitespace-nowrap">${cat.label}</span>
                    </label>
                </div>
            `).join('');
        }

        // ë™ì  í•„ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì „ì—­ ë“±ë¡)
        window.updateDynamicFields = (catId) => {
            const container = document.getElementById('dynamicFields');
            container.innerHTML = '';
            container.classList.remove('hidden');

            let html = '';

            // ë¹„ìš©(ì—”í™”) ì…ë ¥ í•„ë“œ (ê³µí†µìœ¼ë¡œ ì“°ì´ì§€ë§Œ ë¼ë²¨ì´ ë‹¤ë¦„)
            const getCostInput = (label = 'ì˜ˆìƒ ë¹„ìš©') => `
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">${label} (JPY)</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="addCost" oninput="convertCurrency(this.value)" class="flex-1 p-2 border border-gray-300 rounded text-sm text-right" placeholder="0">
                        <span class="text-sm font-bold">Â¥</span>
                    </div>
                    <div class="text-right text-xs text-blue-600 font-bold mt-1" id="krwPreview">â‰ˆ 0ì›</div>
                </div>
            `;

            if (catId === 'food' || catId === 'cafe') {
                html += `
                    <div class="mb-2">
                        <label class="block text-xs font-bold text-gray-600 mb-1">ì¶”ì²œ ë©”ë‰´</label>
                        <input type="text" id="addMenu" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="ì˜ˆ: íˆì¸ ë§ˆë¶€ì‹œ, ë¯¸ì†Œì¹´ì¸ ">
                    </div>
                    ${getCostInput('ì˜ˆìƒ ì‹ë¹„')}
                `;
            } else if (catId === 'attraction') {
                html += getCostInput('ì…ì¥ë£Œ');
            } else if (catId === 'hotel') {
                html += `
                    <div class="flex items-center justify-between mb-3 bg-white p-2 rounded border border-indigo-100">
                        <span class="text-xs font-bold text-gray-600">ì˜ˆì•½ ì™„ë£Œ</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="addReserved" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                            <label for="addReserved" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    ${getCostInput('ìˆ™ë°•ë¹„ (1ë°•)')}
                `;
            } else if (['mart', 'convenience', 'etc', 'flight'].includes(catId)) {
                html += getCostInput('ì˜ˆìƒ ë¹„ìš©');
            } else {
                container.classList.add('hidden'); // ì€í–‰ ë“±ì€ ë¹„ìš© í•„ë“œ í•„ìš” ì—†ì„ ìˆ˜ë„ ìˆìŒ
            }

            container.innerHTML = html;
        };

        // í™˜ìœ¨ ê³„ì‚° í•¨ìˆ˜ (ì „ì—­ ë“±ë¡)
        window.convertCurrency = (jpy) => {
            const krw = Math.round(jpy * EXCHANGE_RATE);
            document.getElementById('krwPreview').innerText = `â‰ˆ ${krw.toLocaleString()}ì›`;
        };

        window.openAddScheduleModal = async (lat, lng, isFlight = false) => {
            const modal = document.getElementById('addScheduleModal');
            
            document.getElementById('addPlace').value = isFlight ? 'ë‚˜ê³ ì•¼ ê³µí•­' : '';
            document.getElementById('addTime').value = '';
            document.getElementById('addMemo').value = '';
            document.getElementById('addAddress').value = 'ì£¼ì†Œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            
            // ê¸°ë³¸ ë™ì  í•„ë“œ ì´ˆê¸°í™” (ê¸°íƒ€)
            const defaultCat = isFlight ? 'flight' : 'etc';
            document.getElementById(`cat_${defaultCat}`).checked = true;
            window.updateDynamicFields(defaultCat);
            
            if(isFlight) {
                tempLatLng = null;
                document.getElementById('addAddress').value = '-';
            } else {
                tempLatLng = { lat, lng };
                fetchAddress(lat, lng);
            }

            modal.classList.remove('hidden');
            document.getElementById('addPlace').focus();
        };

        window.closeAddScheduleModal = () => {
            document.getElementById('addScheduleModal').classList.add('hidden');
        };

        window.openFlightModal = () => window.openAddScheduleModal(0, 0, true);

        async function fetchAddress(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                if(data && data.display_name) {
                    // ì£¼ì†Œ ì˜ë¼ì„œ ë³´ì—¬ì£¼ê¸°
                    document.getElementById('addAddress').value = data.display_name.split(',').slice(0, 3).join(', ');
                } else {
                    document.getElementById('addAddress').value = "";
                }
            } catch(e) {
                console.error(e);
                document.getElementById('addAddress').value = "";
            }
        }

        // --- ì¼ì • ì €ì¥ (í™•ì¥ëœ í•„ë“œ í¬í•¨) ---
        window.submitNewSchedule = async () => {
            if(!isAdmin) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
            
            const place = document.getElementById('addPlace').value;
            const time = document.getElementById('addTime').value;
            const memo = document.getElementById('addMemo').value;
            const address = document.getElementById('addAddress').value;
            const selectedCatId = document.querySelector('input[name="category"]:checked').value;
            const categoryObj = categories.find(c => c.id === selectedCatId);

            // ë™ì  í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
            const costInput = document.getElementById('addCost');
            const menuInput = document.getElementById('addMenu');
            const reservedInput = document.getElementById('addReserved');

            const cost = costInput ? parseInt(costInput.value) || 0 : 0;
            const menu = menuInput ? menuInput.value : '';
            const isReserved = reservedInput ? reservedInput.checked : false;

            if(!place) return alert("ì¥ì†Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");

            try {
                const docData = {
                    day: currentDay,
                    place, time, memo, address,
                    category: selectedCatId,
                    categoryIcon: categoryObj.icon,
                    cost, menu, isReserved, // ì¶”ê°€ëœ í•„ë“œë“¤
                    createdAt: new Date().toISOString()
                };

                if(tempLatLng && selectedCatId !== 'flight') {
                    docData.lat = tempLatLng.lat;
                    docData.lng = tempLatLng.lng;
                } else if(selectedCatId === 'flight' && tempLatLng && tempLatLng.lat !== 0) {
                     docData.lat = tempLatLng.lat;
                     docData.lng = tempLatLng.lng;
                }

                await addDoc(collection(db, 'trips', appId, 'itineraries'), docData);
                
                window.closeAddScheduleModal();
                showStatusMsg("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } catch (e) { 
                console.error(e); 
                alert("ì €ì¥ ì‹¤íŒ¨"); 
            }
        };

        function showStatusMsg(msg) {
            const statusMsg = document.getElementById('statusMessage');
            statusMsg.innerHTML = `<span class="text-indigo-600 font-bold"><i class="fa-solid fa-check"></i> ${msg}</span>`;
            setTimeout(() => statusMsg.innerHTML = `<p class="text-xs text-gray-500"><i class="fa-solid fa-circle-info mr-1"></i>ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì¥ì†Œë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>`, 2000);
        }

        // --- ê±´ì˜í•¨ ê´€ë¦¬ (ê´€ë¦¬ì ì „ìš©) ---
        let suggestionUnsub = null;
        window.openAdminSuggestionBox = () => {
            document.getElementById('adminSuggestionBox').classList.remove('hidden');
            if(suggestionUnsub) suggestionUnsub();
            
            const colRef = collection(db, 'trips', appId, 'suggestions');
            suggestionUnsub = onSnapshot(colRef, (snapshot) => {
                const list = document.getElementById('suggestionList');
                list.innerHTML = '';
                if(snapshot.empty) {
                    list.innerHTML = '<div class="text-center text-gray-400 mt-10">ìƒˆë¡œìš´ ê±´ì˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const el = document.createElement('div');
                    el.className = 'bg-yellow-50 p-3 rounded-lg border border-yellow-200 flex justify-between items-start';
                    el.innerHTML = `
                        <div>
                            <div class="font-bold text-gray-800 text-sm"><i class="fa-solid fa-location-dot text-yellow-500 mr-1"></i>${data.place}</div>
                            <div class="text-xs text-gray-600 mt-1">${data.reason}</div>
                            <div class="text-[10px] text-gray-400 mt-1">${new Date(data.createdAt).toLocaleDateString()}</div>
                        </div>
                        <button onclick="markAsRead('${docSnap.id}')" class="text-gray-400 hover:text-green-600 ml-2" title="ì½ìŒ(ì‚­ì œ)">
                            <i class="fa-regular fa-circle-check text-lg"></i>
                        </button>
                    `;
                    list.appendChild(el);
                });
            });
        };

        window.closeAdminSuggestionBox = () => document.getElementById('adminSuggestionBox').classList.add('hidden');
        
        window.markAsRead = async (id) => {
            if(confirm("í™•ì¸ ì²˜ë¦¬(ì‚­ì œ) í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, 'trips', appId, 'suggestions', id));
            }
        };

        // --- ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (í™•ì¥) ---
        function subscribeToItinerary() {
            if (window.unsub) window.unsub();
            const colRef = collection(db, 'trips', appId, 'itineraries');
            
            window.unsub = onSnapshot(colRef, (snapshot) => {
                const listContainer = document.getElementById('itineraryList');
                listContainer.innerHTML = '';
                markersLayer.clearLayers();
                
                const items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));

                const filteredItems = items
                    .filter(item => item.day === currentDay)
                    .sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));

                if (filteredItems.length === 0) {
                    listContainer.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-40 text-gray-400">
                            <i class="fa-regular fa-calendar-xmark text-3xl mb-2"></i>
                            <p class="text-sm">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>`;
                } else {
                    if (isFirstLoad && filteredItems[0].lat && filteredItems[0].lng) {
                        map.flyTo([filteredItems[0].lat, filteredItems[0].lng], 14, { duration: 1.5 });
                        isFirstLoad = false;
                    }
                }

                filteredItems.forEach((item, index) => {
                    const catObj = categories.find(c => c.id === item.category) || categories.find(c => c.id === 'etc');
                    const isFlight = item.category === 'flight';
                    
                    // ìƒì„¸ ì •ë³´ ë¬¸ìì—´ ìƒì„±
                    let details = '';
                    if (item.menu) details += `<span class="bg-orange-100 text-orange-700 px-1 rounded mr-1">ğŸ½ï¸ ${item.menu}</span>`;
                    if (item.isReserved !== undefined && item.category === 'hotel') {
                        details += item.isReserved ? `<span class="bg-green-100 text-green-700 px-1 rounded mr-1">âœ… ì˜ˆì•½ì™„ë£Œ</span>` : `<span class="bg-red-100 text-red-700 px-1 rounded mr-1">â³ ë¯¸ì˜ˆì•½</span>`;
                    }
                    if (item.cost > 0) {
                        const krw = Math.round(item.cost * EXCHANGE_RATE).toLocaleString();
                        details += `<span class="text-gray-500 text-xs">ğŸ’´ Â¥${item.cost.toLocaleString()} (ì•½ ${krw}ì›)</span>`;
                    }

                    const el = document.createElement('div');
                    el.className = `bg-white p-4 rounded-xl border ${isFlight ? 'border-sky-200 bg-sky-50' : 'border-gray-100'} shadow-sm hover:shadow-md transition cursor-pointer group relative`;
                    el.onclick = () => { if(item.lat) map.flyTo([item.lat, item.lng], 16); };
                    
                    el.innerHTML = `
                        <div class="flex items-start gap-3">
                            <div class="flex flex-col items-center">
                                ${!isFlight ? '<div class="w-2 h-full bg-gray-200 absolute top-4 bottom-[-20px] left-[23px] -z-10 group-last:hidden"></div>' : ''}
                                <div class="text-xl z-0 w-8 h-8 flex items-center justify-center bg-white rounded-full border border-gray-100 shadow-sm">
                                    ${item.categoryIcon || catObj.icon}
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h4 class="font-bold text-gray-800 text-base ${isFlight ? 'text-sky-700' : ''}">${item.place}</h4>
                                    <span class="text-xs font-bold bg-gray-100 text-gray-600 px-2 py-1 rounded">${item.time || '-'}</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1 truncate"><i class="fa-solid fa-map-pin mr-1 text-[10px]"></i>${item.address || 'ì£¼ì†Œ ì—†ìŒ'}</p>
                                <div class="text-xs mt-1 flex flex-wrap gap-1">${details}</div>
                                <p class="text-sm text-gray-600 mt-1">${item.memo || ''}</p>
                            </div>
                        </div>
                        ${isAdmin ? `
                        <button onclick="event.stopPropagation(); window.deleteItem('${item.id}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition text-gray-300 hover:text-red-500 p-2">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>` : ''}
                    `;
                    listContainer.appendChild(el);

                    if (item.lat) {
                        const markerIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: white; border-radius: 50%; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 20px; text-align: center; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">${item.categoryIcon || catObj.icon}</div>`,
                            iconSize: [36, 36],
                            iconAnchor: [18, 18]
                        });

                        const marker = L.marker([item.lat, item.lng], {icon: markerIcon}).addTo(markersLayer);
                        
                        // íŒì—… ë‚´ìš©ë„ ìƒì„¸í•˜ê²Œ
                        let popupDetails = '';
                        if(item.cost > 0) popupDetails += `<div class="text-xs text-blue-600 font-bold mb-1">Â¥${item.cost.toLocaleString()}</div>`;
                        if(item.menu) popupDetails += `<div class="text-xs bg-orange-100 inline-block px-1 rounded text-orange-800 mb-1">${item.menu}</div>`;
                        
                        marker.bindPopup(`
                            <div class="text-center min-w-[150px]">
                                <div class="text-2xl mb-1">${item.categoryIcon || catObj.icon}</div>
                                <h3 class="font-bold mb-1 text-gray-800">${item.place}</h3>
                                ${popupDetails}
                                <p class="text-xs text-gray-500 mb-1 truncate max-w-[180px] mx-auto">${item.address || ''}</p>
                                <p class="text-sm font-bold text-indigo-600">${item.time || ''} ${item.memo || ''}</p>
                            </div>
                        `);
                    }
                });
            });
        }

        window.deleteItem = async (id) => {
            if(confirm("ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await deleteDoc(doc(db, 'trips', appId, 'itineraries', id));
        };

        window.submitSuggestion = async () => {
            try {
                await addDoc(collection(db, 'trips', appId, 'suggestions'), {
                    place: document.getElementById('sugPlace').value, 
                    reason: document.getElementById('sugReason').value, 
                    createdAt: new Date().toISOString()
                });
                alert("ì¶”ì²œí•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!"); 
                window.closeSuggestionModal();
            } catch(e) { alert("ì „ì†¡ ì‹¤íŒ¨"); }
        };

        window.toggleLoginModal = () => {
            document.getElementById('loginModal').classList.toggle('hidden');
            if(!document.getElementById('loginModal').classList.contains('hidden')) {
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        };
        
        window.checkPassword = () => {
            if(document.getElementById('passwordInput').value === 'rlarlqja01!') {
                grantAdminAccess();
                localStorage.setItem('travel_admin', 'true');
                window.toggleLoginModal();
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
                document.getElementById('passwordInput').value = '';
            }
        };
        
        window.logout = () => {
            if(confirm("ê´€ë¦¬ì ëª¨ë“œ ì¢…ë£Œ")) {
                isAdmin = false; 
                localStorage.removeItem('travel_admin');
                updateAdminUI(); 
                subscribeToItinerary();
                window.closeAdminSuggestionBox();
            }
        };
        
        function grantAdminAccess() { isAdmin = true; updateAdminUI(); subscribeToItinerary(); }
        
        function updateAdminUI() {
            const isHidden = !isAdmin;
            document.getElementById('authStatus').classList.toggle('hidden', isHidden);
            document.getElementById('adminHint').classList.toggle('hidden', isHidden);
            document.getElementById('loginBtn').classList.toggle('hidden', !isHidden);
            document.getElementById('logoutBtn').classList.toggle('hidden', isHidden);
            document.getElementById('flightControls').classList.toggle('hidden', isHidden); 
            document.getElementById('adminSuggestionBtn').classList.toggle('hidden', isHidden); // ê±´ì˜í•¨ ë²„íŠ¼
        }
        
        window.openSuggestionModal = () => document.getElementById('suggestionModal').classList.remove('hidden');
        window.closeSuggestionModal = () => document.getElementById('suggestionModal').classList.add('hidden');
        document.getElementById('openSidebar').onclick = () => document.getElementById('sidebar').classList.remove('-translate-x-full');
        document.getElementById('closeSidebarMobile').onclick = () => document.getElementById('sidebar').classList.add('-translate-x-full');
        
        function setupEventListeners() {
            document.addEventListener('keydown', (e) => { 
                if(e.key === "Escape") { 
                    document.getElementById('loginModal').classList.add('hidden');
                    window.closeSuggestionModal();
                    window.closeAddScheduleModal();
                    window.closeAdminSuggestionBox();
                }
            });
        }
    </script>
</body>
</html>
