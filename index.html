<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ê³ ì•¼ ì—¬í–‰ - Premium Itinerary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans KR', 'sans-serif'],
                    },
                    colors: {
                        primary: '#0f172a', /* Slate 900 */
                        secondary: '#334155', /* Slate 700 */
                        accent: '#6366f1', /* Indigo 500 */
                        gold: '#d4af37', /* Premium Gold vibe */
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .map-container { z-index: 1; }
        .sidebar { z-index: 20; box-shadow: 4px 0 24px rgba(0,0,0,0.08); }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.5); }
        
        /* Category Radio Styling - Premium */
        .category-radio:checked + label {
            background-color: #f1f5f9;
            border-color: #6366f1;
            color: #4338ca;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);
            font-weight: 700;
        }
        .category-radio:checked + label i { color: #6366f1; }

        /* Timeline Line */
        .timeline-line::before {
            content: '';
            position: absolute;
            top: 2rem;
            bottom: -1rem;
            left: 1.5rem;
            width: 2px;
            background: #e2e8f0;
            z-index: 0;
        }
        .group-last .timeline-line::before { display: none; }
        
        /* Custom Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #6366f1; }
        .toggle-checkbox:checked + .toggle-label { background-color: #6366f1; }
        
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen w-screen flex overflow-hidden text-slate-800">

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar w-full md:w-[450px] h-full bg-white flex flex-col border-r border-slate-200 shrink-0 absolute md:relative transition-all duration-300 transform -translate-x-full md:translate-x-0" id="sidebar">
        <!-- í—¤ë” -->
        <div class="px-6 py-5 bg-primary text-white flex justify-between items-center shadow-sm shrink-0">
            <div>
                <h1 class="text-xl font-bold tracking-tight"><i class="fa-solid fa-plane-departure mr-2 text-indigo-400"></i>Nagoya Trip</h1>
                <p class="text-xs text-slate-400 mt-1 font-light" id="exchangeRateDisplay">í™˜ìœ¨ ì •ë³´ ë¡œë”© ì¤‘...</p>
            </div>
            <button id="closeSidebarMobile" class="md:hidden text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <!-- Day íƒ­ -->
        <div class="flex overflow-x-auto px-4 py-3 bg-white border-b border-slate-100 space-x-2 scrollbar-hide shrink-0" id="dayTabs"></div>

        <!-- ë¹ ë¥¸ ì¶”ê°€ ë²„íŠ¼ ê·¸ë£¹ (í•­ê³µê¶Œ & ìˆ™ì†Œ) -->
        <div id="quickControls" class="px-4 py-3 grid grid-cols-2 gap-3 bg-slate-50 border-b border-slate-100 hidden shrink-0">
            <button onclick="openAddScheduleModal(0,0, 'flight')" class="py-2.5 px-4 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-600 hover:border-indigo-300 hover:text-indigo-600 hover:shadow-sm transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-ticket text-indigo-500"></i> í•­ê³µê¶Œ ë“±ë¡
            </button>
            <button onclick="openAddScheduleModal(0,0, 'hotel')" class="py-2.5 px-4 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-600 hover:border-blue-300 hover:text-blue-600 hover:shadow-sm transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-bed text-blue-500"></i> ìˆ™ì†Œ ë“±ë¡
            </button>
        </div>

        <!-- ì¼ì • ë¦¬ìŠ¤íŠ¸ -->
        <div class="flex-1 overflow-y-auto p-5 space-y-4 bg-slate-50/50" id="itineraryList">
            <div class="flex flex-col items-center justify-center h-full text-slate-400">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mb-3"></div>
                <p class="text-sm">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        </div>

        <!-- í•˜ë‹¨ ìƒíƒœ ë©”ì‹œì§€ -->
        <div id="statusMessage" class="px-4 py-3 border-t border-slate-200 bg-white text-center shrink-0">
            <p class="text-xs text-slate-500 font-medium"><i class="fa-solid fa-location-dot mr-1 text-indigo-500"></i>ì§€ë„ ìœ„ë¥¼ í´ë¦­í•˜ì—¬ ì¥ì†Œë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>
        </div>
    </div>

    <!-- ë©”ì¸ ì§€ë„ ì˜ì—­ -->
    <div class="flex-1 relative h-full w-full">
        <!-- ëª¨ë°”ì¼ í–„ë²„ê±° -->
        <button id="openSidebar" class="absolute top-4 left-4 z-[999] md:hidden bg-white p-3 rounded-full shadow-xl text-primary border border-slate-100">
            <i class="fa-solid fa-bars"></i>
        </button>

        <!-- ìš°ì¸¡ ìƒë‹¨ ì»¨íŠ¸ë¡¤ -->
        <div class="absolute top-4 right-4 z-[999] flex flex-col space-y-3 items-end">
            <div id="authStatus" class="hidden bg-emerald-500/90 backdrop-blur text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-lg mb-1 animate-pulse border border-emerald-400">
                <i class="fa-solid fa-user-shield mr-1"></i>Admin Mode
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="openSuggestionModal()" class="bg-white/90 backdrop-blur hover:bg-white text-slate-700 px-4 py-2.5 rounded-xl shadow-lg border border-slate-200 font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-regular fa-lightbulb text-amber-500"></i> ì¶”ì²œ
                </button>
                <button id="adminSuggestionBtn" onclick="openAdminSuggestionBox()" class="hidden bg-amber-400 hover:bg-amber-500 text-white px-4 py-2.5 rounded-xl shadow-lg font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-inbox"></i>
                </button>
                <button onclick="toggleLoginModal()" id="loginBtn" class="bg-primary hover:bg-slate-800 text-white px-4 py-2.5 rounded-xl shadow-lg font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-lock"></i> ê´€ë¦¬ì
                </button>
                <button onclick="logout()" id="logoutBtn" class="hidden bg-slate-600 hover:bg-slate-700 text-white px-4 py-2.5 rounded-xl shadow-lg font-bold text-sm transition">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>
        <div id="map" class="w-full h-full z-0 bg-slate-100"></div>
    </div>

    <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="loginModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-80 fade-in border border-slate-100">
            <h2 class="text-xl font-bold mb-6 text-center text-primary">Admin Access</h2>
            <input type="password" id="passwordInput" placeholder="Password" class="w-full p-3.5 border border-slate-200 rounded-xl mb-4 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none transition" onkeyup="if(window.event.keyCode==13){checkPassword()}">
            <div class="flex gap-3">
                <button onclick="toggleLoginModal()" class="flex-1 py-3 bg-slate-100 rounded-xl text-slate-600 font-bold hover:bg-slate-200 transition">Cancel</button>
                <button onclick="checkPassword()" class="flex-1 py-3 bg-primary rounded-xl text-white font-bold hover:bg-slate-800 transition shadow-lg shadow-indigo-500/20">Login</button>
            </div>
        </div>
    </div>

    <!-- ì¶”ì²œ ëª¨ë‹¬ -->
    <div id="suggestionModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-96 fade-in border border-slate-100 m-4">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-lg font-bold text-slate-800"><i class="fa-regular fa-paper-plane mr-2 text-indigo-500"></i>Place Suggestion</h2>
                <button onclick="closeSuggestionModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="sugPlace" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ì¥ì†Œëª… (ì˜ˆ: ì˜¤ìŠ¤ ìƒì ê°€)">
                <textarea id="sugReason" rows="3" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ì¶”ì²œ ì´ìœ ë¥¼ ì ì–´ì£¼ì„¸ìš”."></textarea>
                <button onclick="submitSuggestion()" class="w-full bg-amber-400 hover:bg-amber-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-amber-500/20 transition text-sm">ë³´ë‚´ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê±´ì˜í•¨ (ê´€ë¦¬ì) -->
    <div id="adminSuggestionBox" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-[400px] h-[500px] flex flex-col fade-in m-4">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-inbox mr-2 text-amber-500"></i>Inbox</h2>
                <button onclick="closeAdminSuggestionBox()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="suggestionList" class="flex-1 overflow-y-auto space-y-2 pr-1">
                <!-- Content -->
            </div>
        </div>
    </div>

    <!-- ì¼ì • ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addScheduleModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-[420px] max-h-[90vh] overflow-y-auto fade-in m-4 border border-slate-100">
            <div class="flex justify-between items-center mb-5 border-b border-slate-100 pb-3">
                <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-pen-to-square mr-2 text-indigo-500"></i>ìƒˆ ì¼ì • ì¶”ê°€</h2>
                <button onclick="closeAddScheduleModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="space-y-5">
                <!-- ì¥ì†Œëª… -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì¥ì†Œëª…</label>
                    <input type="text" id="addPlace" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-medium focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 focus:outline-none transition bg-slate-50 focus:bg-white" placeholder="ì˜ˆ: ë‚˜ê³ ì•¼ ì„±">
                </div>
                
                <!-- ì‹œê°„ -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ë°©ë¬¸ ì‹œê°„</label>
                    <input type="time" id="addTime" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white">
                </div>

                <!-- ì£¼ì†Œ (ìˆ˜ì • ê°€ëŠ¥) -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì£¼ì†Œ</label>
                    <div class="relative">
                        <input type="text" id="addAddress" class="w-full p-3 pl-9 border border-slate-200 rounded-xl text-sm bg-slate-50 text-slate-600 focus:bg-white focus:border-indigo-500 focus:outline-none transition" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        <i class="fa-solid fa-map-pin absolute left-3.5 top-3.5 text-slate-400"></i>
                    </div>
                </div>

                <!-- ì¹´í…Œê³ ë¦¬ -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">ì¹´í…Œê³ ë¦¬</label>
                    <div class="grid grid-cols-5 gap-2" id="categoryGrid">
                        <!-- JS Render -->
                    </div>
                </div>

                <!-- ë™ì  í•„ë“œ ì˜ì—­ -->
                <div id="dynamicFields" class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100 hidden">
                    <!-- JS Injected -->
                </div>

                <!-- ë©”ëª¨ -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ë©”ëª¨</label>
                    <textarea id="addMemo" rows="2" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition resize-none" placeholder="ê¸°ì–µí•  ë‚´ìš©..."></textarea>
                </div>

                <button onclick="submitNewSchedule()" class="w-full bg-primary hover:bg-slate-800 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-slate-900/10 transition text-sm flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check"></i> ì¼ì • ì €ì¥í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import * as L from 'https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAhC1MM1KI759uNFhqyu1RNjmw0Xqez5E0",
            authDomain: "mytravelmap-4f52a.firebaseapp.com",
            projectId: "mytravelmap-4f52a",
            storageBucket: "mytravelmap-4f52a.firebasestorage.app",
            messagingSenderId: "1064774813139",
            appId: "1:1064774813139:web:29b2b9e3150fbbb2ad5b26"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        let map, markersLayer;
        let currentDay = 1;
        let isAdmin = false;
        const totalDays = 6;
        let isFirstLoad = true;
        let tempLatLng = null;

        // ì‹¤ì‹œê°„ í™˜ìœ¨ (ê¸°ë³¸ê°’ 9.1)
        let EXCHANGE_RATE = 9.1;

        // ì¹´í…Œê³ ë¦¬ ì •ì˜ (ëŒ€ì¤‘êµí†µ ì¶”ê°€)
        const categories = [
            { id: 'flight', label: 'í•­ê³µ', icon: 'âœˆï¸', color: 'text-indigo-600' },
            { id: 'hotel', label: 'ìˆ™ì†Œ', icon: 'ğŸ¨', color: 'text-blue-600' },
            { id: 'transport', label: 'êµí†µ', icon: 'ğŸš†', color: 'text-emerald-600' },
            { id: 'food', label: 'ë§›ì§‘', icon: 'ğŸ´', color: 'text-orange-500' },
            { id: 'cafe', label: 'ì¹´í˜', icon: 'â˜•', color: 'text-amber-700' },
            { id: 'attraction', label: 'ëª…ì†Œ', icon: 'ğŸ¡', color: 'text-purple-600' },
            { id: 'mart', label: 'ì‡¼í•‘', icon: 'ğŸ›ï¸', color: 'text-pink-600' },
            { id: 'convenience', label: 'í¸ì˜ì ', icon: 'ğŸª', color: 'text-cyan-500' },
            { id: 'bank', label: 'ì€í–‰', icon: 'ğŸ¦', color: 'text-gray-600' },
            { id: 'etc', label: 'ê¸°íƒ€', icon: 'ğŸ“', color: 'text-gray-400' },
        ];

        window.onload = async () => {
            initMap();
            renderDayTabs();
            renderCategoryGrid();
            fetchExchangeRate(); // í™˜ìœ¨ ê°€ì ¸ì˜¤ê¸°
            
            try {
                await signInAnonymously(auth);
                subscribeToItinerary();
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }

            if(localStorage.getItem('travel_admin') === 'true') {
                grantAdminAccess();
            }
            updateAdminUI();
            setupEventListeners();
        };

        // --- í™˜ìœ¨ API ---
        async function fetchExchangeRate() {
            try {
                // ë¬´ë£Œ ê³µê°œ API ì‚¬ìš© (KRW ê¸°ì¤€ JPY í™˜ìœ¨ ì—­ì‚° or JPY ê¸°ì¤€)
                // exchangerate-api.com (Open) - JPY ê¸°ì¤€ KRW
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await res.json();
                if (data && data.rates && data.rates.KRW) {
                    EXCHANGE_RATE = data.rates.KRW; // 1 JPY = N KRW
                    document.getElementById('exchangeRateDisplay').innerText = `í˜„ì¬ í™˜ìœ¨: Â¥100 = â‚©${(EXCHANGE_RATE * 100).toFixed(0)}`;
                } else {
                    throw new Error("Rate not found");
                }
            } catch (e) {
                console.warn("í™˜ìœ¨ API ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©", e);
                document.getElementById('exchangeRateDisplay').innerText = `ì˜ˆìƒ í™˜ìœ¨: Â¥100 = â‚©910 (ê¸°ë³¸ê°’)`;
            }
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([35.1709, 136.8815], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);

            map.on('click', function(e) {
                if(!isAdmin) return;
                openAddScheduleModal(e.latlng.lat, e.latlng.lng);
            });
        }

        function renderDayTabs() {
            const container = document.getElementById('dayTabs');
            container.innerHTML = '';
            for(let i=1; i<=totalDays; i++) {
                const btn = document.createElement('button');
                const isActive = currentDay === i;
                btn.className = `px-5 py-2 text-sm font-bold rounded-full whitespace-nowrap transition-all duration-200 border ${isActive ? 'bg-primary text-white border-primary shadow-md transform scale-105' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50 hover:border-slate-300'}`;
                btn.innerText = `Day ${i}`;
                btn.onclick = () => { 
                    currentDay = i; 
                    isFirstLoad = true;
                    renderDayTabs(); 
                    subscribeToItinerary(); 
                };
                container.appendChild(btn);
            }
        }

        function renderCategoryGrid() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = categories.map(cat => `
                <div class="relative group">
                    <input type="radio" name="category" id="cat_${cat.id}" value="${cat.id}" class="peer hidden category-radio" ${cat.id === 'etc' ? 'checked' : ''} onchange="updateDynamicFields(this.value)">
                    <label for="cat_${cat.id}" class="flex flex-col items-center justify-center p-2.5 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition h-full text-center">
                        <span class="text-xl mb-1 filter drop-shadow-sm group-hover:scale-110 transition">${cat.icon}</span>
                        <span class="text-[10px] text-slate-500 whitespace-nowrap font-medium">${cat.label}</span>
                    </label>
                </div>
            `).join('');
        }

        // ë™ì  í•„ë“œ (í™˜ìœ¨ ê³„ì‚° í¬í•¨)
        window.currentCurrency = 'JPY'; // 'JPY' or 'KRW'

        window.updateDynamicFields = (catId) => {
            const container = document.getElementById('dynamicFields');
            container.innerHTML = '';
            container.classList.remove('hidden');

            let html = '';

            // ë¹„ìš© ì…ë ¥ UI (í† ê¸€ í¬í•¨)
            const getCostInput = (label = 'ì˜ˆìƒ ë¹„ìš©') => `
                <div class="bg-white p-3 rounded-lg border border-indigo-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-slate-600">${label}</label>
                        <div class="flex bg-slate-100 rounded-md p-0.5">
                            <button type="button" onclick="setCurrency('JPY')" id="btn-JPY" class="px-2 py-0.5 text-[10px] font-bold rounded ${window.currentCurrency==='JPY'?'bg-white shadow text-indigo-600':'text-slate-400'}">JPY</button>
                            <button type="button" onclick="setCurrency('KRW')" id="btn-KRW" class="px-2 py-0.5 text-[10px] font-bold rounded ${window.currentCurrency==='KRW'?'bg-white shadow text-indigo-600':'text-slate-400'}">KRW</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-bold text-slate-400 w-4 text-center" id="currencySymbol">Â¥</span>
                        <input type="number" id="addCost" oninput="calcConversion(this.value)" class="flex-1 p-1 bg-transparent border-b border-slate-200 text-sm font-bold text-right focus:outline-none focus:border-indigo-500" placeholder="0">
                    </div>
                    <div class="text-right text-xs text-indigo-500 font-bold mt-1" id="convertedPreview">â‰ˆ 0ì›</div>
                </div>
            `;

            if (catId === 'flight') {
                 html += `
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1">í•­ê³µí¸ëª…</label>
                            <input type="text" id="addFlightNum" class="w-full p-2 border border-slate-200 rounded-lg text-sm" placeholder="KE123">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1">ë„ì°© ì‹œê°„</label>
                            <input type="time" id="addArrTime" class="w-full p-2 border border-slate-200 rounded-lg text-sm">
                        </div>
                    </div>
                    ${getCostInput('í•­ê³µê¶Œ ë¹„ìš©')}
                `;
            } else if (catId === 'hotel') {
                html += `
                    <div class="flex items-center justify-between mb-3 bg-white p-3 rounded-lg border border-indigo-100 shadow-sm">
                        <span class="text-xs font-bold text-slate-600">ì˜ˆì•½ ìƒíƒœ</span>
                        <div class="relative inline-block w-10 h-5 align-middle select-none">
                            <input type="checkbox" name="toggle" id="addReserved" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300"/>
                            <label for="addReserved" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer transition-all duration-300"></label>
                        </div>
                    </div>
                    ${getCostInput('ìˆ™ë°•ë¹„ (1ë°•)')}
                `;
            } else if (catId === 'transport') {
                 html += `
                    <div class="mb-2">
                        <label class="block text-xs font-bold text-slate-600 mb-1">êµí†µìˆ˜ë‹¨ (ì˜ˆ: ë©”ì´í…Œì¸  íŠ¹ê¸‰)</label>
                        <input type="text" id="addTransportName" class="w-full p-2 border border-slate-200 rounded text-sm bg-white" placeholder="ì´ë™ ìˆ˜ë‹¨">
                    </div>
                    ${getCostInput('ìš´ì„')}
                `;
            } else if (catId === 'food' || catId === 'cafe') {
                html += `
                    <div class="mb-2">
                        <label class="block text-xs font-bold text-slate-600 mb-1">ì¶”ì²œ ë©”ë‰´</label>
                        <input type="text" id="addMenu" class="w-full p-2 border border-slate-200 rounded text-sm bg-white" placeholder="ì˜ˆ: íˆì¸ ë§ˆë¶€ì‹œ">
                    </div>
                    ${getCostInput('ì˜ˆìƒ ì‹ë¹„')}
                `;
            } else if (catId === 'attraction') {
                html += getCostInput('ì…ì¥ë£Œ');
            } else if (['mart', 'convenience', 'etc', 'bank'].includes(catId)) {
                html += getCostInput('ì˜ˆìƒ ë¹„ìš©');
            } else {
                container.classList.add('hidden');
            }

            container.innerHTML = html;
        };

        window.setCurrency = (curr) => {
            window.currentCurrency = curr;
            document.getElementById('btn-JPY').className = `px-2 py-0.5 text-[10px] font-bold rounded ${curr==='JPY'?'bg-white shadow text-indigo-600':'text-slate-400'}`;
            document.getElementById('btn-KRW').className = `px-2 py-0.5 text-[10px] font-bold rounded ${curr==='KRW'?'bg-white shadow text-indigo-600':'text-slate-400'}`;
            document.getElementById('currencySymbol').innerText = curr === 'JPY' ? 'Â¥' : 'â‚©';
            
            // ì¬ê³„ì‚°
            const val = document.getElementById('addCost').value;
            if(val) calcConversion(val);
        };

        window.calcConversion = (val) => {
            if(!val) {
                document.getElementById('convertedPreview').innerText = '';
                return;
            }
            if (window.currentCurrency === 'JPY') {
                // JPY -> KRW
                const krw = Math.round(val * EXCHANGE_RATE);
                document.getElementById('convertedPreview').innerText = `â‰ˆ ${krw.toLocaleString()}ì›`;
            } else {
                // KRW -> JPY
                const jpy = Math.round(val / EXCHANGE_RATE);
                document.getElementById('convertedPreview').innerText = `â‰ˆ ${jpy.toLocaleString()}ì—”`;
            }
        };

        // ëª¨ë‹¬ ì—´ê¸°
        window.openAddScheduleModal = async (lat, lng, preSelectCat = null) => {
            const modal = document.getElementById('addScheduleModal');
            
            // ì´ˆê¸°í™”
            document.getElementById('addPlace').value = preSelectCat === 'flight' ? 'ë‚˜ê³ ì•¼ ì¤‘ë¶€êµ­ì œê³µí•­' : '';
            document.getElementById('addTime').value = '';
            document.getElementById('addMemo').value = '';
            document.getElementById('addAddress').value = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';
            
            let targetCat = preSelectCat || 'etc';
            document.getElementById(`cat_${targetCat}`).checked = true;
            
            // UI ì—…ë°ì´íŠ¸
            window.currentCurrency = 'JPY'; // ê¸°ë³¸
            window.updateDynamicFields(targetCat);
            
            if (preSelectCat && preSelectCat !== 'etc') {
                tempLatLng = null; // ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€ ì‹œ ì¢Œí‘œ ì—†ìŒ (ë˜ëŠ” ê¸°ë³¸ê°’)
                document.getElementById('addAddress').value = '-';
            } else {
                tempLatLng = { lat, lng };
                fetchAddress(lat, lng);
            }

            modal.classList.remove('hidden');
            setTimeout(() => document.getElementById('addPlace').focus(), 100);
        };

        window.closeAddScheduleModal = () => document.getElementById('addScheduleModal').classList.add('hidden');

        async function fetchAddress(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                if(data && data.display_name) {
                    const parts = data.display_name.split(',');
                    // ì¼ë³¸ ì£¼ì†Œ ì²´ê³„ ê³ ë ¤í•˜ì—¬ ë’¤ì—ì„œë¶€í„° ê°€ì ¸ì˜¤ê±°ë‚˜, ì£¼ìš” ë¶€ë¶„ë§Œ
                    document.getElementById('addAddress').value = parts.slice(0, 3).join(', ');
                } else {
                    document.getElementById('addAddress').value = "";
                }
            } catch(e) {
                document.getElementById('addAddress').value = "";
            }
        }

        // --- ì¼ì • ì €ì¥ ---
        window.submitNewSchedule = async () => {
            if(!isAdmin) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
            
            const place = document.getElementById('addPlace').value;
            const time = document.getElementById('addTime').value;
            const memo = document.getElementById('addMemo').value;
            const address = document.getElementById('addAddress').value;
            const selectedCatId = document.querySelector('input[name="category"]:checked').value;
            const categoryObj = categories.find(c => c.id === selectedCatId);

            // ë™ì  í•„ë“œ ì²˜ë¦¬
            const costInput = document.getElementById('addCost');
            let costJPY = 0;
            if (costInput && costInput.value) {
                if (window.currentCurrency === 'JPY') {
                    costJPY = parseInt(costInput.value);
                } else {
                    costJPY = Math.round(parseInt(costInput.value) / EXCHANGE_RATE); // KRW -> JPY ì €ì¥
                }
            }

            const menu = document.getElementById('addMenu')?.value || '';
            const isReserved = document.getElementById('addReserved')?.checked || false;
            
            // í•­ê³µí¸ ì „ìš©
            const flightNum = document.getElementById('addFlightNum')?.value || '';
            const arrTime = document.getElementById('addArrTime')?.value || '';
            // êµí†µí¸ ì „ìš©
            const transportName = document.getElementById('addTransportName')?.value || '';

            if(!place) return alert("ì¥ì†Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");

            try {
                const docData = {
                    day: currentDay,
                    place, time, memo, address,
                    category: selectedCatId,
                    categoryIcon: categoryObj.icon,
                    cost: costJPY, 
                    menu, isReserved, flightNum, arrTime, transportName,
                    createdAt: new Date().toISOString()
                };

                if(tempLatLng && selectedCatId !== 'flight') { // í•­ê³µì€ ì¢Œí‘œ ìƒëµ ê°€ëŠ¥
                    docData.lat = tempLatLng.lat;
                    docData.lng = tempLatLng.lng;
                }

                await addDoc(collection(db, 'trips', appId, 'itineraries'), docData);
                window.closeAddScheduleModal();
            } catch (e) { 
                console.error(e); 
                alert("ì €ì¥ ì‹¤íŒ¨"); 
            }
        };

        // --- ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ---
        function subscribeToItinerary() {
            if (window.unsub) window.unsub();
            const colRef = collection(db, 'trips', appId, 'itineraries');
            
            window.unsub = onSnapshot(colRef, (snapshot) => {
                const listContainer = document.getElementById('itineraryList');
                listContainer.innerHTML = '';
                markersLayer.clearLayers();
                
                const items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));

                // ì‹œê°„ìˆœ ì •ë ¬ (Timeì´ ì—†ìœ¼ë©´ ë§¨ ë’¤ë¡œ)
                const filteredItems = items
                    .filter(item => item.day === currentDay)
                    .sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));

                if (filteredItems.length === 0) {
                    listContainer.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-64 text-slate-300">
                            <i class="fa-regular fa-map text-4xl mb-3"></i>
                            <p class="text-sm">ì¼ì •ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
                        </div>`;
                } else {
                    if (isFirstLoad && filteredItems[0].lat && filteredItems[0].lng) {
                        map.flyTo([filteredItems[0].lat, filteredItems[0].lng], 14, { duration: 1.5 });
                        isFirstLoad = false;
                    }
                }

                filteredItems.forEach((item, index) => {
                    const catObj = categories.find(c => c.id === item.category) || categories.find(c => c.id === 'etc');
                    const isFlight = item.category === 'flight';
                    const isHotel = item.category === 'hotel';
                    const isTransport = item.category === 'transport';
                    
                    // ë¹„ìš© í‘œì‹œ (KRW í™˜ì‚°)
                    let costDisplay = '';
                    if (item.cost > 0) {
                        const krw = Math.round(item.cost * EXCHANGE_RATE).toLocaleString();
                        costDisplay = `<span class="text-slate-500 font-medium">ğŸ’´ Â¥${item.cost.toLocaleString()} <span class="text-[10px] text-slate-400">(ì•½ ${krw}ì›)</span></span>`;
                    }

                    // íƒœê·¸ ìƒì„±
                    let tags = '';
                    if (item.menu) tags += `<span class="bg-orange-50 text-orange-600 px-1.5 py-0.5 rounded text-[10px] border border-orange-100 font-medium">ğŸ½ï¸ ${item.menu}</span> `;
                    if (item.isReserved !== undefined && isHotel) {
                        tags += item.isReserved 
                            ? `<span class="bg-emerald-50 text-emerald-600 px-1.5 py-0.5 rounded text-[10px] border border-emerald-100 font-bold">âœ… ì˜ˆì•½í™•ì •</span> ` 
                            : `<span class="bg-rose-50 text-rose-600 px-1.5 py-0.5 rounded text-[10px] border border-rose-100 font-bold">â³ ë¯¸ì˜ˆì•½</span> `;
                    }
                    if (item.flightNum) tags += `<span class="bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded text-[10px] border border-indigo-100 font-bold">âœˆï¸ ${item.flightNum}</span> `;
                    if (item.transportName) tags += `<span class="bg-emerald-50 text-emerald-600 px-1.5 py-0.5 rounded text-[10px] border border-emerald-100 font-bold">ğŸš† ${item.transportName}</span> `;

                    // ì‹œê°„ í‘œì‹œ (í•­ê³µí¸ì¸ ê²½ìš° ë„ì°©ì‹œê°„ í¬í•¨)
                    let timeDisplay = item.time || '';
                    if (isFlight && item.arrTime) timeDisplay += ` ~ ${item.arrTime}`;

                    // ì¹´ë“œ ìŠ¤íƒ€ì¼ ë¶„ê¸°
                    let cardClasses = 'bg-white p-4 rounded-xl border shadow-sm transition group relative timeline-line pl-12 mb-0';
                    if (isFlight) cardClasses = 'bg-indigo-50/60 p-5 rounded-2xl border border-indigo-200 shadow-sm transition group relative mb-2'; // í•­ê³µê¶Œ ê°•ì¡°
                    else if (isHotel) cardClasses = 'bg-blue-50/60 p-5 rounded-2xl border border-blue-200 shadow-sm transition group relative mb-2'; // ìˆ™ì†Œ ê°•ì¡°
                    else cardClasses += ' hover:shadow-md border-slate-100';

                    const el = document.createElement('div');
                    el.className = cardClasses;
                    el.onclick = () => { if(item.lat) map.flyTo([item.lat, item.lng], 16); };
                    
                    // ì•„ì´ì½˜ ìŠ¤íƒ€ì¼
                    let iconStyle = `text-xl z-10 w-9 h-9 flex items-center justify-center bg-white rounded-full border border-slate-100 shadow-sm absolute left-3 top-4`;
                    if(isFlight || isHotel) iconStyle = `text-2xl z-10 w-10 h-10 flex items-center justify-center bg-white rounded-full border border-white shadow-md mb-2`;

                    el.innerHTML = `
                        ${!isFlight && !isHotel ? `<div class="${iconStyle}">${item.categoryIcon || catObj.icon}</div>` : ''}
                        
                        <div class="${isFlight || isHotel ? 'flex flex-col' : ''}">
                            <div class="flex justify-between items-start mb-1">
                                <div class="flex items-center gap-2">
                                    ${isFlight || isHotel ? `<div class="text-xl">${item.categoryIcon}</div>` : ''}
                                    <h4 class="font-bold text-slate-800 text-base ${isFlight ? 'text-indigo-800' : ''} ${isHotel ? 'text-blue-800' : ''}">${item.place}</h4>
                                </div>
                                <span class="text-xs font-bold bg-white/80 border border-slate-100 text-slate-600 px-2 py-1 rounded-lg shadow-sm whitespace-nowrap">${timeDisplay || '-'}</span>
                            </div>
                            
                            ${item.address && !isFlight ? `<p class="text-xs text-slate-400 mb-2 truncate"><i class="fa-solid fa-map-pin mr-1"></i>${item.address}</p>` : ''}
                            
                            <div class="flex flex-wrap gap-1 mb-1">${tags}</div>
                            
                            ${costDisplay ? `<div class="text-xs mt-1 mb-1">${costDisplay}</div>` : ''}
                            ${item.memo ? `<p class="text-sm text-slate-600 mt-2 bg-slate-50/50 p-2 rounded-lg border border-slate-100/50">${item.memo}</p>` : ''}
                        </div>

                        ${isAdmin ? `
                        <button onclick="event.stopPropagation(); window.deleteItem('${item.id}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition text-slate-300 hover:text-rose-500 p-2">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>` : ''}
                    `;
                    listContainer.appendChild(el);

                    // ë§ˆì»¤ ìƒì„±
                    if (item.lat) {
                        const markerColor = isFlight ? '#6366f1' : (isHotel ? '#2563eb' : '#ffffff');
                        const markerIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: ${markerColor}; border: 2px solid white; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.2); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 20px;">${item.categoryIcon || catObj.icon}</div>`,
                            iconSize: [40, 40],
                            iconAnchor: [20, 20],
                            popupAnchor: [0, -20]
                        });

                        const marker = L.marker([item.lat, item.lng], {icon: markerIcon}).addTo(markersLayer);
                        marker.bindPopup(`
                            <div class="text-center min-w-[160px] p-1 font-sans">
                                <div class="text-2xl mb-2">${item.categoryIcon || catObj.icon}</div>
                                <h3 class="font-bold mb-1 text-slate-800 text-sm">${item.place}</h3>
                                <p class="text-xs text-indigo-600 font-bold mb-1">${timeDisplay}</p>
                            </div>
                        `, { className: 'rounded-xl shadow-xl border-0' });
                    }
                });
            });
        }

        // --- ê³µí†µ ê¸°ëŠ¥ ---
        window.deleteItem = async (id) => {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await deleteDoc(doc(db, 'trips', appId, 'itineraries', id));
        };
        window.toggleLoginModal = () => document.getElementById('loginModal').classList.toggle('hidden');
        window.checkPassword = () => {
            if(document.getElementById('passwordInput').value === 'rlarlqja01!') {
                grantAdminAccess();
                localStorage.setItem('travel_admin', 'true');
                window.toggleLoginModal();
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                document.getElementById('passwordInput').value = '';
            }
        };
        window.logout = () => {
            if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                isAdmin = false; 
                localStorage.removeItem('travel_admin');
                updateAdminUI(); 
                subscribeToItinerary();
                window.closeAdminSuggestionBox();
            }
        };
        function grantAdminAccess() { isAdmin = true; updateAdminUI(); subscribeToItinerary(); }
        function updateAdminUI() {
            const isHidden = !isAdmin;
            document.getElementById('authStatus').classList.toggle('hidden', isHidden);
            document.getElementById('loginBtn').classList.toggle('hidden', !isHidden);
            document.getElementById('logoutBtn').classList.toggle('hidden', isHidden);
            document.getElementById('quickControls').classList.toggle('hidden', isHidden); 
            document.getElementById('adminSuggestionBtn').classList.toggle('hidden', isHidden);
        }
        
        window.openSuggestionModal = () => document.getElementById('suggestionModal').classList.remove('hidden');
        window.closeSuggestionModal = () => document.getElementById('suggestionModal').classList.add('hidden');
        window.submitSuggestion = async () => {
            try {
                await addDoc(collection(db, 'trips', appId, 'suggestions'), {
                    place: document.getElementById('sugPlace').value, 
                    reason: document.getElementById('sugReason').value, 
                    createdAt: new Date().toISOString()
                });
                alert("ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤!"); 
                window.closeSuggestionModal();
            } catch(e) { alert("ì „ì†¡ ì‹¤íŒ¨"); }
        };

        // ê±´ì˜í•¨ ë¡œì§ (ìƒëµëœ ë¶€ë¶„ ë³µì›)
        let suggestionUnsub = null;
        window.openAdminSuggestionBox = () => {
            document.getElementById('adminSuggestionBox').classList.remove('hidden');
            if(suggestionUnsub) suggestionUnsub();
            const colRef = collection(db, 'trips', appId, 'suggestions');
            suggestionUnsub = onSnapshot(colRef, (snapshot) => {
                const list = document.getElementById('suggestionList');
                list.innerHTML = '';
                if(snapshot.empty) {
                    list.innerHTML = '<div class="text-center text-slate-400 mt-10">ê±´ì˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const el = document.createElement('div');
                    el.className = 'bg-amber-50 p-3 rounded-xl border border-amber-100 flex justify-between items-start mb-2';
                    el.innerHTML = `
                        <div>
                            <div class="font-bold text-slate-700 text-sm"><i class="fa-solid fa-location-dot text-amber-500 mr-1"></i>${data.place}</div>
                            <div class="text-xs text-slate-600 mt-1">${data.reason}</div>
                            <div class="text-[10px] text-slate-400 mt-1">${new Date(data.createdAt).toLocaleDateString()}</div>
                        </div>
                        <button onclick="markAsRead('${docSnap.id}')" class="text-slate-400 hover:text-emerald-500 ml-2">
                            <i class="fa-regular fa-circle-check text-lg"></i>
                        </button>
                    `;
                    list.appendChild(el);
                });
            });
        };
        window.closeAdminSuggestionBox = () => document.getElementById('adminSuggestionBox').classList.add('hidden');
        window.markAsRead = async (id) => { if(confirm("í™•ì¸ ì™„ë£Œ ì²˜ë¦¬(ì‚­ì œ) í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await deleteDoc(doc(db, 'trips', appId, 'suggestions', id)); };

        document.getElementById('openSidebar').onclick = () => document.getElementById('sidebar').classList.remove('-translate-x-full');
        document.getElementById('closeSidebarMobile').onclick = () => document.getElementById('sidebar').classList.add('-translate-x-full');
        
        function setupEventListeners() {
            document.addEventListener('keydown', (e) => { 
                if(e.key === "Escape") { 
                    document.getElementById('loginModal').classList.add('hidden');
                    window.closeSuggestionModal();
                    window.closeAddScheduleModal();
                    window.closeAdminSuggestionBox();
                }
            });
        }
    </script>
</body>
</html>
