<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ë‚˜ê³ ì•¼ ì—¬í–‰ - Premium Itinerary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Noto Sans KR', 'sans-serif'] },
                    colors: {
                        primary: '#0f172a',
                        secondary: '#334155',
                        accent: '#6366f1',
                    },
                    screens: { 'xs': '480px' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; height: 100vh; height: 100dvh; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .sidebar { z-index: 50; box-shadow: 4px 0 24px rgba(0,0,0,0.08); }
        .category-radio:checked + label { background-color: #f1f5f9; border-color: #6366f1; color: #4338ca; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1); font-weight: 700; }
        .transport-radio:checked + label { background-color: #e0e7ff; color: #4338ca; border-color: #6366f1; font-weight: bold; }
        .timeline-item::before { content: ''; position: absolute; top: 2rem; bottom: -1rem; left: 1.5rem; width: 2px; background: #e2e8f0; z-index: 0; }
        .group-last .timeline-item::before { display: none; }
        .toggle-checkbox:checked { right: 0; border-color: #6366f1; }
        .toggle-checkbox:checked + .toggle-label { background-color: #6366f1; }
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .weather-widget { transition: all 0.3s ease; }
        .weather-widget:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .tab-active { border-bottom: 2px solid #6366f1; color: #4338ca; font-weight: bold; }
        .tab-inactive { color: #94a3b8; }
        .fab-btn { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .fab-btn:hover { transform: scale(1.1); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .fab-btn:active { transform: scale(0.95); }
        /* Leaflet Popup Style Override */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; }
        .leaflet-popup-tip { background: white; }
    </style>
</head>
<body class="w-screen flex overflow-hidden text-slate-800 relative">

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar w-full md:w-[450px] h-full bg-white flex flex-col border-r border-slate-200 shrink-0 absolute md:relative transition-transform duration-300 transform -translate-x-full md:translate-x-0" id="sidebar">
        <!-- í—¤ë” -->
        <div class="px-6 py-4 bg-primary text-white flex justify-between items-center shadow-sm shrink-0">
            <div>
                <h1 class="text-xl font-bold tracking-tight"><i class="fa-solid fa-plane-departure mr-2 text-indigo-400"></i>Nagoya Trip</h1>
                <p class="text-[10px] text-slate-400 mt-1 font-light" id="exchangeRateDisplay">í™˜ìœ¨ ì •ë³´ ë¡œë”© ì¤‘...</p>
            </div>
            <button id="closeSidebarMobile" class="md:hidden text-slate-400 hover:text-white p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <!-- ë©”ì¸ íƒ­ -->
        <div class="flex border-b border-slate-200 shrink-0">
            <button onclick="switchMainTab('itinerary')" id="tab-itinerary" class="flex-1 py-3 text-sm text-center transition tab-active">
                <i class="fa-solid fa-calendar-check mr-1"></i>ìƒì„¸ ì¼ì •
            </button>
            <button onclick="switchMainTab('candidates')" id="tab-candidates" class="flex-1 py-3 text-sm text-center transition tab-inactive">
                <i class="fa-solid fa-map-location-dot mr-1"></i>ê°€ë³¼ë§Œí•œ ê³³
            </button>
        </div>

        <!-- Day íƒ­ -->
        <div class="flex overflow-x-auto px-4 py-3 bg-white border-b border-slate-100 space-x-2 scrollbar-hide shrink-0" id="dayTabs"></div>

        <!-- 1. ì¼ì • ë·° -->
        <div id="view-itinerary" class="flex flex-col flex-1 overflow-hidden">
            <!-- ë¹ ë¥¸ ì¶”ê°€ ë²„íŠ¼ (ê´€ë¦¬ììš©) -->
            <div id="quickControls" class="px-4 py-3 grid grid-cols-2 gap-3 bg-slate-50 border-b border-slate-100 hidden shrink-0">
                <button onclick="openAddScheduleModal(0,0, 'flight')" class="py-2.5 px-4 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-600 hover:border-indigo-300 hover:text-indigo-600 hover:shadow-sm transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-ticket text-indigo-500"></i> í•­ê³µê¶Œ ë“±ë¡
                </button>
                <button onclick="openAddScheduleModal(0,0, 'hotel')" class="py-2.5 px-4 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-600 hover:border-blue-300 hover:text-blue-600 hover:shadow-sm transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-bed text-blue-500"></i> ìˆ™ì†Œ ë“±ë¡
                </button>
            </div>

            <!-- ì¼ì • ë¦¬ìŠ¤íŠ¸ -->
            <div class="flex-1 overflow-y-auto p-5 space-y-4 bg-slate-50/50" id="itineraryList">
                <div class="flex flex-col items-center justify-center h-full text-slate-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mb-3"></div>
                    <p class="text-sm">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            </div>

            <!-- ì¼ë³„ ì´ ë¹„ìš© ìš”ì•½ -->
            <div id="dailySummary" class="px-5 py-4 bg-white border-t border-slate-200 shrink-0 shadow-[0_-4px_10px_rgba(0,0,0,0.02)] hidden">
                <div class="flex justify-between items-end">
                    <div>
                        <span class="text-sm font-bold text-slate-500">Day Total</span>
                        <p class="text-[10px] text-slate-400">* í•­ê³µ/ìˆ™ì†Œ ì œì™¸</p>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold text-slate-800" id="dailyTotalJPY">Â¥0</div>
                        <div class="text-xs font-medium text-slate-400" id="dailyTotalKRW">â‰ˆ 0ì›</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. ê°€ë³¼ë§Œí•œ ê³³ ë·° -->
        <div id="view-candidates" class="flex flex-col flex-1 overflow-hidden hidden">
            <div class="p-4 bg-amber-50 border-b border-amber-100 shrink-0">
                <p class="text-xs text-amber-800 font-bold"><i class="fa-solid fa-lightbulb mr-1"></i>Day <span id="candidateDayDisplay">1</span>ì— ê°ˆê¹Œ ë§ê¹Œ ê³ ë¯¼ ì¤‘ì¸ ì¥ì†Œë“¤ì…ë‹ˆë‹¤.</p>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-white" id="candidateList"></div>
        </div>
    </div>

    <!-- ë©”ì¸ ì§€ë„ ì˜ì—­ -->
    <div class="flex-1 relative h-full w-full">
        <!-- ëª¨ë°”ì¼ í–„ë²„ê±° -->
        <button id="openSidebar" class="absolute top-4 left-4 z-[999] md:hidden bg-white p-3 rounded-full shadow-xl text-primary border border-slate-100 w-12 h-12 flex items-center justify-center">
            <i class="fa-solid fa-bars text-lg"></i>
        </button>

        <!-- ìš°ì¸¡ ìƒë‹¨ ì»¨íŠ¸ë¡¤ -->
        <div class="absolute top-4 right-4 z-[999] flex flex-col space-y-3 items-end">
            <div id="authStatus" class="hidden bg-emerald-500/90 backdrop-blur text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-lg mb-1 animate-pulse border border-emerald-400">
                <i class="fa-solid fa-user-shield mr-1"></i>Admin Mode
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="openWeatherForecastModal()" class="bg-white/90 backdrop-blur hover:bg-white text-slate-700 px-3 py-2.5 rounded-xl shadow-lg border border-slate-200 font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-calendar-days text-sky-500"></i><span class="hidden sm:inline">ì—¬í–‰ ë‚ ì”¨</span>
                </button>
                <button onclick="openSuggestionModal()" class="bg-white/90 backdrop-blur hover:bg-white text-slate-700 px-3 py-2.5 rounded-xl shadow-lg border border-slate-200 font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-regular fa-lightbulb text-amber-500"></i><span class="hidden sm:inline">ì¶”ì²œ</span>
                </button>
                <button id="adminSuggestionBtn" onclick="openAdminSuggestionBox()" class="hidden bg-amber-400 hover:bg-amber-500 text-white px-3 py-2.5 rounded-xl shadow-lg font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-inbox"></i>
                </button>
                <button onclick="toggleLoginModal()" id="loginBtn" class="bg-primary hover:bg-slate-800 text-white px-3 py-2.5 rounded-xl shadow-lg font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-lock"></i>
                </button>
                <button onclick="logout()" id="logoutBtn" class="hidden bg-slate-600 hover:bg-slate-700 text-white px-3 py-2.5 rounded-xl shadow-lg font-bold text-sm transition">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>

        <!-- í€µ ì¶”ê°€ FAB ë²„íŠ¼ -->
        <button onclick="openQuickAddModal()" class="absolute bottom-28 right-4 z-[900] fab-btn w-12 h-12 bg-indigo-600 text-white rounded-full shadow-xl flex items-center justify-center border-2 border-white hover:bg-indigo-700" title="ì¥ì†Œ ì¶”ê°€">
            <i class="fa-solid fa-plus text-xl"></i>
        </button>

        <!-- ì‹¤ì‹œê°„ ë‚ ì”¨ ìœ„ì ¯ -->
        <div id="liveWeatherWidget" class="absolute bottom-6 right-4 z-[900] weather-widget bg-white/90 backdrop-blur-md p-3 rounded-2xl shadow-xl border border-white/50 min-w-[140px] flex flex-col items-center cursor-pointer" onclick="openCurrentWeatherModal()">
            <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1"><i class="fa-solid fa-location-crosshairs mr-1"></i>ì§€ë„ ìœ„ì¹˜ ë‚ ì”¨</div>
            <div class="flex items-center gap-2">
                <div id="weatherIcon" class="text-2xl text-slate-600"><i class="fa-solid fa-spinner fa-spin text-lg"></i></div>
                <div class="text-right">
                    <div id="weatherTemp" class="text-xl font-bold text-slate-800">--Â°</div>
                    <div id="weatherDesc" class="text-[10px] text-slate-500 font-medium">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>

        <div id="map" class="w-full h-full z-0 bg-slate-100"></div>
    </div>

    <!-- í˜„ì¬ ìœ„ì¹˜ ìƒì„¸ ë‚ ì”¨ ëª¨ë‹¬ -->
    <div id="currentWeatherModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-[350px] max-w-[90%] fade-in border border-slate-100 m-4 text-center">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wide">Location Weather</h3>
                <button onclick="document.getElementById('currentWeatherModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="mb-4">
                <div id="curWeatherIconBig" class="text-5xl text-slate-600 mb-2 h-16 flex items-center justify-center"><i class="fa-solid fa-cloud"></i></div>
                <h2 id="curWeatherTempBig" class="text-4xl font-bold text-slate-800">--Â°</h2>
                <p id="curWeatherDescBig" class="text-slate-500 font-medium">ì •ë³´ ë¡œë”© ì¤‘...</p>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 mb-2">
                <p class="text-xs text-slate-400 mb-1"><i class="fa-solid fa-map-pin mr-1"></i>í˜„ì¬ ì§€ë„ ì¤‘ì‹¬</p>
                <p id="curWeatherAddress" class="text-sm text-slate-700 font-bold break-keep">ì£¼ì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs text-slate-500">
                <div class="bg-slate-50 p-2 rounded-lg"><span class="block text-[10px] text-slate-400">í’ì†</span><span id="curWind" class="font-bold">-- km/h</span></div>
                <div class="bg-slate-50 p-2 rounded-lg"><span class="block text-[10px] text-slate-400">ìŠµë„(ì˜ˆìƒ)</span><span class="font-bold">-- %</span></div>
            </div>
        </div>
    </div>

    <!-- ë‚ ì”¨ ì˜ˆë³´ ëª¨ë‹¬ -->
    <div id="weatherForecastModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-[600px] max-w-[90%] fade-in border border-slate-100 m-4">
            <div class="flex justify-between items-center mb-5 border-b border-slate-100 pb-3">
                <div>
                    <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-cloud-sun mr-2 text-sky-500"></i>ì—¬í–‰ ê¸°ê°„ ë‚ ì”¨ ì˜ˆë³´</h2>
                    <p class="text-xs text-slate-500 mt-1">Dayë³„ ë§ˆì§€ë§‰ ì¼ì • ì¥ì†Œ ê¸°ì¤€ (3/2 ~ 3/7)</p>
                </div>
                <button onclick="closeWeatherForecastModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="weatherInfoBox" class="bg-sky-50 p-3 rounded-xl mb-4 text-xs text-sky-700 font-medium flex items-center gap-2">
                <i class="fa-solid fa-circle-info"></i>
                <span id="weatherInfoText">ë¡œë”© ì¤‘...</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="weatherCardsContainer">
                <div class="col-span-3 text-center py-10 text-slate-400">
                    <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            </div>
            <button onclick="closeWeatherForecastModal()" class="w-full mt-5 bg-slate-800 text-white py-3 rounded-xl font-bold text-sm hover:bg-slate-700 transition">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="loginModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-80 fade-in border border-slate-100">
            <h2 class="text-xl font-bold mb-6 text-center text-primary">Admin Access</h2>
            <input type="password" id="passwordInput" placeholder="Password" class="w-full p-3.5 border border-slate-200 rounded-xl mb-4 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none transition" onkeyup="if(window.event.keyCode==13){checkPassword()}">
            <div class="flex gap-3">
                <button onclick="toggleLoginModal()" class="flex-1 py-3 bg-slate-100 rounded-xl text-slate-600 font-bold hover:bg-slate-200 transition">Cancel</button>
                <button onclick="checkPassword()" class="flex-1 py-3 bg-primary rounded-xl text-white font-bold hover:bg-slate-800 transition shadow-lg shadow-indigo-500/20">Login</button>
            </div>
        </div>
    </div>

    <!-- ì¶”ì²œ ëª¨ë‹¬ -->
    <div id="suggestionModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-96 max-w-[90%] fade-in border border-slate-100 m-4">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-lg font-bold text-slate-800"><i class="fa-regular fa-paper-plane mr-2 text-indigo-500"></i>Place Suggestion</h2>
                <button onclick="closeSuggestionModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="sugPlace" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ì¥ì†Œëª… (ì˜ˆ: ì˜¤ìŠ¤ ìƒì ê°€)">
                <textarea id="sugReason" rows="3" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ì¶”ì²œ ì´ìœ ë¥¼ ì ì–´ì£¼ì„¸ìš”."></textarea>
                <button onclick="submitSuggestion()" class="w-full bg-amber-400 hover:bg-amber-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-amber-500/20 transition text-sm">ë³´ë‚´ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê±´ì˜í•¨ (ê´€ë¦¬ì) -->
    <div id="adminSuggestionBox" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-[400px] max-w-[90%] h-[500px] flex flex-col fade-in m-4">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-inbox mr-2 text-amber-500"></i>Inbox</h2>
                <button onclick="closeAdminSuggestionBox()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="suggestionList" class="flex-1 overflow-y-auto space-y-2 pr-1">
                <!-- Content -->
            </div>
        </div>
    </div>

    <!-- ì¼ì • ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="addScheduleModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-[440px] max-w-[95%] max-h-[90dvh] overflow-y-auto fade-in m-4 border border-slate-100 relative">
            <div class="flex justify-between items-center mb-5 border-b border-slate-100 pb-3 sticky top-0 bg-white z-10">
                <h2 class="text-lg font-bold text-slate-800" id="modalTitle"><i class="fa-solid fa-pen-to-square mr-2 text-indigo-500"></i>ìƒˆ ì¼ì • ì¶”ê°€</h2>
                <button onclick="closeAddScheduleModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="space-y-5">
                <!-- ì¥ì†Œ ê²€ìƒ‰ ë° ì£¼ì†Œ -->
                <div class="space-y-3">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide">ì¥ì†Œ ê²€ìƒ‰</label>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <input type="text" id="searchAddressInput" class="w-full p-3 pl-9 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ì¥ì†Œëª… ë˜ëŠ” ì£¼ì†Œ (í•œêµ­ì–´/ì˜ì–´)" onkeyup="if(window.event.keyCode==13){searchAddress()}">
                            <i class="fa-solid fa-magnifying-glass absolute left-3.5 top-3.5 text-slate-400"></i>
                        </div>
                        <button onclick="searchAddress()" class="px-4 py-2 bg-slate-800 text-white rounded-xl text-sm font-bold hover:bg-slate-700 transition">ê²€ìƒ‰</button>
                    </div>
                    
                    <div>
                        <input type="text" id="addPlace" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 focus:border-indigo-500 outline-none transition bg-white" placeholder="ì¥ì†Œëª… (í‘œì‹œìš©)">
                    </div>
                    
                    <div class="relative">
                        <input type="text" id="addAddress" class="w-full p-3 pl-9 border border-slate-200 rounded-xl text-xs bg-slate-50 text-slate-500 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ìƒì„¸ ì£¼ì†Œ (ìë™ ì…ë ¥)">
                        <i class="fa-solid fa-map-pin absolute left-3.5 top-3.5 text-slate-400"></i>
                    </div>
                </div>

                <!-- ëˆ„êµ¬ì˜ Pick? -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">ëˆ„êµ¬ì˜ í”½?</label>
                    <div class="flex gap-2">
                        <div class="flex-1 relative">
                            <input type="radio" name="picker" id="picker_common" value="common" class="peer hidden pick-radio" checked>
                            <label for="picker_common" class="block w-full py-2 text-center border border-slate-200 rounded-lg text-xs font-bold text-slate-500 cursor-pointer hover:bg-slate-50 transition peer-checked:bg-slate-600 peer-checked:text-white peer-checked:border-slate-600">ê³µí†µ</label>
                        </div>
                        <div class="flex-1 relative">
                            <input type="radio" name="picker" id="picker_juice" value="juice" class="peer hidden pick-radio">
                            <label for="picker_juice" class="block w-full py-2 text-center border border-orange-200 rounded-lg text-xs font-bold text-orange-500 cursor-pointer hover:bg-orange-50 transition peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">Juice's Pick</label>
                        </div>
                        <div class="flex-1 relative">
                            <input type="radio" name="picker" id="picker_yumin" value="yumin" class="peer hidden pick-radio">
                            <label for="picker_yumin" class="block w-full py-2 text-center border border-indigo-200 rounded-lg text-xs font-bold text-indigo-500 cursor-pointer hover:bg-indigo-50 transition peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600">Yumin's Pick</label>
                        </div>
                    </div>
                </div>

                <!-- ì‹œê°„ (ë™ì ) -->
                <div id="timeSection">
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì‹œê°„</label>
                    <input type="time" id="addTime" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white">
                </div>

                <!-- ì¹´í…Œê³ ë¦¬ -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">ì¹´í…Œê³ ë¦¬</label>
                    <div class="grid grid-cols-5 gap-2" id="categoryGrid"></div>
                </div>

                <!-- ì´ë™ ìˆ˜ë‹¨ -->
                <div id="transportSection" class="hidden">
                     <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">ì´ê³³ê¹Œì§€ ì´ë™ ìˆ˜ë‹¨</label>
                     <div class="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100">
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div>
                                <input type="radio" name="moveType" id="move_walk" value="walk" class="hidden transport-radio" checked onchange="toggleTransportCost(false)">
                                <label for="move_walk" class="flex items-center justify-center py-2 rounded-lg border border-slate-200 bg-white text-xs text-slate-600 cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-person-walking mr-1"></i>ë„ë³´</label>
                            </div>
                            <div>
                                <input type="radio" name="moveType" id="move_bus" value="bus" class="hidden transport-radio" onchange="toggleTransportCost(true)">
                                <label for="move_bus" class="flex items-center justify-center py-2 rounded-lg border border-slate-200 bg-white text-xs text-slate-600 cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-bus mr-1"></i>ë²„ìŠ¤</label>
                            </div>
                            <div>
                                <input type="radio" name="moveType" id="move_subway" value="subway" class="hidden transport-radio" onchange="toggleTransportCost(true)">
                                <label for="move_subway" class="flex items-center justify-center py-2 rounded-lg border border-slate-200 bg-white text-xs text-slate-600 cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-train-subway mr-1"></i>ì§€í•˜ì² </label>
                            </div>
                        </div>
                        <div id="moveCostField" class="hidden">
                            <label class="text-[10px] font-bold text-slate-500 mb-1 block">ì´ë™ êµí†µë¹„ (JPY)</label>
                            <input type="number" id="addMoveCost" class="w-full p-2 border border-slate-200 rounded-lg text-sm text-right bg-white" placeholder="0">
                        </div>
                     </div>
                </div>

                <!-- ë™ì  í•„ë“œ (ë¹„ìš© ë“±) -->
                <div id="dynamicFields" class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100 hidden"></div>

                <!-- ë©”ëª¨ -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ë©”ëª¨</label>
                    <textarea id="addMemo" rows="2" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition resize-none" placeholder="ê¸°ì–µí•  ë‚´ìš©..."></textarea>
                </div>

                <button onclick="submitNewSchedule()" id="submitBtn" class="w-full bg-primary hover:bg-slate-800 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-slate-900/10 transition text-sm flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check"></i> ì¼ì • ì €ì¥í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import * as L from 'https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAhC1MM1KI759uNFhqyu1RNjmw0Xqez5E0",
            authDomain: "mytravelmap-4f52a.firebaseapp.com",
            projectId: "mytravelmap-4f52a",
            storageBucket: "mytravelmap-4f52a.firebasestorage.app",
            messagingSenderId: "1064774813139",
            appId: "1:1064774813139:web:29b2b9e3150fbbb2ad5b26"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        let map, markersLayer, pathLayer;
        let currentDay = 1;
        let isAdmin = false;
        const totalDays = 6;
        let isFirstLoad = true;
        let tempLatLng = null;
        let EXCHANGE_RATE = 9.1;
        
        window.tripItems = [];
        window.candidateItems = [];
        
        let editingId = null; 
        let isCandidateMode = false; 

        const categories = [
            { id: 'flight', label: 'í•­ê³µ', icon: 'âœˆï¸', color: 'text-indigo-600' },
            { id: 'hotel', label: 'ìˆ™ì†Œ', icon: 'ğŸ¨', color: 'text-blue-600' },
            { id: 'food', label: 'ë§›ì§‘', icon: 'ğŸ´', color: 'text-orange-500' },
            { id: 'cafe', label: 'ì¹´í˜', icon: 'â˜•', color: 'text-amber-700' },
            { id: 'attraction', label: 'ëª…ì†Œ', icon: 'ğŸ¡', color: 'text-purple-600' },
            { id: 'mart', label: 'ì‡¼í•‘', icon: 'ğŸ›ï¸', color: 'text-pink-600' },
            { id: 'convenience', label: 'í¸ì˜ì ', icon: 'ğŸª', color: 'text-cyan-500' },
            { id: 'bank', label: 'ì€í–‰', icon: 'ğŸ¦', color: 'text-gray-600' },
            { id: 'etc', label: 'ê¸°íƒ€', icon: 'ğŸ“', color: 'text-gray-400' },
        ];

        window.onload = async () => {
            initMap();
            renderDayTabs();
            renderCategoryGrid();
            fetchExchangeRate();
            updateMapWeather(35.1709, 136.8815); 
            
            try {
                await signInAnonymously(auth);
                subscribeToItinerary();
                subscribeToCandidates(); 
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }

            if(localStorage.getItem('travel_admin') === 'true') {
                grantAdminAccess();
            }
            updateAdminUI();
            setupEventListeners();
        };

        window.switchMainTab = (tabName) => {
            const itineraryView = document.getElementById('view-itinerary');
            const candidateView = document.getElementById('view-candidates');
            const tabItinerary = document.getElementById('tab-itinerary');
            const tabCandidates = document.getElementById('tab-candidates');

            if (tabName === 'itinerary') {
                itineraryView.classList.remove('hidden');
                candidateView.classList.add('hidden');
                tabItinerary.className = 'flex-1 py-3 text-sm text-center transition tab-active';
                tabCandidates.className = 'flex-1 py-3 text-sm text-center transition tab-inactive';
                markersLayer.clearLayers();
                pathLayer.clearLayers();
                subscribeToItinerary(); 
            } else {
                itineraryView.classList.add('hidden');
                candidateView.classList.remove('hidden');
                tabItinerary.className = 'flex-1 py-3 text-sm text-center transition tab-inactive';
                tabCandidates.className = 'flex-1 py-3 text-sm text-center transition tab-active';
                markersLayer.clearLayers();
                pathLayer.clearLayers();
                renderCandidatesOnMap(); 
            }
        };

        window.openQuickAddModal = () => {
            if(!isAdmin) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
            const isCandidateTab = !document.getElementById('view-candidates').classList.contains('hidden');
            openAddScheduleModal(null, null, 'etc', isCandidateTab);
        };

        // --- í˜„ì¬ ë‚ ì”¨ ìƒì„¸ ëª¨ë‹¬ ---
        window.openCurrentWeatherModal = async () => {
            const center = map.getCenter();
            document.getElementById('currentWeatherModal').classList.remove('hidden');
            document.getElementById('curWeatherDescBig').innerText = "ë°ì´í„° ì¡°íšŒ ì¤‘...";
            document.getElementById('curWeatherAddress').innerText = "ì£¼ì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

            try {
                const addrRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}&zoom=18&addressdetails=1`);
                const addrData = await addrRes.json();
                if(addrData && addrData.display_name) {
                    const parts = addrData.display_name.split(',');
                    document.getElementById('curWeatherAddress').innerText = parts.slice(0, 4).join(', ');
                } else {
                    document.getElementById('curWeatherAddress').innerText = "ì£¼ì†Œ ì •ë³´ ì—†ìŒ";
                }
            } catch(e) { document.getElementById('curWeatherAddress').innerText = "ì£¼ì†Œ í™•ì¸ ë¶ˆê°€"; }

            try {
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${center.lat}&longitude=${center.lng}&current_weather=true&hourly=relativehumidity_2m&timezone=Asia%2FTokyo`);
                const wData = await weatherRes.json();
                
                if(wData && wData.current_weather) {
                    const temp = wData.current_weather.temperature;
                    const code = wData.current_weather.weathercode;
                    const wind = wData.current_weather.windspeed;
                    const { icon, desc } = getWeatherIcon(code);
                    
                    document.getElementById('curWeatherTempBig').innerText = `${temp}Â°C`;
                    document.getElementById('curWeatherIconBig').innerHTML = icon;
                    document.getElementById('curWeatherDescBig').innerText = desc;
                    document.getElementById('curWind').innerText = `${wind} km/h`;
                }
            } catch(e) {
                document.getElementById('curWeatherDescBig').innerText = "ë‚ ì”¨ ì •ë³´ ì˜¤ë¥˜";
            }
        };

        // Edit Function - Fixed Logic
        window.editItem = async (id, isCandidate = false) => {
            let item;
            if (isCandidate) {
                 item = window.candidateItems.find(i => i.id === id);
            } else {
                 item = window.tripItems.find(i => i.id === id);
            }
            
            if(!item) return alert("í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            // 1. Open Modal FIRST (this resets editingId inside openAddScheduleModal if logic was there, but we will fix that)
            // We pass null lat/lng so it doesn't try to reverse-geocode immediately, we will fill it from item
            await openAddScheduleModal(item.lat, item.lng, item.category, isCandidate);

            // 2. Set editingId AFTER opening modal so it persists
            editingId = id;

            document.getElementById('modalTitle').innerText = isCandidate ? 'í›„ë³´ ì¥ì†Œ ìˆ˜ì •' : 'ì¼ì • ìˆ˜ì •';
            document.getElementById('submitBtn').innerHTML = '<i class="fa-solid fa-pen mr-1"></i> ìˆ˜ì • ì™„ë£Œ';

            document.getElementById('addPlace').value = item.place;
            document.getElementById('addAddress').value = item.address || '';
            document.getElementById('addMemo').value = item.memo || '';
            
            const pickerRadios = document.querySelectorAll('input[name="picker"]');
            pickerRadios.forEach(r => r.checked = false);
            if(item.picker) {
                const radio = document.querySelector(`input[name="picker"][value="${item.picker}"]`);
                if(radio) radio.checked = true;
            } else {
                document.getElementById('picker_common').checked = true;
            }

            if(item.time) document.getElementById('addTime').value = item.time;
            if(item.depTime) document.getElementById('addDepTime').value = item.depTime;
            if(item.arrTime) document.getElementById('addArrTime').value = item.arrTime;
            if(item.checkIn) document.getElementById('addCheckIn').value = item.checkIn;
            if(item.checkOut) document.getElementById('addCheckOut').value = item.checkOut;

            window.currentCurrency = 'JPY';
            document.getElementById('addCost').value = item.cost || 0;
            window.calcConversion(item.cost || 0);

            if(document.getElementById('addMenu')) document.getElementById('addMenu').value = item.menu || '';
            if(document.getElementById('addReserved')) document.getElementById('addReserved').checked = item.isReserved || false;
            if(document.getElementById('addFlightNum')) document.getElementById('addFlightNum').value = item.flightNum || '';
            
            if (item.moveType) {
                const moveRadio = document.querySelector(`input[name="moveType"][value="${item.moveType}"]`);
                if(moveRadio) {
                    moveRadio.checked = true;
                    window.toggleTransportCost(item.moveType !== 'walk');
                    if(item.moveCost) document.getElementById('addMoveCost').value = item.moveCost;
                }
            }

            tempLatLng = { lat: item.lat, lng: item.lng };
        };

        function subscribeToCandidates() {
            const colRef = collection(db, 'trips', appId, 'candidates');
            onSnapshot(colRef, (snapshot) => {
                const list = document.getElementById('candidateList');
                list.innerHTML = '';
                window.candidateItems = [];
                snapshot.forEach(doc => window.candidateItems.push({ id: doc.id, ...doc.data() }));

                const dayCandidates = window.candidateItems.filter(item => item.day === currentDay);

                if(dayCandidates.length === 0) {
                    list.innerHTML = '<div class="text-center text-slate-400 mt-10">Day ' + currentDay + 'ì— ë“±ë¡ëœ í›„ë³´ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }

                dayCandidates.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition cursor-pointer relative';
                    el.onclick = () => { if(item.lat) map.flyTo([item.lat, item.lng], 16); };
                    
                    const catObj = categories.find(c => c.id === item.category) || categories.find(c => c.id === 'etc');

                    el.innerHTML = `
                        <div class="flex items-start gap-3">
                            <div class="text-xl w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-500">
                                ${catObj.icon}
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-slate-800">${item.place}</h4>
                                <p class="text-xs text-slate-400 mt-1 truncate"><i class="fa-solid fa-map-pin mr-1"></i>${item.address || '-'}</p>
                                <p class="text-sm text-slate-600 mt-1">${item.memo || ''}</p>
                            </div>
                        </div>
                        ${isAdmin ? `
                        <div class="absolute top-2 right-2 flex gap-1">
                            <button onclick="event.stopPropagation(); window.editItem('${item.id}', true)" class="text-slate-300 hover:text-indigo-500 p-2"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="event.stopPropagation(); window.deleteCandidate('${item.id}')" class="text-slate-300 hover:text-rose-500 p-2"><i class="fa-solid fa-trash-can"></i></button>
                        </div>` : ''}
                    `;
                    list.appendChild(el);
                });

                if(!document.getElementById('view-candidates').classList.contains('hidden')) {
                    renderCandidatesOnMap();
                }
            });
        }

        function renderCandidatesOnMap() {
            markersLayer.clearLayers();
            const dayCandidates = window.candidateItems.filter(item => item.day === currentDay);
            dayCandidates.forEach(item => {
                if(item.lat) {
                    const markerIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #64748b; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 16px; color: white;">?</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });
                    const marker = L.marker([item.lat, item.lng], {icon: markerIcon}).addTo(markersLayer);
                    marker.bindPopup(`<div class="text-center font-bold text-sm p-2">${item.place}<br><span class="text-xs font-normal text-slate-500">Day ${currentDay} í›„ë³´</span></div>`);
                }
            });
        }

        // Deletion Functions
        window.deleteCandidate = async (id) => {
            if(confirm("ì´ í›„ë³´ ì¥ì†Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await deleteDoc(doc(db, 'trips', appId, 'candidates', id));
        }

        window.deleteItem = async (id) => {
            if(confirm("ì´ ì¼ì •ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await deleteDoc(doc(db, 'trips', appId, 'itineraries', id));
        }

        async function fetchExchangeRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await res.json();
                if (data && data.rates && data.rates.KRW) {
                    EXCHANGE_RATE = data.rates.KRW;
                    document.getElementById('exchangeRateDisplay').innerText = `í˜„ì¬ í™˜ìœ¨: Â¥100 = â‚©${(EXCHANGE_RATE * 100).toFixed(0)}`;
                }
            } catch (e) {
                document.getElementById('exchangeRateDisplay').innerText = `ì˜ˆìƒ í™˜ìœ¨: Â¥100 = â‚©910 (ê¸°ë³¸ê°’)`;
            }
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([35.1709, 136.8815], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            pathLayer = L.layerGroup().addTo(map);

            map.on('click', function(e) {
                if(!isAdmin) return;
                const isCandidateTab = !document.getElementById('view-candidates').classList.contains('hidden');
                openAddScheduleModal(e.latlng.lat, e.latlng.lng, 'etc', isCandidateTab);
            });
            
            map.on('moveend', function() {
                const center = map.getCenter();
                updateMapWeather(center.lat, center.lng);
            });
        }

        function renderDayTabs() {
            const container = document.getElementById('dayTabs');
            container.innerHTML = '';
            for(let i=1; i<=totalDays; i++) {
                const btn = document.createElement('button');
                const isActive = currentDay === i;
                btn.className = `px-5 py-2 text-sm font-bold rounded-full whitespace-nowrap transition-all duration-200 border ${isActive ? 'bg-primary text-white border-primary shadow-md transform scale-105' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50 hover:border-slate-300'}`;
                btn.innerText = `Day ${i}`;
                btn.onclick = () => { 
                    currentDay = i; 
                    isFirstLoad = true;
                    document.getElementById('candidateDayDisplay').innerText = i;
                    renderDayTabs(); 
                    subscribeToItinerary(); 
                    subscribeToCandidates();
                };
                container.appendChild(btn);
            }
        }

        function renderCategoryGrid() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = categories.map(cat => `
                <div class="relative group">
                    <input type="radio" name="category" id="cat_${cat.id}" value="${cat.id}" class="peer hidden category-radio" ${cat.id === 'etc' ? 'checked' : ''} onchange="updateDynamicFields(this.value)">
                    <label for="cat_${cat.id}" class="flex flex-col items-center justify-center p-2.5 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition h-full text-center">
                        <span class="text-xl mb-1 filter drop-shadow-sm group-hover:scale-110 transition">${cat.icon}</span>
                        <span class="text-[10px] text-slate-500 whitespace-nowrap font-medium">${cat.label}</span>
                    </label>
                </div>
            `).join('');
        }

        // Function to fetch address from lat/lng (Reverse Geocoding)
        window.fetchAddress = async (lat, lng) => {
            document.getElementById('addAddress').value = "ì£¼ì†Œ ê²€ìƒ‰ ì¤‘...";
            try {
                // Use addressdetails=1 to get more specific info
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=ko,en`);
                const data = await res.json();
                if(data && data.display_name) {
                    // Try to get a shorter name if possible
                    document.getElementById('addAddress').value = data.display_name;
                    
                    // If place name is empty, try to fill it with a landmark name from address
                    if (!document.getElementById('addPlace').value) {
                         const placeName = data.address.amenity || data.address.shop || data.address.tourism || data.address.historic || data.address.building || "ìƒˆë¡œìš´ ì¥ì†Œ";
                         document.getElementById('addPlace').value = placeName;
                    }
                } else {
                    document.getElementById('addAddress').value = "ì£¼ì†Œ ì •ë³´ ì—†ìŒ";
                }
            } catch(e) {
                console.error(e);
                document.getElementById('addAddress').value = "ì£¼ì†Œ í™•ì¸ ë¶ˆê°€";
            }
        };

        window.openAddScheduleModal = async (lat, lng, preSelectCat = null, forCandidate = false) => {
            const modal = document.getElementById('addScheduleModal');
            
            // IMPORTANT: Reset editing state here, but editItem will override it immediately after calling this
            editingId = null;
            isCandidateMode = forCandidate;
            
            document.getElementById('modalTitle').innerText = forCandidate ? 'ìƒˆ í›„ë³´ ì¥ì†Œ ì¶”ê°€' : 'ìƒˆ ì¼ì • ì¶”ê°€';
            document.getElementById('submitBtn').innerHTML = '<i class="fa-solid fa-check mr-1"></i> ì €ì¥í•˜ê¸°';

            document.getElementById('searchAddressInput').value = '';
            document.getElementById('addPlace').value = preSelectCat === 'flight' ? 'ë‚˜ê³ ì•¼ ì¤‘ë¶€êµ­ì œê³µí•­' : '';
            document.getElementById('addMemo').value = '';
            document.getElementById('addAddress').value = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';
            document.getElementById('move_walk').checked = true; 
            
            const pickerRadios = document.querySelectorAll('input[name="picker"]');
            pickerRadios.forEach(r => r.checked = false);
            document.getElementById('picker_common').checked = true; 
            
            window.toggleTransportCost(false);
            
            let targetCat = preSelectCat || 'etc';
            document.getElementById(`cat_${targetCat}`).checked = true;
            
            window.currentCurrency = 'JPY'; 
            window.updateDynamicFields(targetCat);
            
            if (!lat || !lng) {
                tempLatLng = null; 
                document.getElementById('addAddress').value = 'ì§ì ‘ ì…ë ¥';
            } else {
                tempLatLng = { lat, lng };
                await fetchAddress(lat, lng);
            }

            modal.classList.remove('hidden');
            setTimeout(() => document.getElementById('searchAddressInput').focus(), 100);
        };

        window.closeAddScheduleModal = () => document.getElementById('addScheduleModal').classList.add('hidden');

        window.submitNewSchedule = async () => {
            if(!isAdmin) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
            
            const place = document.getElementById('addPlace').value;
            const memo = document.getElementById('addMemo').value;
            const address = document.getElementById('addAddress').value;
            const selectedCatId = document.querySelector('input[name="category"]:checked').value;
            const categoryObj = categories.find(c => c.id === selectedCatId);
            
            let picker = 'common';
            const checkedPicker = document.querySelector('input[name="picker"]:checked');
            if (checkedPicker) picker = checkedPicker.value;

            let time = '', depTime = '', arrTime = '', checkIn = '', checkOut = '';
            if(selectedCatId === 'flight') {
                depTime = document.getElementById('addDepTime')?.value || '';
                arrTime = document.getElementById('addArrTime')?.value || '';
                time = depTime; 
            } else if(selectedCatId === 'hotel') {
                checkIn = document.getElementById('addCheckIn')?.value || '';
                checkOut = document.getElementById('addCheckOut')?.value || '';
                time = checkIn; 
            } else {
                time = document.getElementById('addTime')?.value || '';
            }

            let moveType = 'walk';
            let moveCost = 0;
            if(selectedCatId !== 'flight') {
                const moveTypeInput = document.querySelector('input[name="moveType"]:checked');
                if(moveTypeInput) {
                    moveType = moveTypeInput.value;
                    if(moveType !== 'walk') {
                        moveCost = parseInt(document.getElementById('addMoveCost').value) || 0;
                    }
                }
            }

            const costInput = document.getElementById('addCost');
            let costJPY = 0;
            if (costInput && costInput.value) {
                const val = parseInt(costInput.value) || 0;
                costJPY = window.currentCurrency === 'JPY' ? val : Math.round(val / EXCHANGE_RATE);
            }

            const menu = document.getElementById('addMenu')?.value || '';
            const isReserved = document.getElementById('addReserved')?.checked || false;
            const flightNum = document.getElementById('addFlightNum')?.value || '';

            if(!place) return alert("ì¥ì†Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");

            const docData = {
                place, time, memo, address,
                category: selectedCatId,
                categoryIcon: categoryObj.icon,
                picker, 
                cost: costJPY, 
                moveType, moveCost, 
                depTime, arrTime, 
                checkIn, checkOut, 
                menu, isReserved, flightNum,
                updatedAt: new Date().toISOString()
            };

            if(!editingId) {
                docData.day = currentDay;
                docData.createdAt = new Date().toISOString();
            }

            if(tempLatLng && selectedCatId !== 'flight') {
                docData.lat = tempLatLng.lat;
                docData.lng = tempLatLng.lng;
            }

            try {
                // Determine collection: if editing, use current mode, but check if we need to be careful
                // For simplicity, we trust isCandidateMode which is set during open/edit.
                const collectionName = isCandidateMode ? 'candidates' : 'itineraries';
                const colRef = collection(db, 'trips', appId, collectionName);

                if (editingId) {
                    await updateDoc(doc(colRef, editingId), docData);
                } else {
                    await addDoc(colRef, docData);
                }
                
                window.closeAddScheduleModal();
            } catch (e) { 
                console.error(e); 
                alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); 
            }
        };

        window.searchAddress = async () => {
            const query = document.getElementById('searchAddressInput').value;
            if(!query) return alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
            try {
                // Updated Search Logic: Added accept-language and addressdetails
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&accept-language=ko,en&addressdetails=1`);
                const data = await res.json();
                
                if(data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    
                    map.setView([lat, lon], 16);
                    tempLatLng = { lat, lng: lon };
                    
                    // Name handling: use the searched query if result name is generic or use result display_name
                    document.getElementById('addPlace').value = query; // Keep user query as place name (often more accurate for "McDonalds Sakae")
                    document.getElementById('addAddress').value = result.display_name;
                    updateMapWeather(lat, lon);
                } else { 
                    alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì£¼ì†Œê°€ ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”."); 
                }
            } catch(e) { console.error(e); alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }
        };

        window.updateDynamicFields = (catId) => {
             const container = document.getElementById('dynamicFields');
             const timeSection = document.getElementById('timeSection');
             const transportSection = document.getElementById('transportSection');
             container.innerHTML = ''; container.classList.remove('hidden'); transportSection.classList.remove('hidden');
             
             timeSection.innerHTML = `<label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì‹œê°„</label><input type="time" id="addTime" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white">`;

             const getCostInput = (label = 'ì˜ˆìƒ ë¹„ìš©') => `
                <div class="bg-white p-3 rounded-lg border border-indigo-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2"><label class="text-xs font-bold text-slate-600">${label}</label><div class="flex bg-slate-100 rounded-md p-0.5"><button type="button" onclick="setCurrency('JPY')" id="btn-JPY" class="px-2 py-0.5 text-[10px] font-bold rounded ${window.currentCurrency==='JPY'?'bg-white shadow text-indigo-600':'text-slate-400'}">JPY</button><button type="button" onclick="setCurrency('KRW')" id="btn-KRW" class="px-2 py-0.5 text-[10px] font-bold rounded ${window.currentCurrency==='KRW'?'bg-white shadow text-indigo-600':'text-slate-400'}">KRW</button></div></div>
                    <div class="flex items-center gap-2"><span class="text-sm font-bold text-slate-400 w-4 text-center" id="currencySymbol">Â¥</span><input type="number" id="addCost" oninput="calcConversion(this.value)" class="flex-1 p-1 bg-transparent border-b border-slate-200 text-sm font-bold text-right focus:outline-none focus:border-indigo-500" placeholder="0"></div><div class="text-right text-xs text-indigo-500 font-bold mt-1" id="convertedPreview">â‰ˆ 0ì›</div>
                </div>`;

             if(catId === 'flight') {
                 transportSection.classList.add('hidden');
                 timeSection.innerHTML = `<div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì¶œë°œ</label><input type="time" id="addDepTime" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white"></div><div><label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ë„ì°©</label><input type="time" id="addArrTime" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white"></div></div>`;
                 container.innerHTML = `<div class="mb-3"><label class="block text-[10px] font-bold text-slate-500 mb-1">í¸ëª…</label><input type="text" id="addFlightNum" class="w-full p-2 border border-slate-200 rounded-lg text-sm bg-white" placeholder="KE123"></div>${getCostInput('í•­ê³µê¶Œ ë¹„ìš©')}`;
             } else if(catId === 'hotel') {
                 timeSection.innerHTML = `<div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì²´í¬ì¸</label><input type="time" id="addCheckIn" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white"></div><div><label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì²´í¬ì•„ì›ƒ</label><input type="time" id="addCheckOut" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white"></div></div>`;
                 container.innerHTML = `<div class="flex items-center justify-between mb-3 bg-white p-3 rounded-lg border border-indigo-100 shadow-sm"><span class="text-xs font-bold text-slate-600">ì˜ˆì•½</span><div class="relative inline-block w-10 h-5 align-middle select-none"><input type="checkbox" name="toggle" id="addReserved" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300"/><label for="addReserved" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer transition-all duration-300"></label></div></div>${getCostInput('ìˆ™ë°•ë¹„')}`;
             } else if(catId === 'food' || catId === 'cafe') {
                 container.innerHTML = `<div class="mb-2"><label class="block text-xs font-bold text-slate-600 mb-1">ì¶”ì²œ ë©”ë‰´</label><input type="text" id="addMenu" class="w-full p-2 border border-slate-200 rounded text-sm bg-white" placeholder="ì˜ˆ: íˆì¸ ë§ˆë¶€ì‹œ"></div>${getCostInput('ì˜ˆìƒ ì‹ë¹„')}`;
             } else if(catId === 'attraction') {
                 container.innerHTML = getCostInput('ì…ì¥ë£Œ');
             } else if(['mart', 'convenience', 'etc', 'bank'].includes(catId)) {
                 container.innerHTML = getCostInput('ì˜ˆìƒ ë¹„ìš©');
             } else {
                 container.classList.add('hidden');
             }
        };

        window.toggleTransportCost = (show) => { const f=document.getElementById('moveCostField'); if(show){f.classList.remove('hidden');}else{f.classList.add('hidden');} };
        window.setCurrency = (curr) => { window.currentCurrency = curr; document.getElementById('btn-JPY').className = `px-2 py-0.5 text-[10px] font-bold rounded ${curr==='JPY'?'bg-white shadow text-indigo-600':'text-slate-400'}`; document.getElementById('btn-KRW').className = `px-2 py-0.5 text-[10px] font-bold rounded ${curr==='KRW'?'bg-white shadow text-indigo-600':'text-slate-400'}`; document.getElementById('currencySymbol').innerText = curr === 'JPY' ? 'Â¥' : 'â‚©'; const val = document.getElementById('addCost').value; if(val) window.calcConversion(val); };
        window.calcConversion = (val) => { if(!val){document.getElementById('convertedPreview').innerText='';return;} if(window.currentCurrency==='JPY'){const krw=Math.round(val*EXCHANGE_RATE);document.getElementById('convertedPreview').innerText=`â‰ˆ ${krw.toLocaleString()}ì›`;}else{const jpy=Math.round(val/EXCHANGE_RATE);document.getElementById('convertedPreview').innerText=`â‰ˆ ${jpy.toLocaleString()}ì—”`;} };
        async function updateMapWeather(lat, lng) { try{const res=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);const data=await res.json();if(data&&data.current_weather){document.getElementById('weatherTemp').innerText=`${data.current_weather.temperature}Â°C`;document.getElementById('weatherDesc').innerText=getWeatherIcon(data.current_weather.weathercode).desc;document.getElementById('weatherIcon').innerHTML=getWeatherIcon(data.current_weather.weathercode).icon;}}catch(e){} }
        function getWeatherIcon(code) { if(code===0)return{icon:'<i class="fa-solid fa-sun text-orange-400"></i>',desc:'ë§‘ìŒ'}; return{icon:'<i class="fa-solid fa-cloud text-slate-400"></i>',desc:'íë¦¼'}; }

        function updateAdminUI() {
            const isHidden = !isAdmin;
            document.getElementById('authStatus').classList.toggle('hidden', isHidden);
            document.getElementById('loginBtn').classList.toggle('hidden', !isHidden);
            document.getElementById('logoutBtn').classList.toggle('hidden', isHidden);
            document.getElementById('quickControls').classList.toggle('hidden', isHidden); 
            document.getElementById('adminSuggestionBtn').classList.toggle('hidden', isHidden);
        }

        window.toggleLoginModal = () => document.getElementById('loginModal').classList.toggle('hidden');
        window.checkPassword = () => {
            if(document.getElementById('passwordInput').value === 'rlarlqja01!') {
                grantAdminAccess();
                localStorage.setItem('travel_admin', 'true');
                window.toggleLoginModal();
            } else { alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜"); }
        };
        
        window.logout = () => {
            if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('travel_admin');
                location.reload();
            }
        };
        
        function grantAdminAccess() { isAdmin = true; updateAdminUI(); subscribeToItinerary(); subscribeToCandidates(); }

        function subscribeToItinerary() {
            if (window.unsub) window.unsub();
            const colRef = collection(db, 'trips', appId, 'itineraries');
            
            window.unsub = onSnapshot(colRef, (snapshot) => {
                const listContainer = document.getElementById('itineraryList');
                listContainer.innerHTML = '';
                markersLayer.clearLayers();
                pathLayer.clearLayers(); 
                
                const items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                window.tripItems = items; 

                const dayItems = items.filter(item => item.day === currentDay);
                const fixedItems = dayItems.filter(item => item.category === 'flight' || item.category === 'hotel')
                                            .sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
                const timelineItems = dayItems.filter(item => item.category !== 'flight' && item.category !== 'hotel')
                                             .sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));

                let totalDailyCost = 0;
                let pathPoints = []; 

                if (dayItems.length === 0) {
                    listContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-64 text-slate-300"><i class="fa-regular fa-map text-4xl mb-3"></i><p class="text-sm">ì¼ì •ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p></div>';
                    document.getElementById('dailySummary').classList.add('hidden');
                } else {
                    document.getElementById('dailySummary').classList.remove('hidden');
                    if (isFirstLoad) {
                        const firstTarget = timelineItems[0] || fixedItems[0];
                        if (firstTarget && firstTarget.lat && firstTarget.lng) {
                            map.flyTo([firstTarget.lat, firstTarget.lng], 14, { duration: 1.5 });
                            isFirstLoad = false;
                        }
                    }
                }

                const renderItem = (item, isFixed) => {
                    const catObj = categories.find(c => c.id === item.category) || categories.find(c => c.id === 'etc');
                    const isFlight = item.category === 'flight';
                    const isHotel = item.category === 'hotel';

                    if (!isFixed) {
                        totalDailyCost += (item.cost || 0) + (item.moveCost || 0);
                    }

                    if (!isFixed && item.lat && item.lng) {
                        pathPoints.push({
                            lat: item.lat, lng: item.lng, moveType: item.moveType || 'walk',
                            color: item.moveType === 'walk' ? '#94a3b8' : (item.moveType === 'bus' ? '#6366f1' : '#10b981')
                        });
                    }

                    if (item.lat) {
                        const markerColor = isFlight ? '#6366f1' : (isHotel ? '#2563eb' : '#ffffff');
                        const markerIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: ${markerColor}; border: 2px solid white; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.2); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 20px;">${item.categoryIcon || catObj.icon}</div>`,
                            iconSize: [40, 40],
                            iconAnchor: [20, 20],
                            popupAnchor: [0, -20]
                        });
                        const marker = L.marker([item.lat, item.lng], {icon: markerIcon}).addTo(markersLayer);
                        marker.bindPopup(`<div class="text-center min-w-[160px] p-2 font-sans"><div class="text-2xl mb-2">${item.categoryIcon || catObj.icon}</div><h3 class="font-bold mb-1 text-slate-800 text-sm">${item.place}</h3></div>`, { className: 'rounded-xl shadow-xl border-0' });
                    }

                    let cardClasses = 'p-4 rounded-xl border shadow-sm transition group relative mb-3';
                    let bgClass = 'bg-white';
                    let borderClass = 'border-slate-200';
                    let pickBadge = '';

                    if (item.picker === 'juice') {
                        bgClass = 'bg-orange-50';
                        borderClass = 'border-orange-200';
                        pickBadge = `<div class="absolute top-2 right-2 text-[8px] font-bold text-orange-600 bg-white/80 px-1.5 py-0.5 rounded border border-orange-100 shadow-sm z-10">Juice's Pick</div>`;
                    } else if (item.picker === 'yumin') {
                        bgClass = 'bg-indigo-50';
                        borderClass = 'border-indigo-200';
                        pickBadge = `<div class="absolute top-2 right-2 text-[8px] font-bold text-indigo-600 bg-white/80 px-1.5 py-0.5 rounded border border-indigo-100 shadow-sm z-10">Yumin's Pick</div>`;
                    }

                    if (isFixed) {
                         if (isFlight) {
                             bgClass = 'bg-indigo-50/60'; borderClass = 'border-indigo-200';
                         } else if (isHotel) {
                             bgClass = 'bg-blue-50/60'; borderClass = 'border-blue-200';
                         }
                         cardClasses += ` ${bgClass} ${borderClass}`;
                    } else {
                        cardClasses += ` timeline-item pl-12 hover:shadow-md ${bgClass} ${borderClass}`;
                    }
                    
                    const el = document.createElement('div');
                    el.className = cardClasses;
                    el.onclick = () => { if(item.lat) map.flyTo([item.lat, item.lng], 16); };
                    
                    let editBtn = '';
                    if (isAdmin) {
                        editBtn = `
                        <div class="absolute top-6 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition z-20">
                            <button onclick="event.stopPropagation(); window.editItem('${item.id}')" class="text-slate-400 hover:text-indigo-500 p-1"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="event.stopPropagation(); window.deleteItem('${item.id}')" class="text-slate-400 hover:text-rose-500 p-1"><i class="fa-solid fa-trash-can"></i></button>
                        </div>`;
                    }

                    // Add Pin Icon for Fixed Items
                    let pinBadge = '';
                    if (isFixed) {
                        pinBadge = `<div class="absolute -top-2 -right-2 bg-white text-indigo-500 w-7 h-7 flex items-center justify-center rounded-full border border-indigo-100 shadow-sm z-20" title="Fixed Schedule"><i class="fa-solid fa-thumbtack transform rotate-45 text-xs"></i></div>`;
                    }

                    let timeDisplay = item.time || '';
                    if (isFlight) timeDisplay = `${item.depTime || '?'} <i class="fa-solid fa-arrow-right text-[10px] mx-1"></i> ${item.arrTime || '?'}`;
                    else if (isHotel) timeDisplay = `In ${item.checkIn || '-'} / Out ${item.checkOut || '-'}`;

                    let costDisplay = '';
                    const totalItemCost = (item.cost || 0);
                    if (totalItemCost > 0) {
                        const krw = Math.round(totalItemCost * EXCHANGE_RATE).toLocaleString();
                        costDisplay = `<span class="text-indigo-600 font-bold text-sm bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100">Â¥${totalItemCost.toLocaleString()} <span class="text-[10px] text-slate-400 font-normal">(ì•½ ${krw}ì›)</span></span>`;
                    }
                    if(item.moveCost > 0) {
                        const mKrw = Math.round(item.moveCost * EXCHANGE_RATE).toLocaleString();
                        costDisplay += `<div class="text-[10px] text-slate-400 mt-0.5 ml-1"><i class="fa-solid fa-ticket mr-1"></i>ì´ë™: Â¥${item.moveCost} (${mKrw}ì›)</div>`;
                    }

                    let tags = '';
                    if (item.menu) tags += `<span class="bg-orange-50 text-orange-600 px-1.5 py-0.5 rounded text-[10px] border border-orange-100 font-medium">ğŸ½ï¸ ${item.menu}</span> `;
                    if (isHotel) {
                        tags += item.isReserved 
                            ? `<span class="bg-emerald-50 text-emerald-600 px-1.5 py-0.5 rounded text-[10px] border border-emerald-100 font-bold">âœ… ì˜ˆì•½í™•ì •</span> ` 
                            : `<span class="bg-rose-50 text-rose-600 px-1.5 py-0.5 rounded text-[10px] border border-rose-100 font-bold">â³ ë¯¸ì˜ˆì•½</span> `;
                    }
                    if (item.flightNum) tags += `<span class="bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded text-[10px] border border-indigo-100 font-bold">âœˆï¸ ${item.flightNum}</span> `;

                    let moveIcon = '';
                    if(!isFixed && !isFlight) { 
                        if(item.moveType === 'bus') moveIcon = '<i class="fa-solid fa-bus text-indigo-500 mr-1"></i>';
                        else if(item.moveType === 'subway') moveIcon = '<i class="fa-solid fa-train-subway text-emerald-500 mr-1"></i>';
                        else moveIcon = '<i class="fa-solid fa-person-walking text-slate-400 mr-1"></i>';
                    }

                    el.innerHTML = `
                        ${pickBadge}
                        ${pinBadge}
                        <div class="${isFixed ? 'text-xl z-10 w-10 h-10 flex items-center justify-center bg-white rounded-full border border-white shadow-md mb-2' : 'text-xl z-10 w-9 h-9 flex items-center justify-center bg-white rounded-full border border-slate-100 shadow-sm absolute left-3 top-4'}">${item.categoryIcon || catObj.icon}</div>
                        <div class="${isFixed ? 'flex flex-col' : ''}">
                            <div class="flex justify-between items-start mb-1 w-full gap-2">
                                <h4 class="font-bold text-slate-800 text-base flex-1 leading-tight ${isFlight ? 'text-indigo-800' : ''} ${isHotel ? 'text-blue-800' : ''}">${item.place}</h4>
                                <span class="text-xs font-bold bg-white/80 border border-slate-100 text-slate-600 px-2 py-1 rounded-lg shadow-sm whitespace-nowrap shrink-0 ml-auto">${timeDisplay || '-'}</span>
                            </div>
                            <p class="text-xs text-slate-400 truncate">${item.address || ''}</p>
                            ${moveIcon ? `<div class="text-[10px] text-slate-500 mb-1 flex items-center bg-slate-50 inline-block px-1.5 rounded border border-slate-100 w-fit mt-1">${moveIcon} ì´ë™</div>` : ''}
                            <div class="flex flex-wrap gap-1 mb-1">${tags}</div>
                            ${costDisplay ? `<div class="flex flex-col mt-1">${costDisplay}</div>` : ''}
                            ${item.memo ? `<p class="text-sm text-slate-600 mt-2 bg-slate-50/50 p-2 rounded-lg border border-slate-100/50">${item.memo}</p>` : ''}
                        </div>
                        ${editBtn}
                    `;
                    listContainer.appendChild(el);
                };

                fixedItems.forEach(item => renderItem(item, true));
                timelineItems.forEach(item => renderItem(item, false));

                document.getElementById('dailyTotalJPY').innerText = `Â¥${totalDailyCost.toLocaleString()}`;
                const totalKRW = Math.round(totalDailyCost * EXCHANGE_RATE).toLocaleString();
                document.getElementById('dailyTotalKRW').innerText = `â‰ˆ ${totalKRW}ì›`;

                if (pathPoints.length > 1) {
                    for (let i = 0; i < pathPoints.length - 1; i++) {
                        const start = pathPoints[i];
                        const end = pathPoints[i+1];
                        const color = end.moveType === 'bus' ? '#6366f1' : (end.moveType === 'subway' ? '#10b981' : '#94a3b8');
                        L.polyline([[start.lat, start.lng], [end.lat, end.lng]], {
                            color: color, weight: 3, opacity: 0.7, dashArray: end.moveType === 'walk' ? '5, 10' : null, lineCap: 'round'
                        }).addTo(pathLayer);
                    }
                }
            });
        }

        document.getElementById('openSidebar').onclick = () => document.getElementById('sidebar').classList.remove('-translate-x-full');
        document.getElementById('closeSidebarMobile').onclick = () => document.getElementById('sidebar').classList.add('-translate-x-full');
        
        function setupEventListeners() {
            document.addEventListener('keydown', (e) => { 
                if(e.key === "Escape") { 
                    document.getElementById('loginModal').classList.add('hidden');
                    window.closeSuggestionModal();
                    window.closeAddScheduleModal();
                    window.closeAdminSuggestionBox();
                    window.closeWeatherForecastModal();
                    document.getElementById('currentWeatherModal').classList.add('hidden');
                }
            });
        }
    </script>
</body>
</html>
