<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ê³ ì•¼ ì—¬í–‰ - Premium Itinerary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans KR', 'sans-serif'],
                    },
                    colors: {
                        primary: '#0f172a', /* Slate 900 */
                        secondary: '#334155', /* Slate 700 */
                        accent: '#6366f1', /* Indigo 500 */
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .map-container { z-index: 1; }
        .sidebar { z-index: 20; box-shadow: 4px 0 24px rgba(0,0,0,0.08); }
        
        /* Category Radio Styling */
        .category-radio:checked + label {
            background-color: #f1f5f9;
            border-color: #6366f1;
            color: #4338ca;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);
            font-weight: 700;
        }
        .transport-radio:checked + label {
            background-color: #e0e7ff;
            color: #4338ca;
            border-color: #6366f1;
            font-weight: bold;
        }

        /* Timeline Line (ì¼ë°˜ ì¼ì •ë§Œ ì ìš©) */
        .timeline-item::before {
            content: '';
            position: absolute;
            top: 2rem;
            bottom: -1rem;
            left: 1.5rem;
            width: 2px;
            background: #e2e8f0;
            z-index: 0;
        }
        .group-last .timeline-item::before { display: none; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #6366f1; }
        .toggle-checkbox:checked + .toggle-label { background-color: #6366f1; }
        
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Weather Widget Animation */
        .weather-widget { transition: all 0.3s ease; }
        .weather-widget:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="h-screen w-screen flex overflow-hidden text-slate-800">

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar w-full md:w-[450px] h-full bg-white flex flex-col border-r border-slate-200 shrink-0 absolute md:relative transition-all duration-300 transform -translate-x-full md:translate-x-0" id="sidebar">
        <!-- í—¤ë” -->
        <div class="px-6 py-5 bg-primary text-white flex justify-between items-center shadow-sm shrink-0">
            <div>
                <h1 class="text-xl font-bold tracking-tight"><i class="fa-solid fa-plane-departure mr-2 text-indigo-400"></i>Nagoya Trip</h1>
                <p class="text-xs text-slate-400 mt-1 font-light" id="exchangeRateDisplay">í™˜ìœ¨ ì •ë³´ ë¡œë”© ì¤‘...</p>
            </div>
            <button id="closeSidebarMobile" class="md:hidden text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <!-- Day íƒ­ -->
        <div class="flex overflow-x-auto px-4 py-3 bg-white border-b border-slate-100 space-x-2 scrollbar-hide shrink-0" id="dayTabs"></div>

        <!-- ë¹ ë¥¸ ì¶”ê°€ ë²„íŠ¼ ê·¸ë£¹ -->
        <div id="quickControls" class="px-4 py-3 grid grid-cols-2 gap-3 bg-slate-50 border-b border-slate-100 hidden shrink-0">
            <button onclick="openAddScheduleModal(0,0, 'flight')" class="py-2.5 px-4 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-600 hover:border-indigo-300 hover:text-indigo-600 hover:shadow-sm transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-ticket text-indigo-500"></i> í•­ê³µê¶Œ ë“±ë¡
            </button>
            <button onclick="openAddScheduleModal(0,0, 'hotel')" class="py-2.5 px-4 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-600 hover:border-blue-300 hover:text-blue-600 hover:shadow-sm transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-bed text-blue-500"></i> ìˆ™ì†Œ ë“±ë¡
            </button>
        </div>

        <!-- ì¼ì • ë¦¬ìŠ¤íŠ¸ -->
        <div class="flex-1 overflow-y-auto p-5 space-y-4 bg-slate-50/50" id="itineraryList">
            <div class="flex flex-col items-center justify-center h-full text-slate-400">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mb-3"></div>
                <p class="text-sm">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        </div>

        <!-- ì¼ë³„ ì´ ë¹„ìš© ìš”ì•½ -->
        <div id="dailySummary" class="px-5 py-4 bg-white border-t border-slate-200 shrink-0 shadow-[0_-4px_10px_rgba(0,0,0,0.02)] hidden">
            <div class="flex justify-between items-end">
                <span class="text-sm font-bold text-slate-500">Day Total</span>
                <div class="text-right">
                    <div class="text-xl font-bold text-slate-800" id="dailyTotalJPY">Â¥0</div>
                    <div class="text-xs font-medium text-slate-400" id="dailyTotalKRW">â‰ˆ 0ì›</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì§€ë„ ì˜ì—­ -->
    <div class="flex-1 relative h-full w-full">
        <!-- ëª¨ë°”ì¼ í–„ë²„ê±° -->
        <button id="openSidebar" class="absolute top-4 left-4 z-[999] md:hidden bg-white p-3 rounded-full shadow-xl text-primary border border-slate-100">
            <i class="fa-solid fa-bars"></i>
        </button>

        <!-- ìš°ì¸¡ ìƒë‹¨ ì»¨íŠ¸ë¡¤ -->
        <div class="absolute top-4 right-4 z-[999] flex flex-col space-y-3 items-end">
            <div id="authStatus" class="hidden bg-emerald-500/90 backdrop-blur text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-lg mb-1 animate-pulse border border-emerald-400">
                <i class="fa-solid fa-user-shield mr-1"></i>Admin Mode
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="openWeatherForecastModal()" class="bg-white/90 backdrop-blur hover:bg-white text-slate-700 px-4 py-2.5 rounded-xl shadow-lg border border-slate-200 font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-calendar-days text-sky-500"></i> ì—¬í–‰ ë‚ ì”¨
                </button>
                <button onclick="openSuggestionModal()" class="bg-white/90 backdrop-blur hover:bg-white text-slate-700 px-4 py-2.5 rounded-xl shadow-lg border border-slate-200 font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-regular fa-lightbulb text-amber-500"></i> ì¶”ì²œ
                </button>
                <button id="adminSuggestionBtn" onclick="openAdminSuggestionBox()" class="hidden bg-amber-400 hover:bg-amber-500 text-white px-4 py-2.5 rounded-xl shadow-lg font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-inbox"></i>
                </button>
                <button onclick="toggleLoginModal()" id="loginBtn" class="bg-primary hover:bg-slate-800 text-white px-4 py-2.5 rounded-xl shadow-lg font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-lock"></i> ê´€ë¦¬ì
                </button>
                <button onclick="logout()" id="logoutBtn" class="hidden bg-slate-600 hover:bg-slate-700 text-white px-4 py-2.5 rounded-xl shadow-lg font-bold text-sm transition">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>

        <!-- ì‹¤ì‹œê°„ ë‚ ì”¨ ìœ„ì ¯ (ìš°ì¸¡ í•˜ë‹¨) -->
        <div id="liveWeatherWidget" class="absolute bottom-6 right-4 z-[900] weather-widget bg-white/90 backdrop-blur-md p-4 rounded-2xl shadow-xl border border-white/50 min-w-[160px] flex flex-col items-center cursor-pointer" onclick="openWeatherForecastModal()">
            <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1"><i class="fa-solid fa-location-dot mr-1"></i>ì§€ë„ ìœ„ì¹˜ ë‚ ì”¨</div>
            <div class="flex items-center gap-3">
                <div id="weatherIcon" class="text-3xl text-slate-600"><i class="fa-solid fa-spinner fa-spin text-lg"></i></div>
                <div class="text-right">
                    <div id="weatherTemp" class="text-2xl font-bold text-slate-800">--Â°</div>
                    <div id="weatherDesc" class="text-xs text-slate-500 font-medium">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>

        <div id="map" class="w-full h-full z-0 bg-slate-100"></div>
    </div>

    <!-- ë‚ ì”¨ ì˜ˆë³´ ëª¨ë‹¬ (3/2~3/7) -->
    <div id="weatherForecastModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-[600px] fade-in border border-slate-100 m-4">
            <div class="flex justify-between items-center mb-5 border-b border-slate-100 pb-3">
                <div>
                    <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-cloud-sun mr-2 text-sky-500"></i>ì—¬í–‰ ê¸°ê°„ ë‚ ì”¨ ì˜ˆë³´</h2>
                    <p class="text-xs text-slate-500 mt-1">Dayë³„ ë§ˆì§€ë§‰ ì¼ì • ì¥ì†Œ ê¸°ì¤€ (3/2 ~ 3/7)</p>
                </div>
                <button onclick="closeWeatherForecastModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div id="weatherInfoBox" class="bg-sky-50 p-3 rounded-xl mb-4 text-xs text-sky-700 font-medium flex items-center gap-2">
                <i class="fa-solid fa-circle-info"></i>
                <span id="weatherInfoText">ë¡œë”© ì¤‘...</span>
            </div>

            <div class="grid grid-cols-3 gap-3" id="weatherCardsContainer">
                <div class="col-span-3 text-center py-10 text-slate-400">
                    <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            </div>
            
            <button onclick="closeWeatherForecastModal()" class="w-full mt-5 bg-slate-800 text-white py-3 rounded-xl font-bold text-sm hover:bg-slate-700 transition">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="loginModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-80 fade-in border border-slate-100">
            <h2 class="text-xl font-bold mb-6 text-center text-primary">Admin Access</h2>
            <input type="password" id="passwordInput" placeholder="Password" class="w-full p-3.5 border border-slate-200 rounded-xl mb-4 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none transition" onkeyup="if(window.event.keyCode==13){checkPassword()}">
            <div class="flex gap-3">
                <button onclick="toggleLoginModal()" class="flex-1 py-3 bg-slate-100 rounded-xl text-slate-600 font-bold hover:bg-slate-200 transition">Cancel</button>
                <button onclick="checkPassword()" class="flex-1 py-3 bg-primary rounded-xl text-white font-bold hover:bg-slate-800 transition shadow-lg shadow-indigo-500/20">Login</button>
            </div>
        </div>
    </div>

    <!-- ì¶”ì²œ ëª¨ë‹¬ -->
    <div id="suggestionModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-96 fade-in border border-slate-100 m-4">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-lg font-bold text-slate-800"><i class="fa-regular fa-paper-plane mr-2 text-indigo-500"></i>Place Suggestion</h2>
                <button onclick="closeSuggestionModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <input type="text" id="sugPlace" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ì¥ì†Œëª… (ì˜ˆ: ì˜¤ìŠ¤ ìƒì ê°€)">
                <textarea id="sugReason" rows="3" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ì¶”ì²œ ì´ìœ ë¥¼ ì ì–´ì£¼ì„¸ìš”."></textarea>
                <button onclick="submitSuggestion()" class="w-full bg-amber-400 hover:bg-amber-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-amber-500/20 transition text-sm">ë³´ë‚´ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê±´ì˜í•¨ (ê´€ë¦¬ì) -->
    <div id="adminSuggestionBox" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-[400px] h-[500px] flex flex-col fade-in m-4">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-inbox mr-2 text-amber-500"></i>Inbox</h2>
                <button onclick="closeAdminSuggestionBox()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="suggestionList" class="flex-1 overflow-y-auto space-y-2 pr-1">
                <!-- Content -->
            </div>
        </div>
    </div>

    <!-- ì¼ì • ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addScheduleModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-[440px] max-h-[90vh] overflow-y-auto fade-in m-4 border border-slate-100 relative">
            <div class="flex justify-between items-center mb-5 border-b border-slate-100 pb-3 sticky top-0 bg-white z-10">
                <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-pen-to-square mr-2 text-indigo-500"></i>ìƒˆ ì¼ì • ì¶”ê°€</h2>
                <button onclick="closeAddScheduleModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="space-y-5">
                <!-- ì¥ì†Œ ê²€ìƒ‰ ë° ì£¼ì†Œ -->
                <div class="space-y-3">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide">ì¥ì†Œ ê²€ìƒ‰</label>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <input type="text" id="searchAddressInput" class="w-full p-3 pl-9 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ì¥ì†Œëª… ë˜ëŠ” ì£¼ì†Œ ê²€ìƒ‰" onkeyup="if(window.event.keyCode==13){searchAddress()}">
                            <i class="fa-solid fa-magnifying-glass absolute left-3.5 top-3.5 text-slate-400"></i>
                        </div>
                        <button onclick="searchAddress()" class="px-4 py-2 bg-slate-800 text-white rounded-xl text-sm font-bold hover:bg-slate-700 transition">ê²€ìƒ‰</button>
                    </div>
                    
                    <div>
                        <input type="text" id="addPlace" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold text-slate-800 focus:border-indigo-500 outline-none transition bg-white" placeholder="ì¥ì†Œëª… (í‘œì‹œìš©)">
                    </div>
                    
                    <div class="relative">
                        <input type="text" id="addAddress" class="w-full p-3 pl-9 border border-slate-200 rounded-xl text-xs bg-slate-50 text-slate-500 focus:bg-white focus:border-indigo-500 outline-none transition" placeholder="ìƒì„¸ ì£¼ì†Œ (ìë™ ì…ë ¥)">
                        <i class="fa-solid fa-map-pin absolute left-3.5 top-3.5 text-slate-400"></i>
                    </div>
                </div>

                <!-- ì‹œê°„ (ì¹´í…Œê³ ë¦¬ì— ë”°ë¼ ë³€ê²½ë¨) -->
                <div id="timeSection">
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì‹œê°„</label>
                    <input type="time" id="addTime" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white">
                </div>

                <!-- ì¹´í…Œê³ ë¦¬ -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">ì¹´í…Œê³ ë¦¬</label>
                    <div class="grid grid-cols-5 gap-2" id="categoryGrid">
                        <!-- JS Render -->
                    </div>
                </div>

                <!-- ì´ë™ ìˆ˜ë‹¨ (ì¥ì†Œ ê°„ ì´ë™) -->
                <div id="transportSection" class="hidden">
                     <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">ì´ê³³ê¹Œì§€ ì´ë™ ìˆ˜ë‹¨</label>
                     <div class="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100">
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div>
                                <input type="radio" name="moveType" id="move_walk" value="walk" class="hidden transport-radio" checked onchange="toggleTransportCost(false)">
                                <label for="move_walk" class="flex items-center justify-center py-2 rounded-lg border border-slate-200 bg-white text-xs text-slate-600 cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-person-walking mr-1"></i>ë„ë³´</label>
                            </div>
                            <div>
                                <input type="radio" name="moveType" id="move_bus" value="bus" class="hidden transport-radio" onchange="toggleTransportCost(true)">
                                <label for="move_bus" class="flex items-center justify-center py-2 rounded-lg border border-slate-200 bg-white text-xs text-slate-600 cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-bus mr-1"></i>ë²„ìŠ¤</label>
                            </div>
                            <div>
                                <input type="radio" name="moveType" id="move_subway" value="subway" class="hidden transport-radio" onchange="toggleTransportCost(true)">
                                <label for="move_subway" class="flex items-center justify-center py-2 rounded-lg border border-slate-200 bg-white text-xs text-slate-600 cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-train-subway mr-1"></i>ì§€í•˜ì² </label>
                            </div>
                        </div>
                        <div id="moveCostField" class="hidden">
                            <label class="text-[10px] font-bold text-slate-500 mb-1 block">ì´ë™ êµí†µë¹„ (JPY)</label>
                            <input type="number" id="addMoveCost" class="w-full p-2 border border-slate-200 rounded-lg text-sm text-right bg-white" placeholder="0">
                        </div>
                     </div>
                </div>

                <!-- ë™ì  í•„ë“œ ì˜ì—­ (ë¹„ìš© ë“±) -->
                <div id="dynamicFields" class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100 hidden">
                    <!-- JS Injected -->
                </div>

                <!-- ë©”ëª¨ -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ë©”ëª¨</label>
                    <textarea id="addMemo" rows="2" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:border-indigo-500 outline-none transition resize-none" placeholder="ê¸°ì–µí•  ë‚´ìš©..."></textarea>
                </div>

                <button onclick="submitNewSchedule()" class="w-full bg-primary hover:bg-slate-800 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-slate-900/10 transition text-sm flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check"></i> ì¼ì • ì €ì¥í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import * as L from 'https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAhC1MM1KI759uNFhqyu1RNjmw0Xqez5E0",
            authDomain: "mytravelmap-4f52a.firebaseapp.com",
            projectId: "mytravelmap-4f52a",
            storageBucket: "mytravelmap-4f52a.firebasestorage.app",
            messagingSenderId: "1064774813139",
            appId: "1:1064774813139:web:29b2b9e3150fbbb2ad5b26"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        let map, markersLayer, pathLayer;
        let currentDay = 1;
        let isAdmin = false;
        const totalDays = 6;
        let isFirstLoad = true;
        let tempLatLng = null;
        let EXCHANGE_RATE = 9.1;
        
        // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
        window.tripItems = [];

        const categories = [
            { id: 'flight', label: 'í•­ê³µ', icon: 'âœˆï¸', color: 'text-indigo-600' },
            { id: 'hotel', label: 'ìˆ™ì†Œ', icon: 'ğŸ¨', color: 'text-blue-600' },
            { id: 'food', label: 'ë§›ì§‘', icon: 'ğŸ´', color: 'text-orange-500' },
            { id: 'cafe', label: 'ì¹´í˜', icon: 'â˜•', color: 'text-amber-700' },
            { id: 'attraction', label: 'ëª…ì†Œ', icon: 'ğŸ¡', color: 'text-purple-600' },
            { id: 'mart', label: 'ì‡¼í•‘', icon: 'ğŸ›ï¸', color: 'text-pink-600' },
            { id: 'convenience', label: 'í¸ì˜ì ', icon: 'ğŸª', color: 'text-cyan-500' },
            { id: 'bank', label: 'ì€í–‰', icon: 'ğŸ¦', color: 'text-gray-600' },
            { id: 'etc', label: 'ê¸°íƒ€', icon: 'ğŸ“', color: 'text-gray-400' },
        ];

        window.onload = async () => {
            initMap();
            renderDayTabs();
            renderCategoryGrid();
            fetchExchangeRate();
            updateMapWeather(35.1709, 136.8815); // ì´ˆê¸° ë‚ ì”¨ (ë‚˜ê³ ì•¼)
            
            try {
                await signInAnonymously(auth);
                subscribeToItinerary();
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }

            if(localStorage.getItem('travel_admin') === 'true') {
                grantAdminAccess();
            }
            updateAdminUI();
            setupEventListeners();
        };

        // --- ë‚ ì”¨ ì˜ˆë³´ ê¸°ëŠ¥ (ì—…ë°ì´íŠ¸) ---
        window.openWeatherForecastModal = async () => {
            document.getElementById('weatherForecastModal').classList.remove('hidden');
            const container = document.getElementById('weatherCardsContainer');
            const infoText = document.getElementById('weatherInfoText');
            container.innerHTML = `<div class="col-span-3 text-center py-10 text-slate-400"><i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i><p>ê° ì¼ì •ì˜ ìœ„ì¹˜ ë‚ ì”¨ë¥¼ ì¡°íšŒì¤‘...</p></div>`;

            // ì˜¬í•´ 3ì›” 2ì¼ ~ 7ì¼ ê³„ì‚° (í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ ë‹¤ê°€ì˜¤ëŠ” 3ì›”)
            const today = new Date();
            let year = today.getFullYear();
            // ë§Œì•½ í˜„ì¬ê°€ 3ì›” ì´í›„ë¼ë©´ ë‚´ë…„ 3ì›”ë¡œ ì„¤ì • (ë³´í†µ ë‹¤ê°€ì˜¤ëŠ” ì—¬í–‰ì„ ì˜ë¯¸í•˜ë¯€ë¡œ)
            if (today.getMonth() > 2) year += 1; 

            // ê¸°ë³¸ í‰ë…„ ë°ì´í„° (Fallback)
            const fallbackData = [
                { min: 5, max: 13, code: 0 },
                { min: 6, max: 12, code: 2 },
                { min: 4, max: 14, code: 1 },
                { min: 7, max: 11, code: 61 },
                { min: 3, max: 13, code: 0 },
                { min: 4, max: 15, code: 0 }
            ];

            let html = '';
            let isRealData = false;

            for (let i = 0; i < 6; i++) {
                const targetDay = i + 1;
                const month = 3;
                const day = 2 + i;
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // í•´ë‹¹ Dayì˜ ë§ˆì§€ë§‰ ì¼ì • ì¢Œí‘œ ì°¾ê¸°
                const dayItems = window.tripItems.filter(item => item.day === targetDay)
                                                .sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
                
                let lat = 35.1815, lng = 136.9066; // ê¸°ë³¸: ë‚˜ê³ ì•¼
                let locName = "ë‚˜ê³ ì•¼";

                if (dayItems.length > 0) {
                    const lastItem = dayItems[dayItems.length - 1];
                    if (lastItem.lat && lastItem.lng) {
                        lat = lastItem.lat;
                        lng = lastItem.lng;
                        locName = lastItem.place;
                    }
                }

                // ë‚ ì”¨ API í˜¸ì¶œ ì‹œë„
                let weatherData = null;
                try {
                    // Open-MeteoëŠ” Forecastê°€ 7~16ì¼ ì •ë„ë§Œ ë‚˜ì˜´.
                    // í•´ë‹¹ ë‚ ì§œê°€ ë²”ìœ„ ë‚´ì— ìˆìœ¼ë©´ ì‹¤ì œ ë°ì´í„°, ì•„ë‹ˆë©´ catchë¡œ ì´ë™
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode,temperature_2m_max,temperature_2m_min&start_date=${dateStr}&end_date=${dateStr}&timezone=Asia%2FTokyo`;
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    if (data.daily && data.daily.time && data.daily.time.length > 0) {
                        weatherData = {
                            min: data.daily.temperature_2m_min[0],
                            max: data.daily.temperature_2m_max[0],
                            code: data.daily.weathercode[0]
                        };
                        isRealData = true;
                    }
                } catch (e) {
                    // console.log("Forecast not available yet, using fallback");
                }

                // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í‰ë…„ ë°ì´í„° ì‚¬ìš©
                const displayData = weatherData || fallbackData[i];
                const wInfo = getWeatherIcon(displayData.code);
                const isEst = !weatherData; // Estimated

                html += `
                    <div class="bg-white border ${isEst ? 'border-slate-200' : 'border-indigo-300 ring-1 ring-indigo-100'} p-3 rounded-xl text-center shadow-sm relative group">
                        <div class="text-[10px] bg-slate-100 rounded-full px-2 py-0.5 inline-block text-slate-500 mb-1 font-bold">
                            Day ${targetDay} (${month}/${day})
                        </div>
                        <div class="text-xs text-slate-400 truncate px-1 mb-1" title="${locName}"><i class="fa-solid fa-map-pin mr-1"></i>${locName}</div>
                        <div class="text-3xl my-2 flex justify-center items-center h-10">${wInfo.icon}</div>
                        <div class="font-bold text-slate-700 text-sm">${wInfo.desc}</div>
                        <div class="text-xs text-slate-500 font-medium mt-1">${displayData.min}Â° / ${displayData.max}Â°</div>
                        ${isEst ? '<div class="absolute top-2 right-2 text-[8px] text-slate-300 bg-slate-50 px-1 rounded border border-slate-100">í‰ë…„</div>' : '<div class="absolute top-2 right-2 text-[8px] text-indigo-500 bg-indigo-50 px-1 rounded border border-indigo-100 font-bold">ì‹¤ì‹œê°„</div>'}
                    </div>
                `;
            }

            container.innerHTML = html;
            infoText.innerHTML = isRealData 
                ? `ê¸°ìƒì²­ ì˜ˆë³´ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. (${year}ë…„)` 
                : `${year}ë…„ ì˜ˆë³´ ë°ì´í„°ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. í‰ë…„ ê¸°í›„ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.`;
        };

        window.closeWeatherForecastModal = () => document.getElementById('weatherForecastModal').classList.add('hidden');

        // --- ì‹¤ì‹œê°„ ì§€ë„ ë‚ ì”¨ ì—…ë°ì´íŠ¸ ---
        async function updateMapWeather(lat, lng) {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`;
                const res = await fetch(url);
                const data = await res.json();
                
                if(data && data.current_weather) {
                    const temp = data.current_weather.temperature;
                    const code = data.current_weather.weathercode;
                    const { icon, desc } = getWeatherIcon(code);
                    
                    document.getElementById('weatherTemp').innerText = `${temp}Â°C`;
                    document.getElementById('weatherIcon').innerHTML = icon;
                    document.getElementById('weatherDesc').innerText = desc;
                }
            } catch(e) {
                // Ignore silent errors
            }
        }

        function getWeatherIcon(code) {
            if (code === 0) return { icon: '<i class="fa-solid fa-sun text-orange-400"></i>', desc: 'ë§‘ìŒ' };
            if (code >= 1 && code <= 3) return { icon: '<i class="fa-solid fa-cloud-sun text-orange-300"></i>', desc: 'êµ¬ë¦„ ì¡°ê¸ˆ' };
            if (code >= 45 && code <= 48) return { icon: '<i class="fa-solid fa-smog text-slate-400"></i>', desc: 'ì•ˆê°œ' };
            if (code >= 51 && code <= 67) return { icon: '<i class="fa-solid fa-cloud-rain text-sky-400"></i>', desc: 'ë¹„' };
            if (code >= 71 && code <= 77) return { icon: '<i class="fa-regular fa-snowflake text-sky-200"></i>', desc: 'ëˆˆ' };
            if (code >= 80 && code <= 82) return { icon: '<i class="fa-solid fa-cloud-showers-heavy text-blue-500"></i>', desc: 'ì†Œë‚˜ê¸°' };
            if (code >= 95) return { icon: '<i class="fa-solid fa-bolt text-yellow-400"></i>', desc: 'ë‡Œìš°' };
            return { icon: '<i class="fa-solid fa-cloud text-slate-400"></i>', desc: 'íë¦¼' };
        }

        async function fetchExchangeRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await res.json();
                if (data && data.rates && data.rates.KRW) {
                    EXCHANGE_RATE = data.rates.KRW;
                    document.getElementById('exchangeRateDisplay').innerText = `í˜„ì¬ í™˜ìœ¨: Â¥100 = â‚©${(EXCHANGE_RATE * 100).toFixed(0)}`;
                }
            } catch (e) {
                document.getElementById('exchangeRateDisplay').innerText = `ì˜ˆìƒ í™˜ìœ¨: Â¥100 = â‚©910 (ê¸°ë³¸ê°’)`;
            }
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([35.1709, 136.8815], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            pathLayer = L.layerGroup().addTo(map);

            map.on('click', function(e) {
                if(!isAdmin) return;
                openAddScheduleModal(e.latlng.lat, e.latlng.lng);
            });
            
            map.on('moveend', function() {
                const center = map.getCenter();
                updateMapWeather(center.lat, center.lng);
            });
        }

        function renderDayTabs() {
            const container = document.getElementById('dayTabs');
            container.innerHTML = '';
            for(let i=1; i<=totalDays; i++) {
                const btn = document.createElement('button');
                const isActive = currentDay === i;
                btn.className = `px-5 py-2 text-sm font-bold rounded-full whitespace-nowrap transition-all duration-200 border ${isActive ? 'bg-primary text-white border-primary shadow-md transform scale-105' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50 hover:border-slate-300'}`;
                btn.innerText = `Day ${i}`;
                btn.onclick = () => { 
                    currentDay = i; 
                    isFirstLoad = true;
                    renderDayTabs(); 
                    subscribeToItinerary(); 
                };
                container.appendChild(btn);
            }
        }

        function renderCategoryGrid() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = categories.map(cat => `
                <div class="relative group">
                    <input type="radio" name="category" id="cat_${cat.id}" value="${cat.id}" class="peer hidden category-radio" ${cat.id === 'etc' ? 'checked' : ''} onchange="updateDynamicFields(this.value)">
                    <label for="cat_${cat.id}" class="flex flex-col items-center justify-center p-2.5 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition h-full text-center">
                        <span class="text-xl mb-1 filter drop-shadow-sm group-hover:scale-110 transition">${cat.icon}</span>
                        <span class="text-[10px] text-slate-500 whitespace-nowrap font-medium">${cat.label}</span>
                    </label>
                </div>
            `).join('');
        }

        window.searchAddress = async () => {
            const query = document.getElementById('searchAddressInput').value;
            if(!query) return alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await res.json();
                if(data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    map.setView([lat, lon], 16);
                    tempLatLng = { lat, lng: lon };
                    document.getElementById('addPlace').value = result.name || query;
                    document.getElementById('addAddress').value = result.display_name;
                    updateMapWeather(lat, lon);
                } else { alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."); }
            } catch(e) { console.error(e); alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }
        };

        window.currentCurrency = 'JPY'; 
        window.updateDynamicFields = (catId) => {
            const container = document.getElementById('dynamicFields');
            const timeSection = document.getElementById('timeSection');
            const transportSection = document.getElementById('transportSection');

            container.innerHTML = '';
            container.classList.remove('hidden');
            transportSection.classList.remove('hidden'); 

            timeSection.innerHTML = `
                <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ë°©ë¬¸ ì‹œê°„</label>
                <input type="time" id="addTime" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white">
            `;

            let html = '';
            const getCostInput = (label = 'ì˜ˆìƒ ë¹„ìš©') => `
                <div class="bg-white p-3 rounded-lg border border-indigo-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-slate-600">${label}</label>
                        <div class="flex bg-slate-100 rounded-md p-0.5">
                            <button type="button" onclick="setCurrency('JPY')" id="btn-JPY" class="px-2 py-0.5 text-[10px] font-bold rounded ${window.currentCurrency==='JPY'?'bg-white shadow text-indigo-600':'text-slate-400'}">JPY</button>
                            <button type="button" onclick="setCurrency('KRW')" id="btn-KRW" class="px-2 py-0.5 text-[10px] font-bold rounded ${window.currentCurrency==='KRW'?'bg-white shadow text-indigo-600':'text-slate-400'}">KRW</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-bold text-slate-400 w-4 text-center" id="currencySymbol">Â¥</span>
                        <input type="number" id="addCost" oninput="calcConversion(this.value)" class="flex-1 p-1 bg-transparent border-b border-slate-200 text-sm font-bold text-right focus:outline-none focus:border-indigo-500" placeholder="0">
                    </div>
                    <div class="text-right text-xs text-indigo-500 font-bold mt-1" id="convertedPreview">â‰ˆ 0ì›</div>
                </div>
            `;

            if (catId === 'flight') {
                 transportSection.classList.add('hidden');
                 timeSection.innerHTML = `
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                             <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì¶œë°œ ì‹œê°„</label>
                             <input type="time" id="addDepTime" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white">
                        </div>
                        <div>
                             <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ë„ì°© ì‹œê°„</label>
                             <input type="time" id="addArrTime" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white">
                        </div>
                    </div>
                 `;
                 html += `
                    <div class="mb-3">
                        <label class="block text-[10px] font-bold text-slate-500 mb-1">í•­ê³µí¸ëª…</label>
                        <input type="text" id="addFlightNum" class="w-full p-2 border border-slate-200 rounded-lg text-sm bg-white" placeholder="KE123">
                    </div>
                    ${getCostInput('í•­ê³µê¶Œ ë¹„ìš©')}
                `;
            } else if (catId === 'hotel') {
                transportSection.classList.remove('hidden');
                timeSection.innerHTML = `
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                             <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì²´í¬ì¸</label>
                             <input type="time" id="addCheckIn" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white">
                        </div>
                        <div>
                             <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ì²´í¬ì•„ì›ƒ</label>
                             <input type="time" id="addCheckOut" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white">
                        </div>
                    </div>
                 `;
                html += `
                    <div class="flex items-center justify-between mb-3 bg-white p-3 rounded-lg border border-indigo-100 shadow-sm">
                        <span class="text-xs font-bold text-slate-600">ì˜ˆì•½ ìƒíƒœ</span>
                        <div class="relative inline-block w-10 h-5 align-middle select-none">
                            <input type="checkbox" name="toggle" id="addReserved" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300"/>
                            <label for="addReserved" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer transition-all duration-300"></label>
                        </div>
                    </div>
                    ${getCostInput('ìˆ™ë°•ë¹„ (1ë°•)')}
                `;
            } else if (catId === 'food' || catId === 'cafe') {
                html += `
                    <div class="mb-2">
                        <label class="block text-xs font-bold text-slate-600 mb-1">ì¶”ì²œ ë©”ë‰´</label>
                        <input type="text" id="addMenu" class="w-full p-2 border border-slate-200 rounded text-sm bg-white" placeholder="ì˜ˆ: íˆì¸ ë§ˆë¶€ì‹œ">
                    </div>
                    ${getCostInput('ì˜ˆìƒ ì‹ë¹„')}
                `;
            } else if (catId === 'attraction') {
                html += getCostInput('ì…ì¥ë£Œ');
            } else if (['mart', 'convenience', 'etc', 'bank'].includes(catId)) {
                html += getCostInput('ì˜ˆìƒ ë¹„ìš©');
            } else {
                container.classList.add('hidden');
            }
            container.innerHTML = html;
        };

        window.toggleTransportCost = (show) => {
            const field = document.getElementById('moveCostField');
            if(show) {
                field.classList.remove('hidden');
                document.getElementById('addMoveCost').focus();
            } else {
                field.classList.add('hidden');
                document.getElementById('addMoveCost').value = '';
            }
        };

        window.setCurrency = (curr) => {
            window.currentCurrency = curr;
            document.getElementById('btn-JPY').className = `px-2 py-0.5 text-[10px] font-bold rounded ${curr==='JPY'?'bg-white shadow text-indigo-600':'text-slate-400'}`;
            document.getElementById('btn-KRW').className = `px-2 py-0.5 text-[10px] font-bold rounded ${curr==='KRW'?'bg-white shadow text-indigo-600':'text-slate-400'}`;
            document.getElementById('currencySymbol').innerText = curr === 'JPY' ? 'Â¥' : 'â‚©';
            const val = document.getElementById('addCost').value;
            if(val) calcConversion(val);
        };

        window.calcConversion = (val) => {
            if(!val) {
                document.getElementById('convertedPreview').innerText = '';
                return;
            }
            if (window.currentCurrency === 'JPY') {
                const krw = Math.round(val * EXCHANGE_RATE);
                document.getElementById('convertedPreview').innerText = `â‰ˆ ${krw.toLocaleString()}ì›`;
            } else {
                const jpy = Math.round(val / EXCHANGE_RATE);
                document.getElementById('convertedPreview').innerText = `â‰ˆ ${jpy.toLocaleString()}ì—”`;
            }
        };

        window.openAddScheduleModal = async (lat, lng, preSelectCat = null) => {
            const modal = document.getElementById('addScheduleModal');
            document.getElementById('searchAddressInput').value = '';
            document.getElementById('addPlace').value = preSelectCat === 'flight' ? 'ë‚˜ê³ ì•¼ ì¤‘ë¶€êµ­ì œê³µí•­' : '';
            document.getElementById('addMemo').value = '';
            document.getElementById('addAddress').value = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';
            document.getElementById('move_walk').checked = true; 
            window.toggleTransportCost(false);
            
            let targetCat = preSelectCat || 'etc';
            document.getElementById(`cat_${targetCat}`).checked = true;
            
            window.currentCurrency = 'JPY'; 
            window.updateDynamicFields(targetCat);
            
            if (preSelectCat && preSelectCat !== 'etc') {
                tempLatLng = null; 
                document.getElementById('addAddress').value = '-';
            } else {
                tempLatLng = { lat, lng };
                fetchAddress(lat, lng);
            }

            modal.classList.remove('hidden');
            setTimeout(() => document.getElementById('searchAddressInput').focus(), 100);
        };

        window.closeAddScheduleModal = () => document.getElementById('addScheduleModal').classList.add('hidden');

        async function fetchAddress(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                if(data && data.display_name) {
                    const parts = data.display_name.split(',');
                    document.getElementById('addAddress').value = parts.slice(0, 3).join(', ');
                } else {
                    document.getElementById('addAddress').value = "";
                }
            } catch(e) {
                document.getElementById('addAddress').value = "";
            }
        }

        window.submitNewSchedule = async () => {
            if(!isAdmin) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
            
            const place = document.getElementById('addPlace').value;
            const memo = document.getElementById('addMemo').value;
            const address = document.getElementById('addAddress').value;
            const selectedCatId = document.querySelector('input[name="category"]:checked').value;
            const categoryObj = categories.find(c => c.id === selectedCatId);

            let time = '', depTime = '', arrTime = '', checkIn = '', checkOut = '';
            if(selectedCatId === 'flight') {
                depTime = document.getElementById('addDepTime')?.value || '';
                arrTime = document.getElementById('addArrTime')?.value || '';
                time = depTime; 
            } else if(selectedCatId === 'hotel') {
                checkIn = document.getElementById('addCheckIn')?.value || '';
                checkOut = document.getElementById('addCheckOut')?.value || '';
                time = checkIn; 
            } else {
                time = document.getElementById('addTime')?.value || '';
            }

            let moveType = 'walk';
            let moveCost = 0;
            if(selectedCatId !== 'flight') {
                moveType = document.querySelector('input[name="moveType"]:checked').value;
                if(moveType !== 'walk') {
                    moveCost = parseInt(document.getElementById('addMoveCost').value) || 0;
                }
            }

            const costInput = document.getElementById('addCost');
            let costJPY = 0;
            if (costInput && costInput.value) {
                costJPY = window.currentCurrency === 'JPY' ? parseInt(costInput.value) : Math.round(parseInt(costInput.value) / EXCHANGE_RATE);
            }

            const menu = document.getElementById('addMenu')?.value || '';
            const isReserved = document.getElementById('addReserved')?.checked || false;
            const flightNum = document.getElementById('addFlightNum')?.value || '';

            if(!place) return alert("ì¥ì†Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");

            try {
                const docData = {
                    day: currentDay,
                    place, time, memo, address,
                    category: selectedCatId,
                    categoryIcon: categoryObj.icon,
                    cost: costJPY, 
                    moveType, moveCost, 
                    depTime, arrTime, 
                    checkIn, checkOut, 
                    menu, isReserved, flightNum,
                    createdAt: new Date().toISOString()
                };

                if(tempLatLng && selectedCatId !== 'flight') {
                    docData.lat = tempLatLng.lat;
                    docData.lng = tempLatLng.lng;
                }

                await addDoc(collection(db, 'trips', appId, 'itineraries'), docData);
                window.closeAddScheduleModal();
            } catch (e) { 
                console.error(e); 
                alert("ì €ì¥ ì‹¤íŒ¨"); 
            }
        };

        function subscribeToItinerary() {
            if (window.unsub) window.unsub();
            const colRef = collection(db, 'trips', appId, 'itineraries');
            
            window.unsub = onSnapshot(colRef, (snapshot) => {
                const listContainer = document.getElementById('itineraryList');
                listContainer.innerHTML = '';
                markersLayer.clearLayers();
                pathLayer.clearLayers(); 
                
                const items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));

                // ì „ì—­ ë°ì´í„° ì—…ë°ì´íŠ¸ (ë‚ ì”¨ íŒì—…ìš©)
                window.tripItems = items;

                // 1. í˜„ì¬ ë‚ ì§œ ì•„ì´í…œ í•„í„°ë§
                const dayItems = items.filter(item => item.day === currentDay);

                // 2. ì¹´í…Œê³ ë¦¬ë³„ ë¶„ë¦¬ (ê³ ì • ì•„ì´í…œ vs íƒ€ì„ë¼ì¸ ì•„ì´í…œ)
                const fixedItems = dayItems.filter(item => item.category === 'flight' || item.category === 'hotel')
                                           .sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
                
                const timelineItems = dayItems.filter(item => item.category !== 'flight' && item.category !== 'hotel')
                                              .sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));

                let totalDailyCost = 0;
                let pathPoints = []; 

                if (dayItems.length === 0) {
                    listContainer.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-64 text-slate-300">
                            <i class="fa-regular fa-map text-4xl mb-3"></i>
                            <p class="text-sm">ì¼ì •ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
                        </div>`;
                    document.getElementById('dailySummary').classList.add('hidden');
                } else {
                    document.getElementById('dailySummary').classList.remove('hidden');
                    
                    if (isFirstLoad) {
                        const firstTarget = timelineItems[0] || fixedItems[0];
                        if (firstTarget && firstTarget.lat && firstTarget.lng) {
                            map.flyTo([firstTarget.lat, firstTarget.lng], 14, { duration: 1.5 });
                            isFirstLoad = false;
                        }
                    }
                }

                const renderItem = (item, isFixed) => {
                    const catObj = categories.find(c => c.id === item.category) || categories.find(c => c.id === 'etc');
                    const isFlight = item.category === 'flight';
                    const isHotel = item.category === 'hotel';

                    totalDailyCost += (item.cost || 0) + (item.moveCost || 0);

                    if (!isFixed && item.lat && item.lng) {
                        pathPoints.push({
                            lat: item.lat, 
                            lng: item.lng, 
                            moveType: item.moveType || 'walk',
                            color: item.moveType === 'walk' ? '#94a3b8' : (item.moveType === 'bus' ? '#6366f1' : '#10b981')
                        });
                    }

                    if (item.lat) {
                        const markerColor = isFlight ? '#6366f1' : (isHotel ? '#2563eb' : '#ffffff');
                        const markerIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: ${markerColor}; border: 2px solid white; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.2); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 20px;">${item.categoryIcon || catObj.icon}</div>`,
                            iconSize: [40, 40],
                            iconAnchor: [20, 20],
                            popupAnchor: [0, -20]
                        });
                        const marker = L.marker([item.lat, item.lng], {icon: markerIcon}).addTo(markersLayer);
                        
                        let timeDisplay = item.time || '';
                        if (isFlight) timeDisplay = `${item.depTime || '?'} <i class="fa-solid fa-arrow-right text-[10px] mx-1"></i> ${item.arrTime || '?'}`;
                        else if (isHotel) timeDisplay = `In ${item.checkIn || '-'} / Out ${item.checkOut || '-'}`;

                        marker.bindPopup(`
                            <div class="text-center min-w-[160px] p-1 font-sans">
                                <div class="text-2xl mb-2">${item.categoryIcon || catObj.icon}</div>
                                <h3 class="font-bold mb-1 text-slate-800 text-sm">${item.place}</h3>
                                <p class="text-xs text-indigo-600 font-bold mb-1">${timeDisplay}</p>
                            </div>
                        `, { className: 'rounded-xl shadow-xl border-0' });
                    }

                    let costDisplay = '';
                    const totalItemCost = (item.cost || 0);
                    if (totalItemCost > 0) {
                        const krw = Math.round(totalItemCost * EXCHANGE_RATE).toLocaleString();
                        costDisplay = `<span class="text-indigo-600 font-bold text-sm bg-indigo-50 px-2 py-0.5 rounded">Â¥${totalItemCost.toLocaleString()} <span class="text-[10px] text-slate-400 font-normal">(ì•½ ${krw}ì›)</span></span>`;
                    }
                    if(item.moveCost > 0) {
                        const mKrw = Math.round(item.moveCost * EXCHANGE_RATE).toLocaleString();
                        costDisplay += `<div class="text-[10px] text-slate-400 mt-0.5 ml-1"><i class="fa-solid fa-ticket mr-1"></i>ì´ë™: Â¥${item.moveCost} (${mKrw}ì›)</div>`;
                    }

                    let timeDisplay = item.time || '';
                    if (isFlight) timeDisplay = `${item.depTime || '?'} <i class="fa-solid fa-arrow-right text-[10px] mx-1"></i> ${item.arrTime || '?'}`;
                    else if (isHotel) timeDisplay = `In ${item.checkIn || '-'} / Out ${item.checkOut || '-'}`;

                    let tags = '';
                    if (item.menu) tags += `<span class="bg-orange-50 text-orange-600 px-1.5 py-0.5 rounded text-[10px] border border-orange-100 font-medium">ğŸ½ï¸ ${item.menu}</span> `;
                    if (isHotel) {
                        tags += item.isReserved 
                            ? `<span class="bg-emerald-50 text-emerald-600 px-1.5 py-0.5 rounded text-[10px] border border-emerald-100 font-bold">âœ… ì˜ˆì•½í™•ì •</span> ` 
                            : `<span class="bg-rose-50 text-rose-600 px-1.5 py-0.5 rounded text-[10px] border border-rose-100 font-bold">â³ ë¯¸ì˜ˆì•½</span> `;
                    }
                    if (item.flightNum) tags += `<span class="bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded text-[10px] border border-indigo-100 font-bold">âœˆï¸ ${item.flightNum}</span> `;

                    let moveIcon = '';
                    if(!isFixed && !isFlight) { 
                        if(item.moveType === 'bus') moveIcon = '<i class="fa-solid fa-bus text-indigo-500 mr-1"></i>';
                        else if(item.moveType === 'subway') moveIcon = '<i class="fa-solid fa-train-subway text-emerald-500 mr-1"></i>';
                        else moveIcon = '<i class="fa-solid fa-person-walking text-slate-400 mr-1"></i>';
                    }

                    let cardClasses = 'bg-white p-4 rounded-xl border shadow-sm transition group relative mb-3';
                    if (isFixed) {
                         if (isFlight) cardClasses = 'bg-indigo-50/60 p-5 rounded-2xl border border-indigo-200 shadow-sm transition group relative mb-3';
                         else if (isHotel) cardClasses = 'bg-blue-50/60 p-5 rounded-2xl border border-blue-200 shadow-sm transition group relative mb-3';
                    } else {
                        cardClasses += ' timeline-item pl-12 hover:shadow-md border-slate-100';
                    }

                    const el = document.createElement('div');
                    el.className = cardClasses;
                    el.onclick = () => { if(item.lat) map.flyTo([item.lat, item.lng], 16); };
                    
                    let iconStyle = `text-xl z-10 w-9 h-9 flex items-center justify-center bg-white rounded-full border border-slate-100 shadow-sm absolute left-3 top-4`;
                    if(isFixed) iconStyle = `text-2xl z-10 w-10 h-10 flex items-center justify-center bg-white rounded-full border border-white shadow-md mb-2`;

                    el.innerHTML = `
                        ${!isFixed ? `<div class="${iconStyle}">${item.categoryIcon || catObj.icon}</div>` : ''}
                        
                        <div class="${isFixed ? 'flex flex-col' : ''}">
                            <div class="flex justify-between items-start mb-1">
                                <div class="flex items-center gap-2">
                                    ${isFixed ? `<div class="text-xl">${item.categoryIcon}</div>` : ''}
                                    <h4 class="font-bold text-slate-800 text-base ${isFlight ? 'text-indigo-800' : ''} ${isHotel ? 'text-blue-800' : ''}">${item.place}</h4>
                                </div>
                                <span class="text-xs font-bold bg-white/80 border border-slate-100 text-slate-600 px-2 py-1 rounded-lg shadow-sm whitespace-nowrap">${timeDisplay || '-'}</span>
                            </div>
                            
                            ${item.address && !isFlight ? `<p class="text-xs text-slate-400 mb-2 truncate"><i class="fa-solid fa-map-pin mr-1"></i>${item.address}</p>` : ''}
                            
                            ${moveIcon ? `<div class="text-[10px] text-slate-500 mb-1 flex items-center bg-slate-50 inline-block px-1.5 rounded border border-slate-100 w-fit">${moveIcon} ì´ë™</div>` : ''}

                            <div class="flex flex-wrap gap-1 mb-1">${tags}</div>
                            
                            ${costDisplay ? `<div class="flex flex-col mt-1">${costDisplay}</div>` : ''}
                            ${item.memo ? `<p class="text-sm text-slate-600 mt-2 bg-slate-50/50 p-2 rounded-lg border border-slate-100/50">${item.memo}</p>` : ''}
                        </div>

                        ${isAdmin ? `
                        <button onclick="event.stopPropagation(); window.deleteItem('${item.id}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition text-slate-300 hover:text-rose-500 p-2">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>` : ''}
                    `;
                    listContainer.appendChild(el);
                };

                fixedItems.forEach(item => renderItem(item, true));
                timelineItems.forEach(item => renderItem(item, false));

                document.getElementById('dailyTotalJPY').innerText = `Â¥${totalDailyCost.toLocaleString()}`;
                const totalKRW = Math.round(totalDailyCost * EXCHANGE_RATE).toLocaleString();
                document.getElementById('dailyTotalKRW').innerText = `â‰ˆ ${totalKRW}ì›`;

                if (pathPoints.length > 1) {
                    for (let i = 0; i < pathPoints.length - 1; i++) {
                        const start = pathPoints[i];
                        const end = pathPoints[i+1];
                        
                        const moveType = end.moveType; 
                        let dashArray = null;
                        let color = '#94a3b8'; // ë„ë³´
                        
                        if(moveType === 'walk') {
                            dashArray = '5, 10'; 
                        } else if(moveType === 'bus') {
                            color = '#6366f1'; 
                        } else if(moveType === 'subway') {
                            color = '#10b981'; 
                        }

                        L.polyline([[start.lat, start.lng], [end.lat, end.lng]], {
                            color: color,
                            weight: 3,
                            opacity: 0.7,
                            dashArray: dashArray,
                            lineCap: 'round'
                        }).addTo(pathLayer);
                    }
                }
            });
        }

        window.deleteItem = async (id) => {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await deleteDoc(doc(db, 'trips', appId, 'itineraries', id));
        };
        window.toggleLoginModal = () => document.getElementById('loginModal').classList.toggle('hidden');
        window.checkPassword = () => {
            if(document.getElementById('passwordInput').value === 'rlarlqja01!') {
                grantAdminAccess();
                localStorage.setItem('travel_admin', 'true');
                window.toggleLoginModal();
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                document.getElementById('passwordInput').value = '';
            }
        };
        window.logout = () => {
            if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                isAdmin = false; 
                localStorage.removeItem('travel_admin');
                updateAdminUI(); 
                subscribeToItinerary();
                window.closeAdminSuggestionBox();
            }
        };
        function grantAdminAccess() { isAdmin = true; updateAdminUI(); subscribeToItinerary(); }
        function updateAdminUI() {
            const isHidden = !isAdmin;
            document.getElementById('authStatus').classList.toggle('hidden', isHidden);
            document.getElementById('loginBtn').classList.toggle('hidden', !isHidden);
            document.getElementById('logoutBtn').classList.toggle('hidden', isHidden);
            document.getElementById('quickControls').classList.toggle('hidden', isHidden); 
            document.getElementById('adminSuggestionBtn').classList.toggle('hidden', isHidden);
        }
        
        window.openSuggestionModal = () => document.getElementById('suggestionModal').classList.remove('hidden');
        window.closeSuggestionModal = () => document.getElementById('suggestionModal').classList.add('hidden');
        window.submitSuggestion = async () => {
            try {
                await addDoc(collection(db, 'trips', appId, 'suggestions'), {
                    place: document.getElementById('sugPlace').value, 
                    reason: document.getElementById('sugReason').value, 
                    createdAt: new Date().toISOString()
                });
                alert("ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤!"); 
                window.closeSuggestionModal();
            } catch(e) { alert("ì „ì†¡ ì‹¤íŒ¨"); }
        };

        let suggestionUnsub = null;
        window.openAdminSuggestionBox = () => {
            document.getElementById('adminSuggestionBox').classList.remove('hidden');
            if(suggestionUnsub) suggestionUnsub();
            const colRef = collection(db, 'trips', appId, 'suggestions');
            suggestionUnsub = onSnapshot(colRef, (snapshot) => {
                const list = document.getElementById('suggestionList');
                list.innerHTML = '';
                if(snapshot.empty) {
                    list.innerHTML = '<div class="text-center text-slate-400 mt-10">ê±´ì˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const el = document.createElement('div');
                    el.className = 'bg-amber-50 p-3 rounded-xl border border-amber-100 flex justify-between items-start mb-2';
                    el.innerHTML = `
                        <div>
                            <div class="font-bold text-slate-700 text-sm"><i class="fa-solid fa-location-dot text-amber-500 mr-1"></i>${data.place}</div>
                            <div class="text-xs text-slate-600 mt-1">${data.reason}</div>
                            <div class="text-[10px] text-slate-400 mt-1">${new Date(data.createdAt).toLocaleDateString()}</div>
                        </div>
                        <button onclick="markAsRead('${docSnap.id}')" class="text-slate-400 hover:text-emerald-500 ml-2">
                            <i class="fa-regular fa-circle-check text-lg"></i>
                        </button>
                    `;
                    list.appendChild(el);
                });
            });
        };
        window.closeAdminSuggestionBox = () => document.getElementById('adminSuggestionBox').classList.add('hidden');
        window.markAsRead = async (id) => { if(confirm("í™•ì¸ ì™„ë£Œ ì²˜ë¦¬(ì‚­ì œ) í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await deleteDoc(doc(db, 'trips', appId, 'suggestions', id)); };

        document.getElementById('openSidebar').onclick = () => document.getElementById('sidebar').classList.remove('-translate-x-full');
        document.getElementById('closeSidebarMobile').onclick = () => document.getElementById('sidebar').classList.add('-translate-x-full');
        
        function setupEventListeners() {
            document.addEventListener('keydown', (e) => { 
                if(e.key === "Escape") { 
                    document.getElementById('loginModal').classList.add('hidden');
                    window.closeSuggestionModal();
                    window.closeAddScheduleModal();
                    window.closeAdminSuggestionBox();
                    window.closeWeatherForecastModal();
                }
            });
        }
    </script>
</body>
</html>
